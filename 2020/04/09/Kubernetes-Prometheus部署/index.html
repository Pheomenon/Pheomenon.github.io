<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes-Prometheus部署 | XonLab</title><meta name="description" content="前情回顾 配置是独立于程序的可配变量，同一份程序在不同配置下会有不同的行为。 云原生（Cloud Native）程序的特点 程序的配置，通过设置环境变量传递到容器内部 程序的配置，通过程序启动参数配置生效 程序的配置，通过集中在配置中心进行统一管理（CRUD）   Devops工程师应该做什么？ 容器化公司自研的应用程序（通过Docker进行二次封装） 推动容器化应用，转变为云原生应用（一次构建，"><meta name="keywords" content="Docker,Kubernetes,Prometheus"><meta name="author" content="PhenoGao"><meta name="copyright" content="PhenoGao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://xonlab.com/2020/04/09/Kubernetes-Prometheus%E9%83%A8%E7%BD%B2/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes-Prometheus部署"><meta property="og:url" content="http://xonlab.com/2020/04/09/Kubernetes-Prometheus%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="XonLab"><meta property="og:description" content="前情回顾 配置是独立于程序的可配变量，同一份程序在不同配置下会有不同的行为。 云原生（Cloud Native）程序的特点 程序的配置，通过设置环境变量传递到容器内部 程序的配置，通过程序启动参数配置生效 程序的配置，通过集中在配置中心进行统一管理（CRUD）   Devops工程师应该做什么？ 容器化公司自研的应用程序（通过Docker进行二次封装） 推动容器化应用，转变为云原生应用（一次构建，"><meta property="og:image" content="https://edu-102.oss-cn-beijing.aliyuncs.com/de2a1ad249f7248d123b0a46d5faad9f.jpg"><meta property="article:published_time" content="2020-04-09T03:39:28.000Z"><meta property="article:modified_time" content="2021-02-15T04:19:24.723Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="Kubernetes-ELK部署" href="http://xonlab.com/2020/04/15/Kubernetes-ELK%E9%83%A8%E7%BD%B2/"><link rel="next" title="Mock.js" href="http://xonlab.com/2020/04/08/Mock-js/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://edu-102.oss-cn-beijing.aliyuncs.com/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">105</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">68</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前情回顾"><span class="toc-number">1.</span> <span class="toc-text">前情回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#新一代容器云监控Prometheus的概述"><span class="toc-number">2.</span> <span class="toc-text">新一代容器云监控Prometheus的概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战部署容器云监控必备exporter"><span class="toc-number">3.</span> <span class="toc-text">实战部署容器云监控必备exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署kube-state-metrics"><span class="toc-number">3.1.</span> <span class="toc-text">部署kube-state-metrics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备kube-state-metrics镜像"><span class="toc-number">3.1.1.</span> <span class="toc-text">准备kube-state-metrics镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单"><span class="toc-number">3.1.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单"><span class="toc-number">3.1.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查启动情况"><span class="toc-number">3.1.4.</span> <span class="toc-text">检查启动情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署node-exporter"><span class="toc-number">3.2.</span> <span class="toc-text">部署node-exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备node-exporter镜像"><span class="toc-number">3.2.1.</span> <span class="toc-text">准备node-exporter镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查启动情况-1"><span class="toc-number">3.2.4.</span> <span class="toc-text">检查启动情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署cadvisor"><span class="toc-number">3.3.</span> <span class="toc-text">部署cadvisor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备cadvisor镜像"><span class="toc-number">3.3.1.</span> <span class="toc-text">准备cadvisor镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-2"><span class="toc-number">3.3.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改运算节点软连接"><span class="toc-number">3.3.3.</span> <span class="toc-text">修改运算节点软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-2"><span class="toc-number">3.3.4.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查启动情况-2"><span class="toc-number">3.3.5.</span> <span class="toc-text">检查启动情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署blackbox-exporter"><span class="toc-number">3.4.</span> <span class="toc-text">部署blackbox-exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备blackbox-exporter镜像"><span class="toc-number">3.4.1.</span> <span class="toc-text">准备blackbox-exporter镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-3"><span class="toc-number">3.4.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-3"><span class="toc-number">3.4.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析域名"><span class="toc-number">3.4.4.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#浏览器访问"><span class="toc-number">3.4.5.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战部署Prometheus及其配置详解"><span class="toc-number">4.</span> <span class="toc-text">实战部署Prometheus及其配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署prometheus"><span class="toc-number">4.1.</span> <span class="toc-text">部署prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备prometheus镜像"><span class="toc-number">4.1.1.</span> <span class="toc-text">准备prometheus镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-4"><span class="toc-number">4.1.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备promentheus的配置文件"><span class="toc-number">4.1.3.</span> <span class="toc-text">准备promentheus的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-4"><span class="toc-number">4.1.4.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析域名-1"><span class="toc-number">4.1.5.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#浏览器访问-1"><span class="toc-number">4.1.6.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus监控内容"><span class="toc-number">4.1.7.</span> <span class="toc-text">Prometheus监控内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#etcd"><span class="toc-number">4.1.7.1.</span> <span class="toc-text">etcd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-apiserver"><span class="toc-number">4.1.7.2.</span> <span class="toc-text">kubernetes-apiserver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-kubelet"><span class="toc-number">4.1.7.3.</span> <span class="toc-text">kubernetes-kubelet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-kube-state"><span class="toc-number">4.1.7.4.</span> <span class="toc-text">kubernetes-kube-state</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#traefik"><span class="toc-number">4.1.7.5.</span> <span class="toc-text">traefik</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#blackbox"><span class="toc-number">4.1.7.6.</span> <span class="toc-text">blackbox*</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kubernetes-pods"><span class="toc-number">4.1.7.7.</span> <span class="toc-text">kubernetes-pods*</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改traefik服务接入prometheus监控"><span class="toc-number">4.1.8.</span> <span class="toc-text">修改traefik服务接入prometheus监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改dubbo-service服务接入prometheus监控"><span class="toc-number">4.1.9.</span> <span class="toc-text">修改dubbo-service服务接入prometheus监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改dubbo-consumer服务接入prometheus监控"><span class="toc-number">4.1.10.</span> <span class="toc-text">修改dubbo-consumer服务接入prometheus监控</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战部署容器云监控展示平台Grafana"><span class="toc-number">5.</span> <span class="toc-text">实战部署容器云监控展示平台Grafana</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备grafana镜像"><span class="toc-number">5.1.</span> <span class="toc-text">准备grafana镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备资源配置清单-5"><span class="toc-number">5.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用资源配置清单-5"><span class="toc-number">5.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析域名-2"><span class="toc-number">5.4.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问-2"><span class="toc-number">5.5.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置grafana页面"><span class="toc-number">5.6.</span> <span class="toc-text">配置grafana页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#外观"><span class="toc-number">5.6.1.</span> <span class="toc-text">外观</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件"><span class="toc-number">5.6.2.</span> <span class="toc-text">插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置grafana数据源"><span class="toc-number">5.7.</span> <span class="toc-text">配置grafana数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置Kubernetes集群Dashboard"><span class="toc-number">5.8.</span> <span class="toc-text">配置Kubernetes集群Dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战通过Alertmanager组件进行监控告警"><span class="toc-number">6.</span> <span class="toc-text">实战通过Alertmanager组件进行监控告警</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备Alertmanager镜像"><span class="toc-number">6.1.</span> <span class="toc-text">准备Alertmanager镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备资源配置清单-6"><span class="toc-number">6.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用资源配置清单-6"><span class="toc-number">6.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#报警规则"><span class="toc-number">6.4.</span> <span class="toc-text">报警规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prometheus加载报警规则"><span class="toc-number">6.5.</span> <span class="toc-text">prometheus加载报警规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证报警"><span class="toc-number">6.6.</span> <span class="toc-text">验证报警</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#钉钉报警"><span class="toc-number">6.7.</span> <span class="toc-text">钉钉报警</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://edu-102.oss-cn-beijing.aliyuncs.com/de2a1ad249f7248d123b0a46d5faad9f.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">XonLab</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Kubernetes-Prometheus部署</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2020-04-09 11:39:28"><i class="fa-fw far fa-calendar-alt"></i> 发表于 2020-04-09</time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">5.6k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 31 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="前情回顾"><a href="#前情回顾" class="headerlink" title="前情回顾"></a>前情回顾</h1><ul>
<li>配置是独立于程序的可配变量，同一份程序在不同配置下会有不同的行为。</li>
<li>云原生（Cloud Native）程序的特点<ul>
<li>程序的配置，通过设置环境变量传递到容器内部</li>
<li>程序的配置，通过程序启动参数配置生效</li>
<li>程序的配置，通过集中在配置中心进行统一管理（CRUD）</li>
</ul>
</li>
<li>Devops工程师应该做什么？<ul>
<li>容器化公司自研的应用程序（通过Docker进行二次封装）</li>
<li>推动容器化应用，转变为云原生应用（一次构建，到处使用）</li>
<li>使用容器编排框架（kubernetes），合理，规范，专业的编排业务容器</li>
</ul>
</li>
</ul>
<h1 id="新一代容器云监控Prometheus的概述"><a href="#新一代容器云监控Prometheus的概述" class="headerlink" title="新一代容器云监控Prometheus的概述"></a>新一代容器云监控Prometheus的概述</h1><img src = "/images/m_c6b4592b425d2fa037682c1fe20ad331_r.png">

<ul>
<li><a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io</a></li>
<li><a href="https://github.com/prometheus" target="_blank" rel="noopener">https://github.com/prometheus</a></li>
</ul>
<img src = "/images/m_bcc460bfd391cf4f36ab75dd6ef69e08_r.png">

<ul>
<li>prometheus架构图</li>
</ul>
<img src = "/images/m_89a8dd407c6b24f651f32be1fab450b7_r.png">

<ul>
<li>新一代容器云监控系统Prometheus和传统监控Zabbix对比</li>
</ul>
<img src = "/images/m_d17fd8df92fd48e5097aaca4c971c5c9_r.png">

<h1 id="实战部署容器云监控必备exporter"><a href="#实战部署容器云监控必备exporter" class="headerlink" title="实战部署容器云监控必备exporter"></a>实战部署容器云监控必备exporter</h1><h2 id="部署kube-state-metrics"><a href="#部署kube-state-metrics" class="headerlink" title="部署kube-state-metrics"></a>部署kube-state-metrics</h2><p>运维主机shkf-245.host.com</p>
<h3 id="准备kube-state-metrics镜像"><a href="#准备kube-state-metrics镜像" class="headerlink" title="准备kube-state-metrics镜像"></a>准备kube-state-metrics镜像</h3><p><a href="https://quay.io/repository/coreos/kube-state-metrics?tab=tags" target="_blank" rel="noopener">kube-state-metrics官方quay.io地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull quay.io/coreos/kube-state-metrics:v1.5.0</span><br><span class="line">[root@shkf6-245 ~]# docker images |grep kube-state-metrics</span><br><span class="line">quay.io/coreos/kube-state-metrics                 v1.5.0                     91599517197a        11 months ago       31.8MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 91599517197a harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/public/kube-state-metrics:v1.5.0</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li>rbac</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/k8s-yaml/kube-state-metrics</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/kube-state-metrics/rbac.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/kube-state-metrics/rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - policy</span><br><span class="line">  resources:</span><br><span class="line">  - poddisruptionbudgets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - batch</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - jobs</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - autoscaling</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/kube-state-metrics/dp.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/kube-state-metrics/dp.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: "2"</span><br><span class="line">  labels:</span><br><span class="line">    grafanak8sapp: "true"</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      grafanak8sapp: "true"</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        grafanak8sapp: "true"</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/rbac.yaml</span><br><span class="line">serviceaccount/kube-state-metrics created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/dp.yaml</span><br><span class="line">deployment.extensions/kube-state-metrics created</span><br></pre></td></tr></table></figure>

<h3 id="检查启动情况"><a href="#检查启动情况" class="headerlink" title="检查启动情况"></a>检查启动情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get pods -n kube-system|grep kube-state-metrics</span><br><span class="line">kube-state-metrics-8669f776c6-n849f     1/1     Running   0          5m13s</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# curl 172.6.244.9:8080/healthz</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h2 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node-exporter"></a>部署node-exporter</h2><p>运维主机shkf6-245.host.com上：</p>
<h3 id="准备node-exporter镜像"><a href="#准备node-exporter镜像" class="headerlink" title="准备node-exporter镜像"></a>准备node-exporter镜像</h3><p><a href="https://hub.docker.com/r/prom/node-exporter" target="_blank" rel="noopener">node-exporter官方dockerhub地址</a><br><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">node-expoerer官方github地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull prom/node-exporter:v0.15.0</span><br><span class="line">[root@shkf6-245 ~]# docker images|grep node-exporter</span><br><span class="line">prom/node-exporter                                v0.15.0                    12d51ffa2b22        2 years ago         22.8MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 12d51ffa2b22 harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/public/node-exporter:v0.15.0</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/k8s-yaml/node-exporter</span><br><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/node-exporter/ds.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/node-exporter/ds.yaml</span><br><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    daemon: "node-exporter"</span><br><span class="line">    grafanak8sapp: "true"</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      daemon: "node-exporter"</span><br><span class="line">      grafanak8sapp: "true"</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        daemon: "node-exporter"</span><br><span class="line">        grafanak8sapp: "true"</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: proc</span><br><span class="line">        hostPath: </span><br><span class="line">          path: /proc</span><br><span class="line">          type: ""</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">          type: ""</span><br><span class="line">      containers:</span><br><span class="line">      - name: node-exporter</span><br><span class="line">        image: harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --path.procfs=/host_proc</span><br><span class="line">        - --path.sysfs=/host_sys</span><br><span class="line">        ports:</span><br><span class="line">        - name: node-exporter</span><br><span class="line">          hostPort: 9100</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: sys</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: /host_sys</span><br><span class="line">        - name: proc</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: /host_proc</span><br><span class="line">      hostNetwork: true</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/node-exporter/ds.yaml</span><br></pre></td></tr></table></figure>

<h3 id="检查启动情况-1"><a href="#检查启动情况-1" class="headerlink" title="检查启动情况"></a>检查启动情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# netstat -lntup|grep 9100</span><br><span class="line">tcp6       0      0 :::9100                 :::*                    LISTEN      25846/node_exporter</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# curl localhost:9100/metrics</span><br></pre></td></tr></table></figure>

<h2 id="部署cadvisor"><a href="#部署cadvisor" class="headerlink" title="部署cadvisor"></a>部署cadvisor</h2><p>运维主机shkf6-245.host.com上：</p>
<h3 id="准备cadvisor镜像"><a href="#准备cadvisor镜像" class="headerlink" title="准备cadvisor镜像"></a>准备cadvisor镜像</h3><p><a href="https://hub.docker.com/r/google/cadvisor" target="_blank" rel="noopener">cadvisor官方dockerhub地址</a><br><a href="https://github.com/google/cadvisor" target="_blank" rel="noopener">cadvisor官方github地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull google/cadvisor:v0.28.3</span><br><span class="line">[root@shkf6-245 ~]# docker images |grep cadvisor</span><br><span class="line">google/cadvisor                                   v0.28.3                    75f88e3ec333        2 years ago         62.2MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 75f88e3ec333 harbor.od.com/public/cadvisor:v0.28.3</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/public/cadvisor:v0.28.3</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/k8s-yaml/cadvisor</span><br><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/cadvisor/ds.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/cadvisor/ds.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: cadvisor</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: cadvisor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: cadvisor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: cadvisor</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io/master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: cadvisor</span><br><span class="line">        image: harbor.od.com/public/cadvisor:v0.28.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: rootfs</span><br><span class="line">          mountPath: /rootfs</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: var-run</span><br><span class="line">          mountPath: /var/run</span><br><span class="line">        - name: sys</span><br><span class="line">          mountPath: /sys</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: /var/lib/docker</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 4194</span><br><span class="line">            protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 4194</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        args:</span><br><span class="line">          - --housekeeping_interval=10s</span><br><span class="line">          - --port=4194</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: rootfs</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /</span><br><span class="line">      - name: var-run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/run</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/docker</span><br></pre></td></tr></table></figure>

<h3 id="修改运算节点软连接"><a href="#修改运算节点软连接" class="headerlink" title="修改运算节点软连接"></a>修改运算节点软连接</h3><p>所有运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# mount -o remount,rw /sys/fs/cgroup/</span><br><span class="line">~]# ln -s /sys/fs/cgroup/cpu,cpuacct /sys/fs/cgroup/cpuacct,cpu</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/cadvisor/ds.yaml</span><br></pre></td></tr></table></figure>

<h3 id="检查启动情况-2"><a href="#检查启动情况-2" class="headerlink" title="检查启动情况"></a>检查启动情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# netstat -luntp|grep 4194</span><br><span class="line">tcp6       0      0 :::4194                 :::*                    LISTEN      18027/cadvisor</span><br></pre></td></tr></table></figure>

<img src = "/images/m_234810c159c4270b1c6b6ae417a4ca4d_r.png">

<p>污点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/zh/docs/concepts/configuration/taint-and-toleration/</span><br></pre></td></tr></table></figure>

<h2 id="部署blackbox-exporter"><a href="#部署blackbox-exporter" class="headerlink" title="部署blackbox-exporter"></a>部署blackbox-exporter</h2><p>运维主机shkf6-245.host.com上：</p>
<h3 id="准备blackbox-exporter镜像"><a href="#准备blackbox-exporter镜像" class="headerlink" title="准备blackbox-exporter镜像"></a>准备blackbox-exporter镜像</h3><p><a href="https://hub.docker.com/r/prom/blackbox-exporter" target="_blank" rel="noopener">blackbox-exporter官方dockerhub地址</a><br><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">blackbox-exporter官方github地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull prom/blackbox-exporter:v0.15.1</span><br><span class="line">[root@shkf6-245 ~]# docker images|grep blackbox</span><br><span class="line">prom/blackbox-exporter                            v0.15.1                    81b70b6158be        3 months ago        19.7MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 81b70b6158be harbor.od.com/public/blackbox-exporter:v0.15.1</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/public/blackbox-exporter:v0.15.1</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li><p>创建目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/k8s-yaml/blackbox-exporter</span><br></pre></td></tr></table></figure>
</li>
<li><p>ConfigMap</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/blackbox-exporter/cm.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/blackbox-exporter/cm.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 2s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: ["HTTP/1.1", "HTTP/2"]</span><br><span class="line">          valid_status_codes: [200,301,302]</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: "ip4"</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 2s</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/blackbox-exporter/dp.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/blackbox-exporter/dp.yaml</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: 1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: blackbox-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: blackbox-exporter</span><br><span class="line">          defaultMode: 420</span><br><span class="line">      containers:</span><br><span class="line">      - name: blackbox-exporter</span><br><span class="line">        image: harbor.od.com/public/blackbox-exporter:v0.15.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/etc/blackbox_exporter/blackbox.yml</span><br><span class="line">        - --log.level=info</span><br><span class="line">        - --web.listen-address=:9115</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /etc/blackbox_exporter</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 3</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/blackbox-exporter/svc.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/blackbox-exporter/svc.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">    - name: blackbox-port</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 9115</span><br></pre></td></tr></table></figure>

<ul>
<li>Ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/blackbox-exporter/ingress.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/blackbox-exporter/ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blackbox.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: blackbox-exporter</span><br><span class="line">          servicePort: blackbox-port</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-3"><a href="#应用资源配置清单-3" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/cm.yaml</span><br><span class="line">configmap/blackbox-exporter created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/dp.yaml</span><br><span class="line">deployment.extensions/blackbox-exporter created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/svc.yaml</span><br><span class="line">service/blackbox-exporter created</span><br><span class="line">^[[A[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/blackbox-exporter/ingress.yaml</span><br><span class="line">ingress.extensions/blackbox-exporter created</span><br></pre></td></tr></table></figure>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -1 /var/named/od.com.zone </span><br><span class="line">blackbox           A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://blackbox.od.com/" target="_blank" rel="noopener">http://blackbox.od.com/</a></p>
<img src = "/images/m_653bd7f13d555a88f1bb81ba3c870093_r.png">

<h1 id="实战部署Prometheus及其配置详解"><a href="#实战部署Prometheus及其配置详解" class="headerlink" title="实战部署Prometheus及其配置详解"></a>实战部署Prometheus及其配置详解</h1><h2 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h2><p>运维主机shkf6-245.host.com上：</p>
<h3 id="准备prometheus镜像"><a href="#准备prometheus镜像" class="headerlink" title="准备prometheus镜像"></a>准备prometheus镜像</h3><p><a href="https://hub.docker.com/r/prom/prometheus" target="_blank" rel="noopener">prometheus官方dockerhub地址</a><br><a href="https://github.com/prometheus/prometheus" target="_blank" rel="noopener">prometheus官方github地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull prom/prometheus:v2.14.0</span><br><span class="line">[root@shkf6-245 ~]# docker images |grep prometheus</span><br><span class="line">prom/prometheus                                   v2.14.0                    7317640d555e        5 weeks ago         130MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 7317640d555e harbor.od.com/infra/prometheus:v2.12.0</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/infra/prometheus:v2.12.0</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-4"><a href="#准备资源配置清单-4" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机shkf6-245.host.com上：</p>
<ul>
<li>创建目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/k8s-yaml/prometheus</span><br></pre></td></tr></table></figure>

<ul>
<li>rbac</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/prometheus/rbac.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/prometheus/rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/prometheus/dp.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/prometheus/dp.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: "5"</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      nodeName: shkf6-243.host.com</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus</span><br><span class="line">        image: harbor.od.com/infra/prometheus:v2.12.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /bin/prometheus</span><br><span class="line">        args:</span><br><span class="line">        - --config.file=/data/etc/prometheus.yml</span><br><span class="line">        - --storage.tsdb.path=/data/prom-db</span><br><span class="line">        - --storage.tsdb.min-block-duration=10m</span><br><span class="line">        - --storage.tsdb.retention=72h</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /data</span><br><span class="line">          name: data</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: "1000m"</span><br><span class="line">            memory: "1.5Gi"</span><br><span class="line">          limits:</span><br><span class="line">            cpu: "2000m"</span><br><span class="line">            memory: "3Gi"</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs:</span><br><span class="line">          server: shkf6-245</span><br><span class="line">          path: /data/nfs-volume/prometheus</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/prometheus/svc.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/prometheus/svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9090</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure>

<ul>
<li>Ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/prometheus/ingress.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/prometheus/ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure>

<h3 id="准备promentheus的配置文件"><a href="#准备promentheus的配置文件" class="headerlink" title="准备promentheus的配置文件"></a>准备promentheus的配置文件</h3><p>运维主机shkf6-245.host.com上：</p>
<ul>
<li>拷贝证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir -pv /data/nfs-volume/prometheus/&#123;etc,prom-db&#125;</span><br><span class="line">mkdir: created directory ‘/data/nfs-volume/prometheus/etc’</span><br><span class="line">mkdir: created directory ‘/data/nfs-volume/prometheus/prom-db’</span><br><span class="line">[root@shkf6-245 ~]# cp /opt/certs/ca.pem /data/nfs-volume/prometheus/etc/</span><br><span class="line">[root@shkf6-245 ~]# cp /opt/certs/client.pem /data/nfs-volume/prometheus/etc/</span><br><span class="line">[root@shkf6-245 ~]# cp /opt/certs/client-key.pem /data/nfs-volume/prometheus/etc/</span><br></pre></td></tr></table></figure>

<ul>
<li>准备配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/nfs-volume/prometheus/etc/prometheus.yml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/nfs-volume/prometheus/etc/prometheus.yml</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: 'etcd'</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /data/etc/ca.pem</span><br><span class="line">    cert_file: /data/etc/client.pem</span><br><span class="line">    key_file: /data/etc/client-key.pem</span><br><span class="line">  scheme: https</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - '192.168.6.242:2379'</span><br><span class="line">    - '192.168.6.243:2379'</span><br><span class="line">    - '192.168.6.244:2379'</span><br><span class="line">- job_name: 'kubernetes-apiservers'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: default;kubernetes;https</span><br><span class="line">- job_name: 'kubernetes-pods'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: true</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: 'kubernetes-kubelet'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10255</span><br><span class="line">- job_name: 'kubernetes-cadvisor'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:4194</span><br><span class="line">- job_name: 'kubernetes-kube-state'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_grafanak8sapp]</span><br><span class="line">    regex: .*true.*</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: ['__meta_kubernetes_pod_label_daemon', '__meta_kubernetes_pod_node_name']</span><br><span class="line">    regex: 'node-exporter;(.*)'</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: nodename</span><br><span class="line">- job_name: 'blackbox_http_pod_probe'</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: http</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port,  __meta_kubernetes_pod_annotation_blackbox_path]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+);(.+)</span><br><span class="line">    replacement: $1:$2$3</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: 'blackbox_tcp_pod_probe'</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: tcp</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: 'traefik'</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: traefik</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-4"><a href="#应用资源配置清单-4" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/rbac.yaml</span><br><span class="line">serviceaccount/prometheus created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/dp.yaml</span><br><span class="line">deployment.extensions/prometheus created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/svc.yaml</span><br><span class="line">service/prometheus created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/ingress.yaml</span><br><span class="line">ingress.extensions/prometheus created</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p>在shkf6-241.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -1 /var/named/od.com.zone </span><br><span class="line">prometheus         A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://prometheus.od.com/" target="_blank" rel="noopener">http://prometheus.od.com</a><br><img src = "/images/m_fe66b177f34d1bb567cb372e70a44843_r.png"></p>
<h3 id="Prometheus监控内容"><a href="#Prometheus监控内容" class="headerlink" title="Prometheus监控内容"></a>Prometheus监控内容</h3><p>Targets（jobs）</p>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><blockquote>
<p>监控etcd服务</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">etcd_server_has_leader</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">etcd_http_failed_total</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left">….</td>
</tr>
</tbody></table>
<h4 id="kubernetes-apiserver"><a href="#kubernetes-apiserver" class="headerlink" title="kubernetes-apiserver"></a>kubernetes-apiserver</h4><blockquote>
<p>监控apiserver服务</p>
</blockquote>
<h4 id="kubernetes-kubelet"><a href="#kubernetes-kubelet" class="headerlink" title="kubernetes-kubelet"></a>kubernetes-kubelet</h4><blockquote>
<p>监控kubelet服务</p>
</blockquote>
<h4 id="kubernetes-kube-state"><a href="#kubernetes-kube-state" class="headerlink" title="kubernetes-kube-state"></a>kubernetes-kube-state</h4><p>监控基本信息</p>
<ul>
<li>node-exporter</li>
</ul>
<blockquote>
<p>监控Node节点信息</p>
</blockquote>
<ul>
<li>kube-state-metrics</li>
</ul>
<blockquote>
<p>监控pod信息</p>
</blockquote>
<h4 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a>traefik</h4><blockquote>
<p>监控traefik-ingress-controller</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">traefik_entrypoint_requests_total{code=”200”,entrypoint=”http”,method=”PUT”,protocol=”http”}</td>
<td align="left">138</td>
</tr>
<tr>
<td align="left">traefik_entrypoint_requests_total{code=”200”,entrypoint=”http”,method=”GET”,protocol=”http”}</td>
<td align="left">285</td>
</tr>
<tr>
<td align="left">traefik_entrypoint_open_connections{entrypoint=”http”,method=”PUT”,protocol=”http”}</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left">…</td>
</tr>
</tbody></table>
<p><strong>注意：在traefik的pod控制器上加annotations，并重启pod，监控生效</strong></p>
<p>配置范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scheme": "traefik",</span><br><span class="line">  "prometheus_io_path": "/metrics",</span><br><span class="line">  "prometheus_io_port": "8080"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="blackbox"><a href="#blackbox" class="headerlink" title="blackbox*"></a>blackbox*</h4><p>监控服务是否存活</p>
<ul>
<li>blackbox_tcp_pod_porbe</li>
</ul>
<blockquote>
<p>监控tcp协议服务是否存活</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">probe_success</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">probe_ip_protocol</td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">probe_failed_due_to_regex</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">probe_duration_seconds</td>
<td align="left">0.000597546</td>
</tr>
<tr>
<td align="left">probe_dns_lookup_time_seconds</td>
<td align="left">0.00010898</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong></p>
<p>配置范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "blackbox_port": "20880",</span><br><span class="line">  "blackbox_scheme": "tcp"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>blackbox_http_pod_probe</li>
</ul>
<blockquote>
<p>监控http协议服务是否存活</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">probe_success</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">probe_ip_protocol</td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">probe_http_version</td>
<td align="left">1.1</td>
</tr>
<tr>
<td align="left">probe_http_status_code</td>
<td align="left">200</td>
</tr>
<tr>
<td align="left">probe_http_ssl</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">probe_http_redirects</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">probe_http_last_modified_timestamp_seconds</td>
<td align="left">1.553861888e+09</td>
</tr>
<tr>
<td align="left">probe_http_duration_seconds{phase=”transfer”}</td>
<td align="left">0.000238343</td>
</tr>
<tr>
<td align="left">probe_http_duration_seconds{phase=”tls”}</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">probe_http_duration_seconds{phase=”resolve”}</td>
<td align="left">5.4095e-05</td>
</tr>
<tr>
<td align="left">probe_http_duration_seconds{phase=”processing”}</td>
<td align="left">0.000966104</td>
</tr>
<tr>
<td align="left">probe_http_duration_seconds{phase=”connect”}</td>
<td align="left">0.000520821</td>
</tr>
<tr>
<td align="left">probe_http_content_length</td>
<td align="left">716</td>
</tr>
<tr>
<td align="left">probe_failed_due_to_regex</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">probe_duration_seconds</td>
<td align="left">0.00272609</td>
</tr>
<tr>
<td align="left">probe_dns_lookup_time_seconds</td>
<td align="left">5.4095e-05</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong></p>
<p>配置范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "blackbox_path": "/",</span><br><span class="line">  "blackbox_port": "8080",</span><br><span class="line">  "blackbox_scheme": "http"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="kubernetes-pods"><a href="#kubernetes-pods" class="headerlink" title="kubernetes-pods*"></a>kubernetes-pods*</h4><blockquote>
<p>监控JVM信息</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">jvm_info{version=”1.7.0_80-b15”,vendor=”Oracle Corporation”,runtime=”Java(TM) SE Runtime Environment”,}</td>
<td align="left">1.0</td>
</tr>
<tr>
<td align="left">jmx_config_reload_success_total</td>
<td align="left">0.0</td>
</tr>
<tr>
<td align="left">process_resident_memory_bytes</td>
<td align="left">4.693897216E9</td>
</tr>
<tr>
<td align="left">process_virtual_memory_bytes</td>
<td align="left">1.2138840064E10</td>
</tr>
<tr>
<td align="left">process_max_fds</td>
<td align="left">65536.0</td>
</tr>
<tr>
<td align="left">process_open_fds</td>
<td align="left">123.0</td>
</tr>
<tr>
<td align="left">process_start_time_seconds</td>
<td align="left">1.54331073249E9</td>
</tr>
<tr>
<td align="left">process_cpu_seconds_total</td>
<td align="left">196465.74</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_used_buffers{pool=”mapped”,}</td>
<td align="left">0.0</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_used_buffers{pool=”direct”,}</td>
<td align="left">150.0</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_capacity_bytes{pool=”mapped”,}</td>
<td align="left">0.0</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_capacity_bytes{pool=”direct”,}</td>
<td align="left">6216688.0</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_used_bytes{pool=”mapped”,}</td>
<td align="left">0.0</td>
</tr>
<tr>
<td align="left">jvm_buffer_pool_used_bytes{pool=”direct”,}</td>
<td align="left">6216688.0</td>
</tr>
<tr>
<td align="left">jvm_gc_collection_seconds_sum{gc=”PS MarkSweep”,}</td>
<td align="left">1.867</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left">…</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong></p>
<p>配置范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scrape": "true",</span><br><span class="line">  "prometheus_io_port": "12346",</span><br><span class="line">  "prometheus_io_path": "/"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改traefik服务接入prometheus监控"><a href="#修改traefik服务接入prometheus监控" class="headerlink" title="修改traefik服务接入prometheus监控"></a>修改traefik服务接入prometheus监控</h3><p>dashboard上：<br>kube-system名称空间-&gt;daemonset-&gt;traefik-ingress-controller-&gt;spec-&gt;template-&gt;metadata下，添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scheme": "traefik",</span><br><span class="line">  "prometheus_io_path": "/metrics",</span><br><span class="line">  "prometheus_io_port": "8080"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<p>继续添加blackbox监控配置项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scheme": "traefik",</span><br><span class="line">  "prometheus_io_path": "/metrics",</span><br><span class="line">  "prometheus_io_port": "8080",</span><br><span class="line">  "blackbox_path": "/",</span><br><span class="line">  "blackbox_port": "8080",</span><br><span class="line">  "blackbox_scheme": "http"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改dubbo-service服务接入prometheus监控"><a href="#修改dubbo-service服务接入prometheus监控" class="headerlink" title="修改dubbo-service服务接入prometheus监控"></a>修改dubbo-service服务接入prometheus监控</h3><p>dashboard上：<br>app名称空间-&gt;deployment-&gt;dubbo-demo-service-&gt;spec-&gt;template=&gt;metadata下，添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scrape": "true",</span><br><span class="line">  "prometheus_io_path": "/",</span><br><span class="line">  "prometheus_io_port": "12346",</span><br><span class="line">  "blackbox_port": "20880",</span><br><span class="line">  "blackbox_scheme": "tcp"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<h3 id="修改dubbo-consumer服务接入prometheus监控"><a href="#修改dubbo-consumer服务接入prometheus监控" class="headerlink" title="修改dubbo-consumer服务接入prometheus监控"></a>修改dubbo-consumer服务接入prometheus监控</h3><p>app名称空间-&gt;deployment-&gt;dubbo-demo-consumer-&gt;spec-&gt;template-&gt;metadata下，添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">"annotations": &#123;</span><br><span class="line">  "prometheus_io_scrape": "true",</span><br><span class="line">  "prometheus_io_path": "/",</span><br><span class="line">  "prometheus_io_port": "12346",</span><br><span class="line">  "blackbox_path": "/hello",</span><br><span class="line">  "blackbox_port": "8080",</span><br><span class="line">  "blackbox_scheme": "http"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<h1 id="实战部署容器云监控展示平台Grafana"><a href="#实战部署容器云监控展示平台Grafana" class="headerlink" title="实战部署容器云监控展示平台Grafana"></a>实战部署容器云监控展示平台Grafana</h1><p>运维主机shkf6-245.host.com上：</p>
<h2 id="准备grafana镜像"><a href="#准备grafana镜像" class="headerlink" title="准备grafana镜像"></a>准备grafana镜像</h2><p><a href="https://hub.docker.com/r/grafana/grafana" target="_blank" rel="noopener">grafana官方dockerhub地址</a><br><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener">grafana官方github地址</a><br><a href="https://grafana.com/" target="_blank" rel="noopener">grafana官网</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull grafana/grafana:5.4.2</span><br><span class="line">[root@shkf6-245 ~]# docker images |grep grafana</span><br><span class="line">grafana/grafana                                   5.4.2                      6f18ddf9e552        12 months ago       243MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 6f18ddf9e552 harbor.od.com/infra/grafana:v5.4.2</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/infra/grafana:v5.4.2</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单-5"><a href="#准备资源配置清单-5" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><ul>
<li>RBAC</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/grafana/rbac.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/grafana/rbac.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: grafana</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - "*"</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - deployments</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">  name: grafana</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: grafana</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir /data/nfs-volume/grafana</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/grafana/dp.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/grafana/dp.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    name: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: grafana</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        name: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: harbor.od.com/infra/grafana:v5.4.2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/lib/grafana</span><br><span class="line">          name: data</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - nfs:</span><br><span class="line">          server: shkf6-245</span><br><span class="line">          path: /data/nfs-volume/grafana</span><br><span class="line">        name: data</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/grafana/svc.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/grafana/svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br></pre></td></tr></table></figure>

<ul>
<li>Ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/grafana/ingress.yaml</span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/grafana/ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure>

<h2 id="应用资源配置清单-5"><a href="#应用资源配置清单-5" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>任意运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/rbac.yaml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/grafana created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/grafana created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/dp.yaml</span><br><span class="line">deployment.extensions/grafana created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/svc.yaml</span><br><span class="line">service/grafana created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/ingress.yaml</span><br><span class="line">ingress.extensions/grafana created</span><br></pre></td></tr></table></figure>

<h2 id="解析域名-2"><a href="#解析域名-2" class="headerlink" title="解析域名"></a>解析域名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -1 /var/named/od.com.zone </span><br><span class="line">grafana            A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://grafana.od.com/" target="_blank" rel="noopener">http://grafana.od.com</a></p>
<ul>
<li>用户名：admin</li>
<li>密 码：admin</li>
</ul>
<p>登录后需要修改管理员密码</p>
<img src = "/images/m_c1e00b25001cd20b9c7a6d2cef2feb50_r.png">

<h2 id="配置grafana页面"><a href="#配置grafana页面" class="headerlink" title="配置grafana页面"></a>配置grafana页面</h2><h3 id="外观"><a href="#外观" class="headerlink" title="外观"></a>外观</h3><p>Configuration -&gt; Preferences</p>
<ul>
<li>UI Theme</li>
</ul>
<blockquote>
<p>Light</p>
</blockquote>
<ul>
<li>Home Dashboard</li>
</ul>
<blockquote>
<p>Default</p>
</blockquote>
<ul>
<li>Timezone</li>
</ul>
<blockquote>
<p>Local browser time</p>
</blockquote>
<p>save</p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>Configuration -&gt; Plugins</p>
<ul>
<li>Kubernetes App</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-kubernetes-app</span><br></pre></td></tr></table></figure>

<p>安装方法二：</p>
<p><a href="https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cd /data/nfs-volume/grafana/plugins</span><br><span class="line">[root@shkf6-245 plugins]# wget https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download -O grafana-kubernetes-app.zip</span><br><span class="line">[root@shkf6-245 plugins]# unzip grafana-kubernetes-app.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>Clock Pannel</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-clock-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：</p>
<p><a href="https://grafana.com/api/plugins/grafana-clock-panel/versions/1.0.2/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>Pie Chart</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：</p>
<p><a href="https://grafana.com/api/plugins/grafana-piechart-panel/versions/1.3.6/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>D3 Gauge<br>安装方法一：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install briangann-gauge-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：</p>
<p><a href="https://grafana.com/api/plugins/briangann-gauge-panel/versions/0.0.6/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>Discrete</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install natel-discrete-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：</p>
<p><a href="https://grafana.com/api/plugins/natel-discrete-panel/versions/0.0.9/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>重启grafana的pod</li>
<li>依次enable插件</li>
</ul>
<h2 id="配置grafana数据源"><a href="#配置grafana数据源" class="headerlink" title="配置grafana数据源"></a>配置grafana数据源</h2><p>Configuration -&gt; Data Sources<br>选择prometheus</p>
<ul>
<li>HTTP</li>
</ul>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">URL</td>
<td align="left"><a href="http://prometheus.od.com/" target="_blank" rel="noopener">http://prometheus.od.com</a></td>
</tr>
<tr>
<td align="left">Access</td>
<td align="left">Server(Default)</td>
</tr>
</tbody></table>
<ul>
<li>Auth</li>
</ul>
<img src = "/images/m_bda24d3bd634b0ca1719830ae0a5d5f5_r.png">

<ul>
<li>TLS Auth Details</li>
</ul>
<img src = "/images/m_2f6e44f0dce10d509970c1ac97e0dd48_r.png">

<ul>
<li>Save &amp; Test</li>
</ul>
<img src = "/images/m_707c984c4fa7468b28bacf8da59ec233_r.png">

<h2 id="配置Kubernetes集群Dashboard"><a href="#配置Kubernetes集群Dashboard" class="headerlink" title="配置Kubernetes集群Dashboard"></a>配置Kubernetes集群Dashboard</h2><ul>
<li><p>Configuration -&gt; pligins -&gt; Kubernetes</p>
<blockquote>
<p>Enable</p>
</blockquote>
</li>
</ul>
<img src = "/images/m_20b6b347e477ef5a3967bb823b2c83e4_r.png">

<p>kubernetes -&gt; +New Cluster</p>
<ul>
<li>Add a new cluster</li>
</ul>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Name</td>
<td align="left">myk8s</td>
</tr>
</tbody></table>
<ul>
<li>HTTP</li>
</ul>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">URL</td>
<td align="left"><a href="https://192.168.6.66:7443/" target="_blank" rel="noopener">https://192.168.6.66:7443</a></td>
</tr>
<tr>
<td align="left">Access</td>
<td align="left">Server(Default)</td>
</tr>
</tbody></table>
<ul>
<li>Auth</li>
</ul>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">TLS Client Auth</td>
<td align="left">勾选</td>
</tr>
<tr>
<td align="left">With Ca Cert</td>
<td align="left">勾选</td>
</tr>
</tbody></table>
<p>将ca.pem、client.pem和client-key.pem粘贴至文本框内</p>
<ul>
<li>Prometheus Read</li>
</ul>
<table>
<thead>
<tr>
<th align="left">key</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Datasource</td>
<td align="left">Prometheus</td>
</tr>
</tbody></table>
<ul>
<li>Save</li>
</ul>
<p>注意：</p>
<p>K8S Container中，所有Pannel的<br>pod_name -&gt; container_label_io_kubernetes_pod_name</p>
<h1 id="实战通过Alertmanager组件进行监控告警"><a href="#实战通过Alertmanager组件进行监控告警" class="headerlink" title="实战通过Alertmanager组件进行监控告警"></a>实战通过Alertmanager组件进行监控告警</h1><h2 id="准备Alertmanager镜像"><a href="#准备Alertmanager镜像" class="headerlink" title="准备Alertmanager镜像"></a>准备Alertmanager镜像</h2><p>在运维主机上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull docker.io/prom/alertmanager:v0.14.0</span><br><span class="line">[root@shkf6-245 ~]# docker images |grep alertmanager</span><br><span class="line">prom/alertmanager                                 v0.14.0                    23744b2d645c        22 months ago       31.9MB</span><br><span class="line">[root@shkf6-245 ~]# docker tag 23744b2d645c harbor.od.com/infra/alertmanager:v0.14.0</span><br><span class="line">[root@shkf6-245 ~]# docker push harbor.od.com/infra/alertmanager:v0.14.0</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单-6"><a href="#准备资源配置清单-6" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><ul>
<li>ConfigMap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/k8s-yaml/alertmanager/cm.yaml </span><br><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/alertmanager/cm.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  config.yml: |-</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      smtp_smarthost: 'smtp.qq.com:465'</span><br><span class="line">      smtp_from: '1210353303@qq.com'</span><br><span class="line">      smtp_auth_username: '1210353303@qq.com'</span><br><span class="line">      smtp_auth_password: 'pzrjjrntflqeigae'</span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    route:</span><br><span class="line">      group_by: ['alertname', 'cluster']</span><br><span class="line">      group_wait: 30s</span><br><span class="line"></span><br><span class="line">      group_interval: 5m</span><br><span class="line"></span><br><span class="line">      repeat_interval: 5m</span><br><span class="line"></span><br><span class="line">      receiver: default</span><br><span class="line"></span><br><span class="line">    receivers:</span><br><span class="line">    - name: 'default'</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: 'liyanzhao@mcake.com'</span><br><span class="line">        send_resolved: true</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/alertmanager/dp.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alertmanager</span><br><span class="line">        image: harbor.od.com/infra/alertmanager:v0.14.0</span><br><span class="line">        args:</span><br><span class="line">          - "--config.file=/etc/alertmanager/config.yml"</span><br><span class="line">          - "--storage.path=/alertmanager"</span><br><span class="line">        ports:</span><br><span class="line">        - name: alertmanager</span><br><span class="line">          containerPort: 9093</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: alertmanager-cm</span><br><span class="line">          mountPath: /etc/alertmanager</span><br><span class="line">      volumes:</span><br><span class="line">      - name: alertmanager-cm</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/alertmanager/svc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    app: alertmanager</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 9093</span><br></pre></td></tr></table></figure>

<h2 id="应用资源配置清单-6"><a href="#应用资源配置清单-6" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f  http://k8s-yaml.od.com/alertmanager/cm.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f  http://k8s-yaml.od.com/alertmanager/dp.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f  http://k8s-yaml.od.com/alertmanager/svc.yaml</span><br></pre></td></tr></table></figure>

<h2 id="报警规则"><a href="#报警规则" class="headerlink" title="报警规则"></a>报警规则</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vi /data/nfs-volume/prometheus/etc/rules.yml</span><br><span class="line">groups:</span><br><span class="line">- name: hostStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: hostCpuUsageAlert</span><br><span class="line">    expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!='idle'&#125;[5m]))) by (instance) &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)"</span><br><span class="line">  - alert: hostMemUsageAlert</span><br><span class="line">    expr: (node_memory_MemTotal - node_memory_MemAvailable)/node_memory_MemTotal &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)"</span><br><span class="line">  - alert: OutOfInodes</span><br><span class="line">    expr: node_filesystem_free&#123;fstype="overlay",mountpoint ="/"&#125; / node_filesystem_size&#123;fstype="overlay",mountpoint ="/"&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: OutOfDiskSpace</span><br><span class="line">    expr: node_filesystem_free&#123;fstype="overlay",mountpoint ="/rootfs"&#125; / node_filesystem_size&#123;fstype="overlay",mountpoint ="/rootfs"&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualNetworkThroughputIn</span><br><span class="line">    expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Host network interfaces are probably receiving too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualNetworkThroughputOut</span><br><span class="line">    expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Host network interfaces are probably sending too much data (&gt; 100 MB/s) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualDiskReadRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_read[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk is probably reading too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualDiskWriteRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_written[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk is probably writing too much data (&gt; 50 MB/s) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualDiskReadLatency</span><br><span class="line">    expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: UnusualDiskWriteLatency</span><br><span class="line">    expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completedl[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">- name: http_status</span><br><span class="line">  rules:</span><br><span class="line">  - alert: ProbeFailed</span><br><span class="line">    expr: probe_success == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Probe failed (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: StatusCode</span><br><span class="line">    expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: SslCertificateWillExpireSoon</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: SslCertificateHasExpired</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: BlackboxSlowPing</span><br><span class="line">    expr: probe_icmp_duration_seconds &gt; 2</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: BlackboxSlowRequests</span><br><span class="line">    expr: probe_http_duration_seconds &gt; 2 </span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)"</span><br><span class="line">      description: "Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)"</span><br><span class="line">  - alert: PodCpuUsagePercent</span><br><span class="line">    expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),"pod","$1","container_label_io_kubernetes_pod_name", "(.*)"))by(pod) / on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: "Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)"</span><br></pre></td></tr></table></figure>

<h2 id="prometheus加载报警规则"><a href="#prometheus加载报警规则" class="headerlink" title="prometheus加载报警规则"></a>prometheus加载报警规则</h2><ul>
<li>在结尾把报警配置追加上</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# vim /data/nfs-volume/prometheus/etc/prometheus.yml </span><br><span class="line"></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: ["alertmanager"]</span><br><span class="line">rule_files:</span><br><span class="line"> - "/data/etc/rules.yml"</span><br></pre></td></tr></table></figure>

<ul>
<li>平滑重启prometheus</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# ps -ef|grep prometheus</span><br><span class="line">root     14240 14221  1 Dec24 ?        00:15:22 traefik traefik --api --kubernetes --logLevel=INFO --insecureskipverify=true --kubernetes.endpoint=https://192.168.6.66:7443 --accesslog --accesslog.filepath=/var/log/traefik_access.log --traefiklog --traefiklog.filepath=/var/log/traefik.log --metrics.prometheus</span><br><span class="line">root     23839 23821 11 Dec24 ?        02:57:21 /bin/prometheus --config.file=/data/etc/prometheus.yml --storage.tsdb.path=/data/prom-db --storage.tsdb.min-block-duration=10m --storage.tsdb.retention=72h</span><br><span class="line">root     25825 23546  0 10:28 pts/1    00:00:00 grep --color=auto prometheus</span><br><span class="line">[root@shkf6-243 ~]# kill -SIGHUP 23839</span><br></pre></td></tr></table></figure>

<h2 id="验证报警"><a href="#验证报警" class="headerlink" title="验证报警"></a>验证报警</h2><p>a.副本数缩为0<br><img src = "/images/m_581956d22023d22ca084410af06c6714_r.png"></p>
<p>b.等待1分钟，查看邮件<br><img src = "/images/m_a4893ff46c70aa5481b28d97b3687b56_r.png"></p>
<img src = "/images/m_01511797c735e106f263fc3a50de4ac0_r.png">

<h2 id="钉钉报警"><a href="#钉钉报警" class="headerlink" title="钉钉报警"></a>钉钉报警</h2><p><a href="https://github.com/cnych/alertmanager-dingtalk-hook" target="_blank" rel="noopener">https://github.com/cnych/alertmanager-dingtalk-hook</a></p>
<p><a href="https://www.cnblogs.com/wangxu01/articles/11654836.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangxu01/articles/11654836.html</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">PhenoGao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://xonlab.com/2020/04/09/Kubernetes-Prometheus%E9%83%A8%E7%BD%B2/">http://xonlab.com/2020/04/09/Kubernetes-Prometheus%E9%83%A8%E7%BD%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xonlab.com" target="_blank">XonLab</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a></div><div class="post_share"><div class="social-share" data-image="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-r2e58q.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/15/Kubernetes-ELK%E9%83%A8%E7%BD%B2/"><img class="prev-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-4gmmee.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kubernetes-ELK部署</div></div></a></div><div class="next-post pull-right"><a href="/2020/04/08/Mock-js/"><img class="next-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-nika-akin-3598435.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Mock.js</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/26/Docker基础知识汇编/" title="Docker基础知识汇编"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-jo%C3%A3o-v%C3%ADtor-heinrichs-1856183.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-26</div><div class="relatedPosts_title">Docker基础知识汇编</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/Kubernetes-ELK部署/" title="Kubernetes-ELK部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-4gmmee.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-15</div><div class="relatedPosts_title">Kubernetes-ELK部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/Kubernetes-dubbo部署/" title="Kubernetes-dubbo部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/background-2731956_1280.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-03</div><div class="relatedPosts_title">Kubernetes-dubbo部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Kubernetes-Apollo部署/" title="Kubernetes-apollo部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/material-design-hd-background-by-vactual-papers-wallpaper-695-1920x1080.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-04</div><div class="relatedPosts_title">Kubernetes-apollo部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/01/Kubernetes部署-Ⅱ/" title="Kubernetes部署 Ⅱ"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-1988692.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-01</div><div class="relatedPosts_title">Kubernetes部署 Ⅱ</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/28/Kubernetes部署Ⅰ/" title="Kubernetes部署 Ⅰ"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-1416367.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-28</div><div class="relatedPosts_title">Kubernetes部署 Ⅰ</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By PhenoGao</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>