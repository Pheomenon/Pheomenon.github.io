<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes部署 Ⅱ | XonLab</title><meta name="description" content="前情回顾1.使用二进制安装部署K8S的要点：  基础设施环境准备好 centos7.6系统（内核在3.8x以上） 关闭SELinux，关闭firewalld服务 时间同步（chronyd） 调整Base源，epel源 内核优化（文件描述符大小，内核转发，等等。。。）   安装部署bind9内网DNS系统 安装部署docker的私有仓库–harbor 准备证书签发环境–cfssl 安装部署主控节点服"><meta name="keywords" content="Docker,Kubernetes"><meta name="author" content="PhenoGao"><meta name="copyright" content="PhenoGao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://xonlab.com/2020/04/01/Kubernetes%E9%83%A8%E7%BD%B2-%E2%85%A1/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes部署 Ⅱ"><meta property="og:url" content="http://xonlab.com/2020/04/01/Kubernetes%E9%83%A8%E7%BD%B2-%E2%85%A1/"><meta property="og:site_name" content="XonLab"><meta property="og:description" content="前情回顾1.使用二进制安装部署K8S的要点：  基础设施环境准备好 centos7.6系统（内核在3.8x以上） 关闭SELinux，关闭firewalld服务 时间同步（chronyd） 调整Base源，epel源 内核优化（文件描述符大小，内核转发，等等。。。）   安装部署bind9内网DNS系统 安装部署docker的私有仓库–harbor 准备证书签发环境–cfssl 安装部署主控节点服"><meta property="og:image" content="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-3216996.jpg"><meta property="article:published_time" content="2020-04-01T02:11:21.000Z"><meta property="article:modified_time" content="2021-02-15T04:18:59.737Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="《娱乐至死》第1章" href="http://xonlab.com/2020/04/02/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E7%AC%AC1%E7%AB%A0/"><link rel="next" title="Kubernetes部署 Ⅰ" href="http://xonlab.com/2020/03/28/Kubernetes%E9%83%A8%E7%BD%B2%E2%85%A0/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://edu-102.oss-cn-beijing.aliyuncs.com/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">107</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">69</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前情回顾"><span class="toc-number">1.</span> <span class="toc-text">前情回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubectl命令工具使用详解"><span class="toc-number">2.</span> <span class="toc-text">kubectl命令工具使用详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#陈述式资源管理方法"><span class="toc-number">2.1.</span> <span class="toc-text">陈述式资源管理方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#管理名称空间"><span class="toc-number">2.1.1.</span> <span class="toc-text">管理名称空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#管理deployment资源"><span class="toc-number">2.1.2.</span> <span class="toc-text">管理deployment资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#管理service资源"><span class="toc-number">2.1.3.</span> <span class="toc-text">管理service资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubectl用法总结"><span class="toc-number">2.1.4.</span> <span class="toc-text">kubectl用法总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#声明式资源管理方法"><span class="toc-number">2.2.</span> <span class="toc-text">声明式资源管理方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#陈述式资源管理方法的局限性"><span class="toc-number">2.2.1.</span> <span class="toc-text">陈述式资源管理方法的局限性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看资源配置清单"><span class="toc-number">2.2.2.</span> <span class="toc-text">查看资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解释资源配置清单"><span class="toc-number">2.2.3.</span> <span class="toc-text">解释资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建资源配置清单"><span class="toc-number">2.2.4.</span> <span class="toc-text">创建资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单"><span class="toc-number">2.2.5.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改资源配置清单并应用"><span class="toc-number">2.2.6.</span> <span class="toc-text">修改资源配置清单并应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除资源配置清单"><span class="toc-number">2.2.7.</span> <span class="toc-text">删除资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看并使用Service资源"><span class="toc-number">2.2.8.</span> <span class="toc-text">查看并使用Service资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes的CNI网络插件-flannel"><span class="toc-number">3.</span> <span class="toc-text">kubernetes的CNI网络插件-flannel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#集群规划："><span class="toc-number">3.1.</span> <span class="toc-text">集群规划：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载软件，解压，做软连接"><span class="toc-number">3.1.1.</span> <span class="toc-text">下载软件，解压，做软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最终目录结构"><span class="toc-number">3.1.2.</span> <span class="toc-text">最终目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拷贝证书"><span class="toc-number">3.1.3.</span> <span class="toc-text">拷贝证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建配置"><span class="toc-number">3.1.4.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建启动脚本"><span class="toc-number">3.1.5.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查配置，权限，创建日志目录"><span class="toc-number">3.1.6.</span> <span class="toc-text">检查配置，权限，创建日志目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建supervisor配置"><span class="toc-number">3.1.7.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作etcd，增加host-gw"><span class="toc-number">3.1.8.</span> <span class="toc-text">操作etcd，增加host-gw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务并检查"><span class="toc-number">3.1.9.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装部署启动检查所有集群规划的机器"><span class="toc-number">3.1.10.</span> <span class="toc-text">安装部署启动检查所有集群规划的机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再次验证集群，pod之间网络互通"><span class="toc-number">3.1.11.</span> <span class="toc-text">再次验证集群，pod之间网络互通</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在各个节点上优化iptables规则"><span class="toc-number">3.1.12.</span> <span class="toc-text">在各个节点上优化iptables规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在运算节点保存iptables规则"><span class="toc-number">3.1.13.</span> <span class="toc-text">在运算节点保存iptables规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes的服务发现插件–coredns"><span class="toc-number">4.</span> <span class="toc-text">Kubernetes的服务发现插件–coredns</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署K8S的内网资源配置清单http服务"><span class="toc-number">4.1.</span> <span class="toc-text">部署K8S的内网资源配置清单http服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署coredns"><span class="toc-number">4.2.</span> <span class="toc-text">部署coredns</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备coredns-v1-6-1镜像"><span class="toc-number">4.2.1.</span> <span class="toc-text">准备coredns-v1.6.1镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单"><span class="toc-number">4.2.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依次执行创建"><span class="toc-number">4.2.3.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查"><span class="toc-number">4.2.4.</span> <span class="toc-text">检查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes的服务暴露插件–traefik"><span class="toc-number">5.</span> <span class="toc-text">Kubernetes的服务暴露插件–traefik</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用NodePort型Service暴露服务"><span class="toc-number">5.1.</span> <span class="toc-text">使用NodePort型Service暴露服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改nginx-ds的service资源配置清单"><span class="toc-number">5.1.1.</span> <span class="toc-text">修改nginx-ds的service资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重建nginx-ds的service资源"><span class="toc-number">5.1.2.</span> <span class="toc-text">重建nginx-ds的service资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看service"><span class="toc-number">5.1.3.</span> <span class="toc-text">查看service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#浏览器访问"><span class="toc-number">5.1.4.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#还原成ipvs"><span class="toc-number">5.1.5.</span> <span class="toc-text">还原成ipvs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署traefik（ingress控制器）"><span class="toc-number">5.2.</span> <span class="toc-text">部署traefik（ingress控制器）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备traefik镜像"><span class="toc-number">5.2.1.</span> <span class="toc-text">准备traefik镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依次执行创建-1"><span class="toc-number">5.2.3.</span> <span class="toc-text">依次执行创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析域名"><span class="toc-number">5.3.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置反向代理"><span class="toc-number">5.4.</span> <span class="toc-text">配置反向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#检查-1"><span class="toc-number">5.5.</span> <span class="toc-text">检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问-1"><span class="toc-number">5.6.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#的GUI资源管理插件-仪表篇"><span class="toc-number">6.</span> <span class="toc-text">的GUI资源管理插件-仪表篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署kubenetes-dashborad"><span class="toc-number">6.1.</span> <span class="toc-text">部署kubenetes-dashborad</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备dashboard镜像"><span class="toc-number">6.1.1.</span> <span class="toc-text">准备dashboard镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备配置清单"><span class="toc-number">6.1.2.</span> <span class="toc-text">准备配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依次执行创建-2"><span class="toc-number">6.1.3.</span> <span class="toc-text">依次执行创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析域名-1"><span class="toc-number">6.2.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问-2"><span class="toc-number">6.3.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置认证"><span class="toc-number">6.4.</span> <span class="toc-text">配置认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#签发证书"><span class="toc-number">6.4.1.</span> <span class="toc-text">签发证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查证书"><span class="toc-number">6.4.2.</span> <span class="toc-text">检查证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置nginx"><span class="toc-number">6.4.3.</span> <span class="toc-text">配置nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取kubernetes-dashboard-admin-token"><span class="toc-number">6.4.4.</span> <span class="toc-text">获取kubernetes-dashboard-admin-token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证toke登录"><span class="toc-number">6.4.5.</span> <span class="toc-text">验证toke登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#升级dashboard为v1-10-1"><span class="toc-number">6.4.6.</span> <span class="toc-text">升级dashboard为v1.10.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dashboard-官方给的rbac-minimal"><span class="toc-number">6.4.7.</span> <span class="toc-text">dashboard 官方给的rbac-minimal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署heapster"><span class="toc-number">6.5.</span> <span class="toc-text">部署heapster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备heapster镜像"><span class="toc-number">6.5.1.</span> <span class="toc-text">准备heapster镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-2"><span class="toc-number">6.5.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-1"><span class="toc-number">6.5.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重启dashboard-可以不重启"><span class="toc-number">6.5.4.</span> <span class="toc-text">重启dashboard(可以不重启)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查-2"><span class="toc-number">6.5.5.</span> <span class="toc-text">检查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes平滑升级"><span class="toc-number">7.</span> <span class="toc-text">Kubernetes平滑升级</span></a></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-3216996.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">XonLab</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Kubernetes部署 Ⅱ</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2020-04-01 10:11:21"><i class="fa-fw far fa-calendar-alt"></i> 发表于 2020-04-01</time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">16.6k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 93 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="前情回顾"><a href="#前情回顾" class="headerlink" title="前情回顾"></a>前情回顾</h1><p>1.使用二进制安装部署K8S的要点：</p>
<ul>
<li>基础设施环境准备好<ul>
<li>centos7.6系统（内核在3.8x以上）</li>
<li>关闭SELinux，关闭firewalld服务</li>
<li>时间同步（chronyd）</li>
<li>调整Base源，epel源</li>
<li>内核优化（文件描述符大小，内核转发，等等。。。）</li>
</ul>
</li>
<li>安装部署bind9内网DNS系统</li>
<li>安装部署docker的私有仓库–harbor</li>
<li>准备证书签发环境–cfssl</li>
<li>安装部署主控节点服务（4个）<ul>
<li>Etd</li>
<li>Apiserver</li>
<li>Controller-manager</li>
<li>Scheduler</li>
</ul>
</li>
<li>安装部署运算节点服务（2个）<ul>
<li>Kubelet</li>
<li>Kube-proxy</li>
</ul>
</li>
</ul>
<p>2.关于cfssl工具：</p>
<ul>
<li>cfssl：证书签发的主要工具</li>
<li>cfssl-json：讲cfssl生成的证书（json格式）变为文件承载式证书</li>
<li>cfssl-certinfo：验证证书的信息</li>
</ul>
<p>把证书<code>apiserver.pem</code>的信息列出来：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 certs]# cfssl-certinfo -cert apiserver.pem </span><br><span class="line">&#123;</span><br><span class="line">  "subject": &#123;</span><br><span class="line">    "common_name": "k8s-apiserver",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "od",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "beijing",</span><br><span class="line">    "province": "beijing",</span><br><span class="line">    "names": [</span><br><span class="line">      "CN",</span><br><span class="line">      "beijing",</span><br><span class="line">      "beijing",</span><br><span class="line">      "od",</span><br><span class="line">      "ops",</span><br><span class="line">      "k8s-apiserver"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "issuer": &#123;</span><br><span class="line">    "common_name": "OldboyEdu",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "od",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "beijing",</span><br><span class="line">    "province": "beijing",</span><br><span class="line">    "names": [</span><br><span class="line">      "CN",</span><br><span class="line">      "beijing",</span><br><span class="line">      "beijing",</span><br><span class="line">      "od",</span><br><span class="line">      "ops",</span><br><span class="line">      "OldboyEdu"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "serial_number": "654380197932285157915575843459046152400709392018",</span><br><span class="line">  "sans": [</span><br><span class="line">    "kubernetes.default",</span><br><span class="line">    "kubernetes.default.svc",</span><br><span class="line">    "kubernetes.default.svc.cluster",</span><br><span class="line">    "kubernetes.default.svc.cluster.local",</span><br><span class="line">    "127.0.0.1",</span><br><span class="line">    "10.96.0.1",</span><br><span class="line">    "192.168.0.1",</span><br><span class="line">    "192.168.6.66",</span><br><span class="line">    "192.168.6.243",</span><br><span class="line">    "192.168.6.244",</span><br><span class="line">    "192.168.6.245"</span><br><span class="line">  ],</span><br><span class="line">  "not_before": "2019-11-18T05:54:00Z",</span><br><span class="line">  "not_after": "2039-11-13T05:54:00Z",</span><br><span class="line">  "sigalg": "SHA256WithRSA",</span><br><span class="line">  "authority_key_id": "72:13:FC:72:0:8:4:A0:5A:90:B2:E2:10:FA:6A:7E:7A:2D:2C:22",</span><br><span class="line">  "subject_key_id": "FC:36:3:9F:2C:D0:9F:D4:1E:F1:A4:56:59:41:A8:29:81:35:38:F7",</span><br><span class="line">  "pem": "-----BEGIN CERTIFICATE-----\nMIIEdTCCA12gAwIBAgIUcp9sROX/bzXK8oiG5ImDB3n8lpIwDQYJKoZIhvcNAQEL\nBQAwYDELMAkGA1UEBhMCQ04xEDAOBgNVBAgTB2JlaWppbmcxEDAOBgNVBAcTB2Jl\naWppbmcxCzAJBgNVBAoTAm9kMQwwCgYDVQQLEwNvcHMxEjAQBgNVBAMTCU9sZGJv\neUVkdTAeFw0xOTExMTgwNTU0MDBaFw0zOTExMTMwNTU0MDBaMGQxCzAJBgNVBAYT\nAkNOMRAwDgYDVQQIEwdiZWlqaW5nMRAwDgYDVQQHEwdiZWlqaW5nMQswCQYDVQQK\nEwJvZDEMMAoGA1UECxMDb3BzMRYwFAYDVQQDEw1rOHMtYXBpc2VydmVyMIIBIjAN\nBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzkm60A1MQiWsPgWHrp4JjJKVFAEP\ndzm+f4ZB3GsZnuiuMo3ypygClwsjDcPZL0+zKaAmwOMxa3cSmbgY8rYkbqGM8Tdd\nBN4ns0pDuwl5EbcMAfyL1ZsgpxctMwtaCO1wR2N6fAhk1BZt6VH7a9ruw83UKfDK\n3W77JxLdcgAEDdaizddQPhOE3W2BMJztLI03PIIQ2yZ3vikfZQjYwZLAWBBDpoOJ\neMm9J3RS0FL8YXTefjG02An4Z1BSTlTDOPogUxxAMAJ1jaaOXSpUSj/qACYpHx7N\n9zgKmkMKby2N+VfJs60MD60jn0CJXALJ1U/lyAieX8KRW3IEW1L/xhVhxwIDAQAB\no4IBITCCAR0wDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMBMAwG\nA1UdEwEB/wQCMAAwHQYDVR0OBBYEFPw2A58s0J/UHvGkVllBqCmBNTj3MB8GA1Ud\nIwQYMBaAFHIT/HIACASgWpCy4hD6an56LSwiMIGnBgNVHREEgZ8wgZyCEmt1YmVy\nbmV0ZXMuZGVmYXVsdIIWa3ViZXJuZXRlcy5kZWZhdWx0LnN2Y4Iea3ViZXJuZXRl\ncy5kZWZhdWx0LnN2Yy5jbHVzdGVygiRrdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNs\ndXN0ZXIubG9jYWyHBH8AAAGHBApgAAGHBMCoAAGHBMCoBkKHBMCoBvOHBMCoBvSH\nBMCoBvUwDQYJKoZIhvcNAQELBQADggEBAAIKX7PJXI5Uj/nn1nfp4M2HTk1m+8OH\nzTwRVy1igM+2ull+S7rXO4MN9Sw16Coov6MyHviWXLWJgGTypOenz+tTQkdjzHLF\nrkDxM6Fu4b5pm4W1H5QQaoFfY7XaCGnoD0Mf3rMsG8Pi5n3e7pb2tw73ebxwHQx7\nnl43fOoRAyDVMmju5BKG8QOA5dfW3qi2BpCCM7KCgSVq/U8URaI3zBm6Mfm7eUnI\nhwnpufar08JCLVtoduKelbdaaBSEmDR+7bl0aQ5YHwAHuQZRxQB4qG+QbiTabuoV\npXATIAmGLqretFGp9rlsvh6kxIKw+NJ8k2DBpzOCzJALCYIbHhv40oA=\n-----END CERTIFICATE-----\n"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查<code>h5.mcake.com</code>域名证书的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 certs]# cfssl-certinfo -domain h5.mcake.com</span><br><span class="line">&#123;</span><br><span class="line">  "subject": &#123;</span><br><span class="line">    "common_name": "h5.mcake.com",</span><br><span class="line">    "names": [</span><br><span class="line">      "h5.mcake.com"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "issuer": &#123;</span><br><span class="line">    "common_name": "Encryption Everywhere DV TLS CA - G1",</span><br><span class="line">    "country": "US",</span><br><span class="line">    "organization": "DigiCert Inc",</span><br><span class="line">    "organizational_unit": "www.digicert.com",</span><br><span class="line">    "names": [</span><br><span class="line">      "US",</span><br><span class="line">      "DigiCert Inc",</span><br><span class="line">      "www.digicert.com",</span><br><span class="line">      "Encryption Everywhere DV TLS CA - G1"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "serial_number": "20945969268560300749908123751452433550",</span><br><span class="line">  "sans": [</span><br><span class="line">    "h5.mcake.com"</span><br><span class="line">  ],</span><br><span class="line">  "not_before": "2019-07-30T00:00:00Z",</span><br><span class="line">  "not_after": "2020-07-29T12:00:00Z",</span><br><span class="line">  "sigalg": "SHA256WithRSA",</span><br><span class="line">  "authority_key_id": "55:74:4F:B2:72:4F:F5:60:BA:50:D1:D7:E6:51:5C:9A:1:87:1A:D7",</span><br><span class="line">  "subject_key_id": "3F:86:11:8A:11:D:24:58:D2:CF:33:58:20:52:4A:A4:AE:94:90:33",</span><br><span class="line">  "pem": "-----BEGIN CERTIFICATE-----\nMIIFgTCCBGmgAwIBAgIQD8IMBHJkmkUGUQ2ohH7cjjANBgkqhkiG9w0BAQsFADBu\nMQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3\nd3cuZGlnaWNlcnQuY29tMS0wKwYDVQQDEyRFbmNyeXB0aW9uIEV2ZXJ5d2hlcmUg\nRFYgVExTIENBIC0gRzEwHhcNMTkwNzMwMDAwMDAwWhcNMjAwNzI5MTIwMDAwWjAX\nMRUwEwYDVQQDEwxoNS5tY2FrZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw\nggEKAoIBAQCar3JOaRYZEehyIH4SACHo+IANki25XaazjJFYT4MUzU8u+fWRe21r\npnlosxT5z4sGyuk6DxhNdPi0e1zLXeEcNGwqDsO5NPf7BWx9u+ljxdlcWXYO/aY8\nCHyuFPwkrKIPqLsLgy47U7Wbm8WamqoF4ywKoCTQnZGfRIWCMzkLgFRP7a0IxUdP\nRtggxSXNjCcSD5KkUJLfSPMPKLR8pZ9pVRczaPj4Y6vLpryxU2HqVecW/+CYZq/a\nkZ3o2LAJo9Z+aNMCMWM0IMXv1teb81/M06qD4OYXLGOWzy/pWXYKA4m+NOj/fJLC\nSLjpLVlkB/CJAQPP0P4+Idqsc5gg+22bAgMBAAGjggJwMIICbDAfBgNVHSMEGDAW\ngBRVdE+yck/1YLpQ0dfmUVyaAYca1zAdBgNVHQ4EFgQUP4YRihENJFjSzzNYIFJK\npK6UkDMwFwYDVR0RBBAwDoIMaDUubWNha2UuY29tMA4GA1UdDwEB/wQEAwIFoDAd\nBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwTAYDVR0gBEUwQzA3BglghkgB\nhv1sAQIwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQ\nUzAIBgZngQwBAgEwgYAGCCsGAQUFBwEBBHQwcjAkBggrBgEFBQcwAYYYaHR0cDov\nL29jc3AuZGlnaWNlcnQuY29tMEoGCCsGAQUFBzAChj5odHRwOi8vY2FjZXJ0cy5k\naWdpY2VydC5jb20vRW5jcnlwdGlvbkV2ZXJ5d2hlcmVEVlRMU0NBLUcxLmNydDAJ\nBgNVHRMEAjAAMIIBBAYKKwYBBAHWeQIEAgSB9QSB8gDwAHYApLkJkLQYWBSHuxOi\nzGdwCjw1mAT5G9+443fNDsgN3BAAAAFsQhPl9AAABAMARzBFAiEAgtcA1rcRVeTf\n3KLO54eXR3sLLDTW3XPLqj+VI+a28IICIBMBVWYIaNERBmejleyMnOoYbHULFEgi\ndi9eHiPT2sXpAHYAXqdz+d9WwOe1Nkh90EngMnqRmgyEoRIShBh1loFxRVgAAAFs\nQhPlLAAABAMARzBFAiAqnY9AE1/zVkYG6R16tO+i3ojXnM3CmBs3iXm6ywI5wQIh\nAN9jpUnfPguDaf9/LBwG8wgx8+6ybeoVv4SUUhUlRbzmMA0GCSqGSIb3DQEBCwUA\nA4IBAQBg/n6IyoEUBiIwikm+vKciqJpbOrL0urqkdTbQIwCbdxHe8s5ewULM8nJ9\n+77voDywIHaj0tLZvKxBmJUQliYKh1hthGY4IxQIsaxRNC/D3/5s2unz1yyTQaPr\n+CU0/xKpUyzh63wzS0w6/IRkXNwCaSwZWvFFR2HHJNQ9Y9NwkmyhCg7Sm2MLBTxj\nVmmjgTt5E47TiuCqYkEdH7KCoPSKh0Z6Jv46Bj0Ls5oFOZKa93QHipuHfuqmF6G/\nAsB9tfS4ATvxBb5hOxpfX6Tyv5cvFRKcAwGJxQ7fq9cuEAvkga7FkFfKD+JxdLuK\nbw3xQzHwX6kEB54Z88C/VRQ1oILw\n-----END CERTIFICATE-----\n"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.关于kubeconfig文件：</p>
<ul>
<li>这是一个K8S用户的配置文件</li>
<li>它里面含有证书信息</li>
<li>证书过期或更换，需要同步替换改文件</li>
</ul>
<p>根据<code>MD5sum</code>计算<code>kubelet.kubeconfig</code>是否一样</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cd /opt/kubernetes/server/bin/conf/</span><br><span class="line">[root@shkf6-243 conf]# md5sum kubelet.kubeconfig </span><br><span class="line">8b2f777f58e4e36d09594db5d1d83ef2  kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# cd /opt/kubernetes/server/bin/conf/</span><br><span class="line">[root@shkf6-244 conf]# md5sum kubelet.kubeconfig </span><br><span class="line">8b2f777f58e4e36d09594db5d1d83ef2  kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>由<code>kubelet.kubeconfig</code>找到证书信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 conf]# cat kubelet.kubeconfig </span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR0RENDQXB5Z0F3SUJBZ0lVTlp2SjFqakpRL1ZXdk1HQ1RZUmRJNFpDRU40d0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lERUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjJKbGFXcHBibWN4RURBT0JnTlZCQWNUQjJKbAphV3BwYm1jeEN6QUpCZ05WQkFvVEFtOWtNUXd3Q2dZRFZRUUxFd052Y0hNeEVqQVFCZ05WQkFNVENVOXNaR0p2CmVVVmtkVEFlRncweE9URXhNVGd3TXpFd01EQmFGdzB6T1RFeE1UTXdNekV3TURCYU1HQXhDekFKQmdOVkJBWVQKQWtOT01SQXdEZ1lEVlFRSUV3ZGlaV2xxYVc1bk1SQXdEZ1lEVlFRSEV3ZGlaV2xxYVc1bk1Rc3dDUVlEVlFRSwpFd0p2WkRFTU1Bb0dBMVVFQ3hNRGIzQnpNUkl3RUFZRFZRUURFd2xQYkdSaWIzbEZaSFV3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNqWUFLaXlJaGIxcDkwUzc4SEY0Y1d5K3BSRWNRZUpVNjEKdFplelFkOVdocjgyY2pMUTlQRmVjMnFqL0Uxb2c3ZmNRZVdpT1pKN2oxczE2RGVHQUZqampVYUVHc1VjQ2VnUAovUmQ5TjRUb0pKT3dJYlJWTlcvWkYvQ21jSGdHdEpjWG8xMDdmVGFYQVdYNXo3SUVlTzNmSUVHZDM5WHFMUFJsClhNdVJHQzBxVklKdmxpNUp3eWhGTS9lNnR0VjdPMFIyZ2lKZUpxZWo0cUFRWXVKaUhVSmtHNW9xM2dvNUVoT04KMW4xS1ZrTDcrT2h5RitCYTVFNzlNWTNzT1E2MWlZM2IwY3BPaE5qWFdLYllNOC9XWUtNUkdDNjhyVEE0WVByWgppL1FZc2RVT0VmSG1HTmh5ai9KakJVMFArZlJzMVIraDBaR0Vac3pJQlRxb0c4dTFNUFJ2QWdNQkFBR2paakJrCk1BNEdBMVVkRHdFQi93UUVBd0lCQmpBU0JnTlZIUk1CQWY4RUNEQUdBUUgvQWdFQ01CMEdBMVVkRGdRV0JCUnkKRS94eUFBZ0VvRnFRc3VJUSttcCtlaTBzSWpBZkJnTlZIU01FR0RBV2dCUnlFL3h5QUFnRW9GcVFzdUlRK21wKwplaTBzSWpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQVc1S3JZVUlWRkx1SGc2MTVuYmVMU2FHaWl0SjZ0VHF4CkRHRmdHb21CbElSUzJiNGNRd1htbWtpend5TVkzakdTcjl3QlgzOEFTV1dWSXBKYk9NZXpLVnJyQkRCMlBUODgKVW5XcUlqVmlNOUJRa2k2WVlRdld1eHo0N2h6cnRzbFRiaHBFREZ2aVlueWcvenMra2l6emY4RmNSOEd4MHdCRAoyc2FvZE1od21WWTloNnhzZSthQzRLbW9ieFB1MWdINUtKRGh5MjZKTitkSkxHTVB2MlVLRmRYb1JzaVlsanBaCmh5bGlTOVJ2dm1jODZ4Vk9UVWlOZnFvTzFza1hiZW1HdHg1QU0zcHNoUzN4NmhLdXQzUUpXSkRUM1dYUXpyQjgKQXdBMy9NWW12aE1FWlUzTExtclo5eERGRmZTeFYzN0JtUmV2MGhwN2dSWGRiblRJVW8yait3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">    server: https://192.168.6.66:7443</span><br><span class="line">  name: myk8s</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: myk8s</span><br><span class="line">    user: k8s-node</span><br><span class="line">  name: myk8s-context</span><br><span class="line">current-context: myk8s-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: k8s-node</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR3akNDQXFxZ0F3SUJBZ0lVSU4wSnJubVlWR1UwNkQyZEE1dFZpUzNYenhvd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lERUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjJKbGFXcHBibWN4RURBT0JnTlZCQWNUQjJKbAphV3BwYm1jeEN6QUpCZ05WQkFvVEFtOWtNUXd3Q2dZRFZRUUxFd052Y0hNeEVqQVFCZ05WQkFNVENVOXNaR0p2CmVVVmtkVEFlRncweE9URXhNVGd3TlRVeU1EQmFGdzB6T1RFeE1UTXdOVFV5TURCYU1GOHhDekFKQmdOVkJBWVQKQWtOT01SQXdEZ1lEVlFRSUV3ZGlaV2xxYVc1bk1SQXdEZ1lEVlFRSEV3ZGlaV2xxYVc1bk1Rc3dDUVlEVlFRSwpFd0p2WkRFTU1Bb0dBMVVFQ3hNRGIzQnpNUkV3RHdZRFZRUURFd2hyT0hNdGJtOWtaVENDQVNJd0RRWUpLb1pJCmh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTW5TeHovdWpVUjhJalBJRzJLL1BNeTIxY244ZVo0eVl0eG0KTERGcDdkYjJXcVNVRjFKSEV4VWRyVGZLcGF4TXFESCt3N01mR0F1YXFHNnA2Tm1RS1dUK1QrS1lQeW1KTkRNSAo5L25NTnFMOGFoT1lCNFFFVWZLbnRLRHNRSENDb0RhUG5nbkwySDJLZS8rZGJrTThPUXBRSU9MdkJnRmdjUENnCmR2S1hBOGtUOGY1RXZVUUhMZEdrZXJxTTZ2TFhkdlEweCtSS3RQMFhwajhxRCs3azIxNVNBZXJzQmVOZExXS2MKaUFkUWhBUmg2VUNYb2lzL1k1ZXBOeDYrMWhmQlg5QTYycnNuZCtzcTByQ1puSFh1cVY1eEVMbnBaMmIwemVxQwpnTzVObksyaGJ0Z1BQdkc3d2NwV24wU1ZHb3IweUExMXBBeUpaMzNIY2NKQWQ0Wi9uUnNDQXdFQUFhTjFNSE13CkRnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dBUVVGQndNQ01Bd0dBMVVkRXdFQi93UUMKTUFBd0hRWURWUjBPQkJZRUZPQkQySlVMYWNNekJzUmxWRXBJRUZjYUhoMlpNQjhHQTFVZEl3UVlNQmFBRkhJVAovSElBQ0FTZ1dwQ3k0aEQ2YW41NkxTd2lNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUNVd0p0Zk4xdzlXT05VCmZlbnFnVW80Ukk1blM4Zzdla1lhUytyQjBnVTFBL0NKZ2lRaWZyMC9zS0xRd29YY1FjZFpTNFhtUHcvY05tNVcKRlUwdnRTODhPL2k0N1RFYzV3NWtZZkNYemR3NHhZeVFIVHhyQkk5RUVRMGxkeUdsY293cUk0RGVFeUZ4d3o3bApsUnNZMmNPS3hZQmpjSENjb29oMUJkaEhHZVI1SXB2Nks1SEJmNWtweURKUGs1NXZwMTRIdzRkTDlMNFE4R2JZCjI1bDhKWE95ampGdGVDZmdUTkFmZnhTYmpCR0hLK2UreGRGU1V1eUc5WG9FSEJNc2l1L2o0QUsvb0tiRXNteUgKMFpYdit0c2FlWkd4Ukpyb3BVWldFOXNPU0NxQ0ZEWWl3dkZmSmhnRENzbFZHRmdFc3FoY1JTVHdWUTNDeVh5bApWS25XTTFEOAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBeWRMSFArNk5SSHdpTThnYllyODh6TGJWeWZ4NW5qSmkzR1lzTVdudDF2WmFwSlFYClVrY1RGUjJ0TjhxbHJFeW9NZjdEc3g4WUM1cW9icW5vMlpBcFpQNVA0cGcvS1lrME13ZjMrY3cyb3Z4cUU1Z0gKaEFSUjhxZTBvT3hBY0lLZ05vK2VDY3ZZZllwNy81MXVRenc1Q2xBZzR1OEdBV0J3OEtCMjhwY0R5UlB4L2tTOQpSQWN0MGFSNnVvenE4dGQyOURUSDVFcTAvUmVtUHlvUDd1VGJYbElCNnV3RjQxMHRZcHlJQjFDRUJHSHBRSmVpCkt6OWpsNmszSHI3V0Y4RmYwRHJhdXlkMzZ5clNzSm1jZGU2cFhuRVF1ZWxuWnZUTjZvS0E3azJjcmFGdTJBOCsKOGJ2QnlsYWZSSlVhaXZUSURYV2tESWxuZmNkeHdrQjNobitkR3dJREFRQUJBb0lCQUYyN1U2aGdmU0Z5V1Z3ZApNb0xRK0ViSEgxRTR2YTc0RGF2NGs4dTdPNmViTUl2QTczZlo1SVhwQzNxZTFnVEljVkVPMWdySmhSeFdqcVVlCnFqTG8zaUMyYjVsNFJkVmZrR3VtNXNjUHpjd3lXSDJUSE9KMk15ejBNRktRaG5qNlliZ1ZTVHVaZllrSW1RQWwKT0lGblpjSmhablNldC9aSnVRbzRMQ1lNZHNpYWM4Vis2dk1CdWtiL2pwL2JXT1F4aFM4MmtPREdaa3BaTDVFVgorR3NyeGFTaDB6aHpkaGlnSk5TRWR0S1lsR0xOUVdwU3ZscXNoMDhtNlRQWld4UkdzaDB4TG51ckkzeWJnZkJxCittWXRPUEh5dUZqeWlCZno4OHJEWUtYKytweTJwUzB5VGVrbHdtSW9NVk9SaGdDVG9sNkt3RENZeGQxVXJ4UE4KSWUyL3Joa0NnWUVBejRKU2EweU5sZGtudEhQSFVTQkNXOWIxYlF0NFRlV1NIWEppUU1ZWXVUUnlUZWZkeTEyTwp0RTE3c1ljWlU0Mkh4UitzTTBFenFka3kydWl5ZzdCME1ibmY3UXJYU0Q4YlhLNVZBbXVKd1Jxc1pJMXhldG9PCnJhcGttc09GWXVVT1BMU2d2UEVOVGJTckQ2d1U3eDFFUWU1L2xrWlgyeWg1UmpuTmJmdENtK1VDZ1lFQStQeFMKemlsVUh2M2xubGFpaWMzSTZkSVpWQ3lmK3JRdGJvb0FwVEF1TklNM3pzWFlKcDg0MVJNUXJZZ0FLRkhEY0VJbwphaFU2V011U3JTclFvNndDNXB6M3dsL1JCWlAvUWRRclF1L1lLd2RCVi9XQk9kM3Z6eGpObjIvN0plbE1ueUt2Ci9sZ29IcTZTN2hPUGdaUmg0aHZLRFBqazdoLzU1ZzQ2NDVIdnhQOENnWUVBcHd6Yit1TkM3QXBJYTMzMVREcnoKRU9vbzQ2TWpNMXFIMlVyWERCd3RsUk5DbmJMMm01dnlvUFhyaVF3Z2VHSHNsZVdjaEJxT1U4SzFyUU05aXNSSApsaXh6dDJsTnpDeDVnNUFZZ1gwL0JZVEttWnhBYWMwWG1ma2RTblh5Y0ozRGExMWlOUmk5US93WTVlSDdiRStjClBwT1loTXFXT2FrSWtGOUNJTEx3ZVgwQ2dZRUFoeG9iTUdTNmtZcUJVdFo5b2JxNDN5OHlzVHI1bjhhdXRFRkwKc2xhZmE3MGJ4aVlTY0hxTEV3c2lUSmIwUnV4KzJPWDlHZnJreXhQRFJoVnFXclZXYVo0WXppN0JzMzRuenFkNgp4ZnB3MklBNlU2a1NjcnpiaUF0VVg4UWFpZXE2dWNyUHBucGRZckNsWjJ2VHZhTXZMY3FZYTB1T3BTdFNwU05wCmp0dzhOeThDZ1lBdk9VKzJpYnphYXNNL3BjUHp3TStCWERub0NrcTdrdk4wRjh5dDJFdmJkUFlIMWc4UGVwa0cKWDYxTXIxVVQ2bVQ1ZC9HeTcrOXhOd2FGZzZENFk5VW5DUTBlU3lWL1plUWpGSGZtQS8rUUUxUy82K0pib1J4MwpQMUVsZ2psN0RXU3RodkJsYmhWYjdYc2MyTGhSMUR2RFJmUURqWE1MRWdvNC9LUXJULzRqd3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 certs]# echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR3akNDQXFxZ0F3SUJBZ0lVSU4wSnJubVlWR1UwNkQyZEE1dFZpUzNYenhvd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lERUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjJKbGFXcHBibWN4RURBT0JnTlZCQWNUQjJKbAphV3BwYm1jeEN6QUpCZ05WQkFvVEFtOWtNUXd3Q2dZRFZRUUxFd052Y0hNeEVqQVFCZ05WQkFNVENVOXNaR0p2CmVVVmtkVEFlRncweE9URXhNVGd3TlRVeU1EQmFGdzB6T1RFeE1UTXdOVFV5TURCYU1GOHhDekFKQmdOVkJBWVQKQWtOT01SQXdEZ1lEVlFRSUV3ZGlaV2xxYVc1bk1SQXdEZ1lEVlFRSEV3ZGlaV2xxYVc1bk1Rc3dDUVlEVlFRSwpFd0p2WkRFTU1Bb0dBMVVFQ3hNRGIzQnpNUkV3RHdZRFZRUURFd2hyT0hNdGJtOWtaVENDQVNJd0RRWUpLb1pJCmh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTW5TeHovdWpVUjhJalBJRzJLL1BNeTIxY244ZVo0eVl0eG0KTERGcDdkYjJXcVNVRjFKSEV4VWRyVGZLcGF4TXFESCt3N01mR0F1YXFHNnA2Tm1RS1dUK1QrS1lQeW1KTkRNSAo5L25NTnFMOGFoT1lCNFFFVWZLbnRLRHNRSENDb0RhUG5nbkwySDJLZS8rZGJrTThPUXBRSU9MdkJnRmdjUENnCmR2S1hBOGtUOGY1RXZVUUhMZEdrZXJxTTZ2TFhkdlEweCtSS3RQMFhwajhxRCs3azIxNVNBZXJzQmVOZExXS2MKaUFkUWhBUmg2VUNYb2lzL1k1ZXBOeDYrMWhmQlg5QTYycnNuZCtzcTByQ1puSFh1cVY1eEVMbnBaMmIwemVxQwpnTzVObksyaGJ0Z1BQdkc3d2NwV24wU1ZHb3IweUExMXBBeUpaMzNIY2NKQWQ0Wi9uUnNDQXdFQUFhTjFNSE13CkRnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dBUVVGQndNQ01Bd0dBMVVkRXdFQi93UUMKTUFBd0hRWURWUjBPQkJZRUZPQkQySlVMYWNNekJzUmxWRXBJRUZjYUhoMlpNQjhHQTFVZEl3UVlNQmFBRkhJVAovSElBQ0FTZ1dwQ3k0aEQ2YW41NkxTd2lNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUNVd0p0Zk4xdzlXT05VCmZlbnFnVW80Ukk1blM4Zzdla1lhUytyQjBnVTFBL0NKZ2lRaWZyMC9zS0xRd29YY1FjZFpTNFhtUHcvY05tNVcKRlUwdnRTODhPL2k0N1RFYzV3NWtZZkNYemR3NHhZeVFIVHhyQkk5RUVRMGxkeUdsY293cUk0RGVFeUZ4d3o3bApsUnNZMmNPS3hZQmpjSENjb29oMUJkaEhHZVI1SXB2Nks1SEJmNWtweURKUGs1NXZwMTRIdzRkTDlMNFE4R2JZCjI1bDhKWE95ampGdGVDZmdUTkFmZnhTYmpCR0hLK2UreGRGU1V1eUc5WG9FSEJNc2l1L2o0QUsvb0tiRXNteUgKMFpYdit0c2FlWkd4Ukpyb3BVWldFOXNPU0NxQ0ZEWWl3dkZmSmhnRENzbFZHRmdFc3FoY1JTVHdWUTNDeVh5bApWS25XTTFEOAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="|base64 -d  &gt; 123.pem</span><br><span class="line">[root@shkf6-245 certs]# cfssl-certinfo -cert 123.pem </span><br><span class="line">&#123;</span><br><span class="line">  "subject": &#123;</span><br><span class="line">    "common_name": "k8s-node",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "od",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "beijing",</span><br><span class="line">    "province": "beijing",</span><br><span class="line">    "names": [</span><br><span class="line">      "CN",</span><br><span class="line">      "beijing",</span><br><span class="line">      "beijing",</span><br><span class="line">      "od",</span><br><span class="line">      "ops",</span><br><span class="line">      "k8s-node"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "issuer": &#123;</span><br><span class="line">    "common_name": "OldboyEdu",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "od",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "beijing",</span><br><span class="line">    "province": "beijing",</span><br><span class="line">    "names": [</span><br><span class="line">      "CN",</span><br><span class="line">      "beijing",</span><br><span class="line">      "beijing",</span><br><span class="line">      "od",</span><br><span class="line">      "ops",</span><br><span class="line">      "OldboyEdu"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "serial_number": "187617012736570890928549677433593587138601406234",</span><br><span class="line">  "not_before": "2019-11-18T05:52:00Z",</span><br><span class="line">  "not_after": "2039-11-13T05:52:00Z",</span><br><span class="line">  "sigalg": "SHA256WithRSA",</span><br><span class="line">  "authority_key_id": "72:13:FC:72:0:8:4:A0:5A:90:B2:E2:10:FA:6A:7E:7A:2D:2C:22",</span><br><span class="line">  "subject_key_id": "E0:43:D8:95:B:69:C3:33:6:C4:65:54:4A:48:10:57:1A:1E:1D:99",</span><br><span class="line">  "pem": "-----BEGIN CERTIFICATE-----\nMIIDwjCCAqqgAwIBAgIUIN0JrnmYVGU06D2dA5tViS3XzxowDQYJKoZIhvcNAQEL\nBQAwYDELMAkGA1UEBhMCQ04xEDAOBgNVBAgTB2JlaWppbmcxEDAOBgNVBAcTB2Jl\naWppbmcxCzAJBgNVBAoTAm9kMQwwCgYDVQQLEwNvcHMxEjAQBgNVBAMTCU9sZGJv\neUVkdTAeFw0xOTExMTgwNTUyMDBaFw0zOTExMTMwNTUyMDBaMF8xCzAJBgNVBAYT\nAkNOMRAwDgYDVQQIEwdiZWlqaW5nMRAwDgYDVQQHEwdiZWlqaW5nMQswCQYDVQQK\nEwJvZDEMMAoGA1UECxMDb3BzMREwDwYDVQQDEwhrOHMtbm9kZTCCASIwDQYJKoZI\nhvcNAQEBBQADggEPADCCAQoCggEBAMnSxz/ujUR8IjPIG2K/PMy21cn8eZ4yYtxm\nLDFp7db2WqSUF1JHExUdrTfKpaxMqDH+w7MfGAuaqG6p6NmQKWT+T+KYPymJNDMH\n9/nMNqL8ahOYB4QEUfKntKDsQHCCoDaPngnL2H2Ke/+dbkM8OQpQIOLvBgFgcPCg\ndvKXA8kT8f5EvUQHLdGkerqM6vLXdvQ0x+RKtP0Xpj8qD+7k215SAersBeNdLWKc\niAdQhARh6UCXois/Y5epNx6+1hfBX9A62rsnd+sq0rCZnHXuqV5xELnpZ2b0zeqC\ngO5NnK2hbtgPPvG7wcpWn0SVGor0yA11pAyJZ33HccJAd4Z/nRsCAwEAAaN1MHMw\nDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAwGA1UdEwEB/wQC\nMAAwHQYDVR0OBBYEFOBD2JULacMzBsRlVEpIEFcaHh2ZMB8GA1UdIwQYMBaAFHIT\n/HIACASgWpCy4hD6an56LSwiMA0GCSqGSIb3DQEBCwUAA4IBAQCUwJtfN1w9WONU\nfenqgUo4RI5nS8g7ekYaS+rB0gU1A/CJgiQifr0/sKLQwoXcQcdZS4XmPw/cNm5W\nFU0vtS88O/i47TEc5w5kYfCXzdw4xYyQHTxrBI9EEQ0ldyGlcowqI4DeEyFxwz7l\nlRsY2cOKxYBjcHCcooh1BdhHGeR5Ipv6K5HBf5kpyDJPk55vp14Hw4dL9L4Q8GbY\n25l8JXOyjjFteCfgTNAffxSbjBGHK+e+xdFSUuyG9XoEHBMsiu/j4AK/oKbEsmyH\n0ZXv+tsaeZGxRJropUZWE9sOSCqCFDYiwvFfJhgDCslVGFgEsqhcRSTwVQ3CyXyl\nVKnWM1D8\n-----END CERTIFICATE-----\n"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="kubectl命令工具使用详解"><a href="#kubectl命令工具使用详解" class="headerlink" title="kubectl命令工具使用详解"></a>kubectl命令工具使用详解</h1><p>管理K8S核心资源的三种基本方法：</p>
<ul>
<li>陈述式管理方法–主要依赖命令行CLI工具进行管理</li>
<li>声明式管理方法–主要依赖统一资源配置清单（manifest）进行管理</li>
<li>GUI式管理方法–主要依赖图形化操作界面（web页面）进行管理</li>
</ul>
<h2 id="陈述式资源管理方法"><a href="#陈述式资源管理方法" class="headerlink" title="陈述式资源管理方法"></a>陈述式资源管理方法</h2><h3 id="管理名称空间"><a href="#管理名称空间" class="headerlink" title="管理名称空间"></a>管理名称空间</h3><ul>
<li>查看名称空间</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get namespaces</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   25h</span><br><span class="line">kube-node-lease   Active   25h</span><br><span class="line">kube-public       Active   25h</span><br><span class="line">kube-system       Active   25h</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   25h</span><br><span class="line">kube-node-lease   Active   25h</span><br><span class="line">kube-public       Active   25h</span><br><span class="line">kube-system       Active   25h</span><br></pre></td></tr></table></figure>

<ul>
<li>查看名称空间内的资源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get all -n default</span><br><span class="line">NAME                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-ds-2692m   1/1     Running   0          104m</span><br><span class="line">pod/nginx-ds-gf6hs   1/1     Running   0          104m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   25h</span><br><span class="line"></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/nginx-ds   2         2         2       2            2           &lt;none&gt;          104m</span><br></pre></td></tr></table></figure>

<ul>
<li>创建名称空间</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create namespace app</span><br><span class="line">namespace/app created</span><br></pre></td></tr></table></figure>

<ul>
<li>删除名称空间</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl delete namespace app</span><br><span class="line">namespace "app" deleted</span><br></pre></td></tr></table></figure>

<h3 id="管理deployment资源"><a href="#管理deployment资源" class="headerlink" title="管理deployment资源"></a>管理deployment资源</h3><ul>
<li>创建deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span><br><span class="line">deployment.apps/nginx-dp created</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看deployment</p>
<ul>
<li><p>简单查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get deploy -n kube-public</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-dp   1/1     1            1           5m10s</span><br></pre></td></tr></table></figure>
</li>
<li><p>扩展查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get deployment -o wide -n kube-public</span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                              SELECTOR</span><br><span class="line">nginx-dp   1/1     1            1           5m21s   nginx        harbor.od.com/public/nginx:v1.7.9   app=nginx-dp</span><br></pre></td></tr></table></figure>
</li>
<li><p>详细查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl describe deployment nginx-dp -n kube-public</span><br><span class="line">Name:                   nginx-dp</span><br><span class="line">Namespace:              kube-public</span><br><span class="line">CreationTimestamp:      Tue, 19 Nov 2019 15:58:10 +0800</span><br><span class="line">Labels:                 app=nginx-dp</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>查看pod资源</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get pods -n kube-public</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dp-5dfc689474-lz5lz   1/1     Running   0          28m</span><br></pre></td></tr></table></figure>

<ul>
<li>进入pod资源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl exec -it nginx-dp-5dfc689474-lz5lz bash -n kube-public</span><br><span class="line">root@nginx-dp-5dfc689474-lz5lz:/# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ac:06:f3:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.6.243.3/24 brd 172.6.243.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然你也可以docker exec进入容器</p>
</blockquote>
<ul>
<li>删除pod资源（重启）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl delete pod nginx-dp-5dfc689474-lz5lz -n kube-public</span><br><span class="line">pod "nginx-dp-5dfc689474-lz5lz" deleted</span><br><span class="line">[root@shkf6-243 ~]# kubectl get pod  -n kube-public</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-dp-5dfc689474-vtrwj   1/1     Running   0          21s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用watch观察pod重建状态变化<br>强制删除参数： <code>--force --grace-period=0</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# watch -n 1 &#39;kubectl describe deployment nginx-dp -n kube-public|grep -C 5 Event&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl delete deployment nginx-dp -n kube-public</span><br><span class="line">deployment.extensions "nginx-dp" deleted</span><br><span class="line">[root@shkf6-243 ~]# kubectl get deployment -n kube-public</span><br><span class="line">No resources found.</span><br><span class="line">[root@shkf6-243 ~]# kubectl get pods -n kube-public</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>

<h3 id="管理service资源"><a href="#管理service资源" class="headerlink" title="管理service资源"></a>管理service资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span><br><span class="line">deployment.apps/nginx-dp created</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl get all -n kube-public</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-dp-5dfc689474-z5rfh   1/1     Running   0          44m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-dp   1/1     1            1           44m</span><br><span class="line"></span><br><span class="line">NAME                                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-dp-5dfc689474   1         1         1       44m</span><br></pre></td></tr></table></figure>

<ul>
<li>创建service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl expose deployment nginx-dp --port=80 -n kube-public</span><br><span class="line">service/nginx-dp exposed</span><br></pre></td></tr></table></figure>

<p>查看一下代码查看规律，增加一个副本，两个副本，三个副本，ipvs变化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get service -n kube-public</span><br><span class="line">NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-dp   ClusterIP   10.102.187.18   &lt;none&gt;        80/TCP    54s</span><br><span class="line">[root@shkf6-243 ~]# kubectl get svc -n kube-public</span><br><span class="line">NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-dp   ClusterIP   10.102.187.18   &lt;none&gt;        80/TCP    58s</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.102.187.18:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0 </span></span><br><span class="line">[root@shkf6-243 ~]# kubectl scale deployment nginx-dp --replicas=2 -n kube-public</span><br><span class="line">deployment.extensions/nginx-dp scaled</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.102.187.18:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:80               Masq    1      0          0  </span></span><br><span class="line">[root@shkf6-243 ~]# kubectl scale deployment nginx-dp --replicas=3 -n kube-public</span><br><span class="line">deployment.extensions/nginx-dp scaled</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.102.187.18:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.4:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:80               Masq    1      0          0</span></span><br></pre></td></tr></table></figure>

<p>说明：这里删除了svc这里的ipvs策略还在，需要用<code>ipvsadm -D -t</code>清理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0                 </span></span><br><span class="line">TCP  10.96.1.83:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.4:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:80               Masq    1      0          0         </span></span><br><span class="line">TCP  10.102.187.18:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.4:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:80               Masq    1      0          0         </span></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -t  10.102.187.18:80</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.1.83:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.4:80               Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:80               Masq    1      0          0</span></span><br></pre></td></tr></table></figure>

<p>陈述式有局限性，不能给daemonset创建service，有局限性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl expose daemonset nginx-ds --port=880</span><br><span class="line">error: cannot expose a DaemonSet.extensions</span><br></pre></td></tr></table></figure>

<ul>
<li>查看service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl describe svc nginx-dp -n kube-public</span><br><span class="line">Name:              nginx-dp</span><br><span class="line">Namespace:         kube-public</span><br><span class="line">Labels:            app=nginx-dp</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=nginx-dp</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.102.187.18</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         172.6.243.3:80,172.6.243.4:80,172.6.244.3:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="kubectl用法总结"><a href="#kubectl用法总结" class="headerlink" title="kubectl用法总结"></a>kubectl用法总结</h3><p>陈述式资源管理方法小结：</p>
<ul>
<li>kubernetes集群管理集群资源的唯一入口是通过相应的方法调用apiserver的接口</li>
<li>kubulet是官方的CLI命令行工具，用于与apiserver进行通信，将用户在命令行输入的命令，组织并转化为apiserver能识别的信息，进而实现管理k8s各种资源的一种有效途径</li>
<li>kubectl的命令大全<ul>
<li>kubectl –help</li>
<li><a href="http://docs.kubernetes.org.cn/" target="_blank" rel="noopener">http://docs.kubernetes.org.cn/</a></li>
</ul>
</li>
<li>陈述式资源管理方法可以满足90%以上的资源需求，但它的缺点也很明显<ul>
<li>命令冗长、复杂、难以记忆</li>
<li>特定场景下，无法实现管理需求</li>
<li>对资源的增、删、查操作比较容易，改就很痛苦了</li>
</ul>
</li>
</ul>
<p>声明式资源管理小结：</p>
<ul>
<li>声明式资源管理方法，依赖于统一资源配置清单文件对资源进行管理</li>
<li>对资源的管理，是通过事先定义在统一资源配置清单内，在通过陈述式命令应用到K8S集群里</li>
<li>语法格式：kubectl create/apply/delete -f /path/to/yaml</li>
<li>资源配置清单的学习方法：<ul>
<li>tip1：多看别人（官方）写的，能读懂</li>
<li>tip2：能照着现成的文件改着用</li>
<li>tip3：遇到不懂的，善用kubectl explain..查</li>
<li>tip4：初学切记上来就无中生有，自己憋着写</li>
</ul>
</li>
</ul>
<h2 id="声明式资源管理方法"><a href="#声明式资源管理方法" class="headerlink" title="声明式资源管理方法"></a>声明式资源管理方法</h2><p>声明式资源管理方法</p>
<ul>
<li>声明式资源管理方法依赖于—资源配置清单（yaml/json）</li>
<li>查看资源配置清单的方法<ul>
<li>~]# kubectl get svc nginx-dp -o yaml -n kube-public</li>
</ul>
</li>
<li>解释资源配置清单<ul>
<li>~]# kubectl explain service</li>
</ul>
</li>
<li>创建资源配置清单<ul>
<li>~]# vi /root/nginx-ds-svc.yaml</li>
</ul>
</li>
<li>应用资源配置清单<ul>
<li>~]# kubectl apply -f nginx-ds-svc.yaml</li>
</ul>
</li>
<li>修改资源配置清单并应用<ul>
<li>在线修改</li>
<li>离线修改</li>
</ul>
</li>
<li>删除资源配置清单<ul>
<li>陈述式</li>
<li>声明式</li>
</ul>
</li>
</ul>
<h3 id="陈述式资源管理方法的局限性"><a href="#陈述式资源管理方法的局限性" class="headerlink" title="陈述式资源管理方法的局限性"></a>陈述式资源管理方法的局限性</h3><ul>
<li>命令冗长、复杂、难以记忆</li>
<li>特定场景下，无法实现管理需求</li>
<li>对资源的增、删、查操作比较容易，改就很痛苦了</li>
</ul>
<h3 id="查看资源配置清单"><a href="#查看资源配置清单" class="headerlink" title="查看资源配置清单"></a>查看资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get svc nginx-dp -o yaml -n kube-public</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: "2019-11-20T00:38:32Z"</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-dp</span><br><span class="line">  name: nginx-dp</span><br><span class="line">  namespace: kube-public</span><br><span class="line">  resourceVersion: "218290"</span><br><span class="line">  selfLink: /api/v1/namespaces/kube-public/services/nginx-dp</span><br><span class="line">  uid: d48e3085-cea5-41ad-afe2-259c80524d9d</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.96.1.70</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-dp</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解释资源配置清单"><a href="#解释资源配置清单" class="headerlink" title="解释资源配置清单"></a>解释资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl explain service.metadata</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: metadata &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Standard object's metadata. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata</span><br><span class="line"></span><br><span class="line">     ObjectMeta is metadata that all persisted resources must have, which</span><br><span class="line">     includes all objects users must create.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   annotations    &lt;map[string]string&gt;</span><br><span class="line">     Annotations is an unstructured key value map stored with a resource that</span><br><span class="line">     may be set by external tools to store and retrieve arbitrary metadata. They</span><br><span class="line">     are not queryable and should be preserved when modifying objects. More</span><br><span class="line">     info: http://kubernetes.io/docs/user-guide/annotations</span><br><span class="line"></span><br><span class="line">   clusterName    &lt;string&gt;</span><br><span class="line">     The name of the cluster which the object belongs to. This is used to</span><br><span class="line">     distinguish resources with same name and namespace in different clusters.</span><br><span class="line">     This field is not set anywhere right now and apiserver is going to ignore</span><br><span class="line">     it if set in create or update request.</span><br><span class="line"></span><br><span class="line">   creationTimestamp    &lt;string&gt;</span><br><span class="line">     CreationTimestamp is a timestamp representing the server time when this</span><br><span class="line">     object was created. It is not guaranteed to be set in happens-before order</span><br><span class="line">     across separate operations. Clients may not set this value. It is</span><br><span class="line">     represented in RFC3339 form and is in UTC. Populated by the system.</span><br><span class="line">     Read-only. Null for lists. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata</span><br><span class="line"></span><br><span class="line">   deletionGracePeriodSeconds    &lt;integer&gt;</span><br><span class="line">     Number of seconds allowed for this object to gracefully terminate before it</span><br><span class="line">     will be removed from the system. Only set when deletionTimestamp is also</span><br><span class="line">     set. May only be shortened. Read-only.</span><br><span class="line"></span><br><span class="line">   deletionTimestamp    &lt;string&gt;</span><br><span class="line">     DeletionTimestamp is RFC 3339 date and time at which this resource will be</span><br><span class="line">     deleted. This field is set by the server when a graceful deletion is</span><br><span class="line">     requested by the user, and is not directly settable by a client. The</span><br><span class="line">     resource is expected to be deleted (no longer visible from resource lists,</span><br><span class="line">     and not reachable by name) after the time in this field, once the</span><br><span class="line">     finalizers list is empty. As long as the finalizers list contains items,</span><br><span class="line">     deletion is blocked. Once the deletionTimestamp is set, this value may not</span><br><span class="line">     be unset or be set further into the future, although it may be shortened or</span><br><span class="line">     the resource may be deleted prior to this time. For example, a user may</span><br><span class="line">     request that a pod is deleted in 30 seconds. The Kubelet will react by</span><br><span class="line">     sending a graceful termination signal to the containers in the pod. After</span><br><span class="line">     that 30 seconds, the Kubelet will send a hard termination signal (SIGKILL)</span><br><span class="line">     to the container and after cleanup, remove the pod from the API. In the</span><br><span class="line">     presence of network partitions, this object may still exist after this</span><br><span class="line">     timestamp, until an administrator or automated process can determine the</span><br><span class="line">     resource is fully terminated. If not set, graceful deletion of the object</span><br><span class="line">     has not been requested. Populated by the system when a graceful deletion is</span><br><span class="line">     requested. Read-only. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata</span><br><span class="line"></span><br><span class="line">   finalizers    &lt;[]string&gt;</span><br><span class="line">     Must be empty before the object is deleted from the registry. Each entry is</span><br><span class="line">     an identifier for the responsible component that will remove the entry from</span><br><span class="line">     the list. If the deletionTimestamp of the object is non-nil, entries in</span><br><span class="line">     this list can only be removed.</span><br><span class="line"></span><br><span class="line">   generateName    &lt;string&gt;</span><br><span class="line">     GenerateName is an optional prefix, used by the server, to generate a</span><br><span class="line">     unique name ONLY IF the Name field has not been provided. If this field is</span><br><span class="line">     used, the name returned to the client will be different than the name</span><br><span class="line">     passed. This value will also be combined with a unique suffix. The provided</span><br><span class="line">     value has the same validation rules as the Name field, and may be truncated</span><br><span class="line">     by the length of the suffix required to make the value unique on the</span><br><span class="line">     server. If this field is specified and the generated name exists, the</span><br><span class="line">     server will NOT return a 409 - instead, it will either return 201 Created</span><br><span class="line">     or 500 with Reason ServerTimeout indicating a unique name could not be</span><br><span class="line">     found in the time allotted, and the client should retry (optionally after</span><br><span class="line">     the time indicated in the Retry-After header). Applied only if Name is not</span><br><span class="line">     specified. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#idempotency</span><br><span class="line"></span><br><span class="line">   generation    &lt;integer&gt;</span><br><span class="line">     A sequence number representing a specific generation of the desired state.</span><br><span class="line">     Populated by the system. Read-only.</span><br><span class="line"></span><br><span class="line">   initializers    &lt;Object&gt;</span><br><span class="line">     An initializer is a controller which enforces some system invariant at</span><br><span class="line">     object creation time. This field is a list of initializers that have not</span><br><span class="line">     yet acted on this object. If nil or empty, this object has been completely</span><br><span class="line">     initialized. Otherwise, the object is considered uninitialized and is</span><br><span class="line">     hidden (in list/watch and get calls) from clients that haven't explicitly</span><br><span class="line">     asked to observe uninitialized objects. When an object is created, the</span><br><span class="line">     system will populate this list with the current set of initializers. Only</span><br><span class="line">     privileged users may set or modify this list. Once it is empty, it may not</span><br><span class="line">     be modified further by any user. DEPRECATED - initializers are an alpha</span><br><span class="line">     field and will be removed in v1.15.</span><br><span class="line"></span><br><span class="line">   labels    &lt;map[string]string&gt;</span><br><span class="line">     Map of string keys and values that can be used to organize and categorize</span><br><span class="line">     (scope and select) objects. May match selectors of replication controllers</span><br><span class="line">     and services. More info: http://kubernetes.io/docs/user-guide/labels</span><br><span class="line"></span><br><span class="line">   managedFields    &lt;[]Object&gt;</span><br><span class="line">     ManagedFields maps workflow-id and version to the set of fields that are</span><br><span class="line">     managed by that workflow. This is mostly for internal housekeeping, and</span><br><span class="line">     users typically shouldn't need to set or understand this field. A workflow</span><br><span class="line">     can be the user's name, a controller's name, or the name of a specific</span><br><span class="line">     apply path like "ci-cd". The set of fields is always in the version that</span><br><span class="line">     the workflow used when modifying the object. This field is alpha and can be</span><br><span class="line">     changed or removed without notice.</span><br><span class="line"></span><br><span class="line">   name    &lt;string&gt;</span><br><span class="line">     Name must be unique within a namespace. Is required when creating</span><br><span class="line">     resources, although some resources may allow a client to request the</span><br><span class="line">     generation of an appropriate name automatically. Name is primarily intended</span><br><span class="line">     for creation idempotence and configuration definition. Cannot be updated.</span><br><span class="line">     More info: http://kubernetes.io/docs/user-guide/identifiers#names</span><br><span class="line"></span><br><span class="line">   namespace    &lt;string&gt;</span><br><span class="line">     Namespace defines the space within each name must be unique. An empty</span><br><span class="line">     namespace is equivalent to the "default" namespace, but "default" is the</span><br><span class="line">     canonical representation. Not all objects are required to be scoped to a</span><br><span class="line">     namespace - the value of this field for those objects will be empty. Must</span><br><span class="line">     be a DNS_LABEL. Cannot be updated. More info:</span><br><span class="line">     http://kubernetes.io/docs/user-guide/namespaces</span><br><span class="line"></span><br><span class="line">   ownerReferences    &lt;[]Object&gt;</span><br><span class="line">     List of objects depended by this object. If ALL objects in the list have</span><br><span class="line">     been deleted, this object will be garbage collected. If this object is</span><br><span class="line">     managed by a controller, then an entry in this list will point to this</span><br><span class="line">     controller, with the controller field set to true. There cannot be more</span><br><span class="line">     than one managing controller.</span><br><span class="line"></span><br><span class="line">   resourceVersion    &lt;string&gt;</span><br><span class="line">     An opaque value that represents the internal version of this object that</span><br><span class="line">     can be used by clients to determine when objects have changed. May be used</span><br><span class="line">     for optimistic concurrency, change detection, and the watch operation on a</span><br><span class="line">     resource or set of resources. Clients must treat these values as opaque and</span><br><span class="line">     passed unmodified back to the server. They may only be valid for a</span><br><span class="line">     particular resource or set of resources. Populated by the system.</span><br><span class="line">     Read-only. Value must be treated as opaque by clients and . More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#concurrency-control-and-consistency</span><br><span class="line"></span><br><span class="line">   selfLink    &lt;string&gt;</span><br><span class="line">     SelfLink is a URL representing this object. Populated by the system.</span><br><span class="line">     Read-only.</span><br><span class="line"></span><br><span class="line">   uid    &lt;string&gt;</span><br><span class="line">     UID is the unique in time and space value for this object. It is typically</span><br><span class="line">     generated by the server on successful creation of a resource and is not</span><br><span class="line">     allowed to change on PUT operations. Populated by the system. Read-only.</span><br><span class="line">     More info: http://kubernetes.io/docs/user-guide/identifiers#uids</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl explain service</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Service is a named abstraction of software service (for example, mysql)</span><br><span class="line">     consisting of local port (for example 3306) that the proxy listens on, and</span><br><span class="line">     the selector that determines which pods will answer requests sent through</span><br><span class="line">     the proxy.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion    &lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources</span><br><span class="line"></span><br><span class="line">   kind    &lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds</span><br><span class="line"></span><br><span class="line">   metadata    &lt;Object&gt;</span><br><span class="line">     Standard object's metadata. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata</span><br><span class="line"></span><br><span class="line">   spec    &lt;Object&gt;</span><br><span class="line">     Spec defines the behavior of a service.</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status</span><br><span class="line"></span><br><span class="line">   status    &lt;Object&gt;</span><br><span class="line">     Most recently observed status of the service. Populated by the system.</span><br><span class="line">     Read-only. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status</span><br></pre></td></tr></table></figure>

<h3 id="创建资源配置清单"><a href="#创建资源配置清单" class="headerlink" title="创建资源配置清单"></a>创建资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# vi /root/nginx-ds-svc.yaml </span><br><span class="line">[root@shkf6-243 ~]# cat /root/nginx-ds-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f /root/nginx-ds-svc.yaml </span><br><span class="line">service/nginx-ds created</span><br></pre></td></tr></table></figure>

<h3 id="修改资源配置清单并应用"><a href="#修改资源配置清单并应用" class="headerlink" title="修改资源配置清单并应用"></a>修改资源配置清单并应用</h3><ul>
<li>离线修改<br>修改nginx-ds-svc.yaml文件，并用<code>kubelet apply -f nginx-ds-svc.yaml</code>文件使之生效。</li>
<li>在线修改<br>直接使用kubectl edit service nginx-ds在线编辑资源配置清单并保存生效</li>
</ul>
<h3 id="删除资源配置清单"><a href="#删除资源配置清单" class="headerlink" title="删除资源配置清单"></a>删除资源配置清单</h3><ul>
<li>陈述式删除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete service nginx-ds -n kube-public</span><br></pre></td></tr></table></figure>

<ul>
<li>声明式删除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="查看并使用Service资源"><a href="#查看并使用Service资源" class="headerlink" title="查看并使用Service资源"></a>查看并使用Service资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   45h   &lt;none&gt;</span><br><span class="line">nginx-ds     ClusterIP   10.96.0.42   &lt;none&gt;        80/TCP    99m   app=nginx-ds</span><br><span class="line">[root@shkf6-244 ~]# curl 10.96.0.42</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@shkf6-244 ~]# kubectl describe svc nginx-ds</span><br><span class="line">Name:              nginx-ds</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app=nginx-ds</span><br><span class="line">Annotations:       kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                     &#123;"apiVersion":"v1","kind":"Service","metadata":&#123;"annotations":&#123;&#125;,"labels":&#123;"app":"nginx-ds"&#125;,"name":"nginx-ds","namespace":"default"&#125;,"spe...</span><br><span class="line">Selector:          app=nginx-ds</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.42</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         172.6.243.2:80,172.6.244.2:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h1 id="kubernetes的CNI网络插件-flannel"><a href="#kubernetes的CNI网络插件-flannel" class="headerlink" title="kubernetes的CNI网络插件-flannel"></a>kubernetes的CNI网络插件-flannel</h1><p>kubernetes设计了网络模型，但却将它的实现交给了网络插件，CNI网络插件最主要的功能就是实现POD资源能够跨宿主机进行通信</p>
<p>常见的网络插件：</p>
<ul>
<li>flannel</li>
<li>calico</li>
<li>contiv</li>
<li>opencontrail</li>
<li>NSX-T</li>
<li>Kube-router</li>
</ul>
<h2 id="集群规划："><a href="#集群规划：" class="headerlink" title="集群规划："></a>集群规划：</h2><table>
<thead>
<tr>
<th align="left">主机名</th>
<th align="left">角色</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">shkf6-243.host.com</td>
<td align="left">flannel</td>
<td align="left">192.168.6.243</td>
</tr>
<tr>
<td align="left">shkf6-244.host.com</td>
<td align="left">flannel</td>
<td align="left">192.168.6.244</td>
</tr>
</tbody></table>
<p>注意：这里部署文档以<code>shkf6-243.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">fiannel官方下载地址</a></p>
<p>shkf6-243.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cd /opt/src/</span><br><span class="line">[root@shkf6-243 src]# wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 src]# mkdir /opt/flannel-v0.11.0</span><br><span class="line">[root@shkf6-243 src]# tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0/</span><br><span class="line">[root@shkf6-243 src]# ln -s /opt/flannel-v0.11.0/ /opt/flannel</span><br></pre></td></tr></table></figure>

<h3 id="最终目录结构"><a href="#最终目录结构" class="headerlink" title="最终目录结构"></a>最终目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# tree /opt -L 2</span><br><span class="line">/opt</span><br><span class="line">├── containerd</span><br><span class="line">│   ├── bin</span><br><span class="line">│   └── lib</span><br><span class="line">├── etcd -&gt; /opt/etcd-v3.1.20/</span><br><span class="line">├── etcd-v3.1.20</span><br><span class="line">│   ├── certs</span><br><span class="line">│   ├── Documentation</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   ├── etcdctl</span><br><span class="line">│   ├── etcd-server-startup.sh</span><br><span class="line">│   ├── README-etcdctl.md</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── READMEv2-etcdctl.md</span><br><span class="line">├── flannel -&gt; /opt/flannel-v0.11.0/</span><br><span class="line">├── flannel-v0.11.0</span><br><span class="line">│   ├── cert</span><br><span class="line">│   ├── flanneld</span><br><span class="line">│   ├── mk-docker-opts.sh</span><br><span class="line">│   └── README.md</span><br><span class="line">├── kubernetes -&gt; /opt/kubernetes-v1.15.2/</span><br><span class="line">├── kubernetes-v1.15.2</span><br><span class="line">│   ├── addons</span><br><span class="line">│   ├── LICENSES</span><br><span class="line">│   └── server</span><br><span class="line">├── rh</span><br><span class="line">└── src</span><br><span class="line">    ├── etcd-v3.1.20-linux-amd64.tar.gz</span><br><span class="line">    ├── flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line">    └── kubernetes-server-linux-amd64-v1.15.2.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 src]# mkdir /opt/flannel/cert/</span><br><span class="line">[root@shkf6-243 src]# cd /opt/flannel/cert/</span><br><span class="line">[root@shkf6-243 flannel]# scp -P52113 shkf6-245:/opt/certs/ca.pem /opt/flannel/cert/</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# scp -P52113 shkf6-245:/opt/certs/client.pem /opt/flannel/cert/</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# scp -P52113 shkf6-245:/opt/certs/client-key.pem /opt/flannel/cert/</span><br></pre></td></tr></table></figure>

<h3 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# vi subnet.env</span><br><span class="line">[root@shkf6-243 flannel]# cat subnet.env</span><br><span class="line">FLANNEL_NETWORK=172.6.0.0/16</span><br><span class="line">FLANNEL_SUBNET=172.6.243.1/24</span><br><span class="line">FLANNEL_MTU=1500</span><br><span class="line">FLANNEL_IPMASQ=false</span><br></pre></td></tr></table></figure>

<p>注意：flannel集群各主机的配置略有不同，部署其他节点时之一修改。</p>
<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# vi flanneld.sh </span><br><span class="line">[root@shkf6-243 flannel]# cat flanneld.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./flanneld \</span><br><span class="line">  --public-ip=192.168.6.243 \</span><br><span class="line">  --etcd-endpoints=https://192.168.6.242:2379,https://192.168.6.243:2379,https://192.168.6.244:2379 \</span><br><span class="line">  --etcd-keyfile=./cert/client-key.pem \</span><br><span class="line">  --etcd-certfile=./cert/client.pem \</span><br><span class="line">  --etcd-cafile=./cert/ca.pem \</span><br><span class="line">  --iface=eth0 \</span><br><span class="line">  --subnet-file=./subnet.env \</span><br><span class="line">  --healthz-port=2401</span><br></pre></td></tr></table></figure>

<p>注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# chmod +x /opt/flannel/flanneld.sh </span><br><span class="line">[root@shkf6-243 flannel]# mkdir -p /data/logs/flanneld</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置"><a href="#创建supervisor配置" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# cat /etc/supervisord.d/flannel.ini</span><br><span class="line">[program:flanneld-6-243]</span><br><span class="line">command=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                 ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                               ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                              ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                              ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                         ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                             ; kill all process in a group</span><br><span class="line">stopasgroup=true                                             ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                  ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                  ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></table></figure>

<p>注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改</p>
<p>supervisord管理进程的时候，默认是不kill子进程的，需要在对应的服务.ini配置文件中加以下两个配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></table></figure>

<h3 id="操作etcd，增加host-gw"><a href="#操作etcd，增加host-gw" class="headerlink" title="操作etcd，增加host-gw"></a>操作etcd，增加host-gw</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 etcd]# ./etcdctl set /coreos.com/network/config '&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;'</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Flannel的host-gw模型</p>
<img src = "/images/m_b12d9d33897632ec412af7644b40298a_r.png">



<p>本质就是增加静态路由：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# route add -net 172.6.244.0/24 gw 192.168.6.244 dev eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route add -net 172.6.243.0/24 gw 192.168.6.244 dev eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# iptables -t filter -I FORWARD -d 172.5.243.0/24 -j ACCEPT</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# iptables -t filter -I FORWARD -d 172.5.244.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>附：flannel的其他网络模型</p>
<p>VxLAN模型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;'</span><br></pre></td></tr></table></figure>

<img src = "/images/m_f125be65a578dc5128c832c86f3edb9e_r.png">



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line">1、更改为VxLAN模型</span><br><span class="line"></span><br><span class="line">1.1 拆除现有的host-gw模式</span><br><span class="line"></span><br><span class="line">1.1.1查看当前flanneld工作模式</span><br><span class="line">[root@shkf6-243 flannel]# cd /opt/etcd</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line"></span><br><span class="line">1.1.2关闭flanneld</span><br><span class="line">[root@shkf6-243 flannel]# supervisorctl stop flanneld-6-243</span><br><span class="line">flanneld-6-243: stopped</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# supervisorctl stop flanneld-6-244</span><br><span class="line">flanneld-6-244: stopped</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.1.3检查关闭情况</span><br><span class="line">[root@shkf6-243 flannel]# ps -aux | grep flanneld</span><br><span class="line">root     12784  0.0  0.0 112660   964 pts/0    S+   10:30   0:00 grep --color=auto flanneld</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# ps -aux | grep flanneld</span><br><span class="line">root     12379  0.0  0.0 112660   972 pts/0    S+   10:31   0:00 grep --color=auto flanneld</span><br><span class="line"></span><br><span class="line">1.2拆除静态规则</span><br><span class="line"></span><br><span class="line">1.2.1查看当前路由</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# route -n </span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">172.6.244.0     192.168.6.244   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     192.168.6.243   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">172.6.244.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.2.2拆除host-gw静态路由规则：</span><br><span class="line">[root@shkf6-243 flannel]# route del -net  172.6.244.0/24 gw 192.168.6.244 dev eth0     # 删除规则的方法</span><br><span class="line">[root@shkf6-244 flannel]# route del -net  172.6.243.0/24 gw 192.168.6.243 dev eth0        # 删除规则的方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.2.3查看拆除后的路由信息</span><br><span class="line">[root@shkf6-243 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.244.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.3查看后端模式，并删除host-gw模型</span><br><span class="line">[root@shkf6-243 flannel]# cd /opt/etcd</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl rm /coreos.com/network/config</span><br><span class="line">Error:  x509: certificate signed by unknown authority</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl rm /coreos.com/network/config</span><br><span class="line">PrevNode.Value: &#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">Error:  100: Key not found (/coreos.com/network/config) [13]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2、更改后端模式为VxLAN</span><br><span class="line"></span><br><span class="line">2.1后端模式添加为VxLAN</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl set /coreos.com/network/config '&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;'</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;</span><br><span class="line"></span><br><span class="line">2.2查看模式</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;</span><br><span class="line"></span><br><span class="line">2.3查看flanneld（VxLan）应用前网卡信息</span><br><span class="line">[root@shkf6-243 etcd]# ifconfig </span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.6.243.1  netmask 255.255.255.0  broadcast 172.6.243.255</span><br><span class="line"></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.6.243  netmask 255.255.255.0  broadcast 192.168.6.255</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line"></span><br><span class="line">vethba8da49: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.4启动flanneld</span><br><span class="line">[root@shkf6-243 etcd]# supervisorctl start flanneld-6-243</span><br><span class="line">[root@shkf6-244 flannel]# supervisorctl start flanneld-6-244</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.5查看flanneld（VxLan）应用生效后网卡信息</span><br><span class="line">[root@shkf6-243 etcd]# ifconfig </span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.6.243.1  netmask 255.255.255.0  broadcast 172.6.243.255</span><br><span class="line"></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.6.243  netmask 255.255.255.0  broadcast 192.168.6.255</span><br><span class="line"></span><br><span class="line">flannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 172.6.243.0  netmask 255.255.255.255  broadcast 0.0.0.0</span><br><span class="line"></span><br><span class="line">lo: flainet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line"></span><br><span class="line">vethba8da49: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.6查看静态路由信息    </span><br><span class="line">[root@shkf6-243 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">172.6.244.0     172.6.244.0     255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     172.6.243.0     255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">172.6.244.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line">3.恢复成host-gw模型：</span><br><span class="line">3.1查看当前flanneld工作模式</span><br><span class="line">[root@shkf6-243 flannel]# cd /opt/etcd</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;</span><br><span class="line"></span><br><span class="line">3.2关闭flanneld</span><br><span class="line">[root@shkf6-243 flannel]# supervisorctl stop flanneld-6-243</span><br><span class="line">flanneld-6-243: stopped</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# supervisorctl stop flanneld-6-244</span><br><span class="line">flanneld-6-244: stopped</span><br><span class="line"></span><br><span class="line">3.3删除后端flanneld（VxLAN）模型</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl rm /coreos.com/network/config</span><br><span class="line">PrevNode.Value: &#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN"&#125;&#125;</span><br><span class="line"></span><br><span class="line">3.4查看后端当前模型</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">Error:  100: Key not found (/coreos.com/network/config) [17]</span><br><span class="line"></span><br><span class="line">3.5后端更改host-gw模型</span><br><span class="line">[root@shkf6-243 etcd]#  ./etcdctl set /coreos.com/network/config '&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;'</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line">[root@shkf6-243 etcd]# ./etcdctl get /coreos.com/network/config</span><br><span class="line">&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "host-gw"&#125;&#125;</span><br><span class="line"></span><br><span class="line">3.6查看静态路由</span><br><span class="line">[root@shkf6-243 etcd]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">172.6.244.0     192.168.6.244   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     192.168.6.243   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">172.6.244.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure>

<p>Directrouting模型(直接路由)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'&#123;"Network": "172.6.0.0/16", "Backend": &#123;"Type": "VxLAN","Directrouting": true&#125;&#125;'</span><br></pre></td></tr></table></figure>

<p>查找主：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 etcd]# ./etcdctl member list</span><br><span class="line">4244d625c76d5482: name=etcd-server-6-242 peerURLs=https://192.168.6.242:2380 clientURLs=http://127.0.0.1:2379,https://192.168.6.242:2379 isLeader=true</span><br><span class="line">aa911af67b8285a2: name=etcd-server-6-243 peerURLs=https://192.168.6.243:2380 clientURLs=http://127.0.0.1:2379,https://192.168.6.243:2379 isLeader=false</span><br><span class="line">c751958d48e7e127: name=etcd-server-6-244 peerURLs=https://192.168.6.244:2380 clientURLs=http://127.0.0.1:2379,https://192.168.6.244:2379 isLeader=false</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# supervisorctl update</span><br><span class="line">flanneld-6-243: added process group</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# supervisorctl status</span><br><span class="line">etcd-server-6-243                RUNNING   pid 28429, uptime 2 days, 0:10:55</span><br><span class="line">flanneld-6-243                   STARTING  </span><br><span class="line">kube-apiserver-6-243             RUNNING   pid 17808, uptime 18:50:14</span><br><span class="line">kube-controller-manager-6.243    RUNNING   pid 17999, uptime 18:49:47</span><br><span class="line">kube-kubelet-6-243               RUNNING   pid 28717, uptime 1 day, 23:25:50</span><br><span class="line">kube-proxy-6-243                 RUNNING   pid 31546, uptime 1 day, 23:14:58</span><br><span class="line">kube-scheduler-6-243             RUNNING   pid 28574, uptime 1 day, 23:39:57</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划的机器"><a href="#安装部署启动检查所有集群规划的机器" class="headerlink" title="安装部署启动检查所有集群规划的机器"></a>安装部署启动检查所有集群规划的机器</h3><p>略</p>
<h3 id="再次验证集群，pod之间网络互通"><a href="#再次验证集群，pod之间网络互通" class="headerlink" title="再次验证集群，pod之间网络互通"></a>再次验证集群，pod之间网络互通</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-jrbdg   1/1     Running   0          9h    172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-ttlx9   1/1     Running   0          9h    172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# kubectl exec -it nginx-ds-jrbdg bash </span><br><span class="line">root@nginx-ds-jrbdg:/# ping 172.6.244.2</span><br><span class="line">PING 172.6.244.2 (172.6.244.2): 48 data bytes</span><br><span class="line">56 bytes from 172.6.244.2: icmp_seq=0 ttl=62 time=0.446 ms</span><br><span class="line">56 bytes from 172.6.244.2: icmp_seq=1 ttl=62 time=0.449 ms</span><br><span class="line">56 bytes from 172.6.244.2: icmp_seq=2 ttl=62 time=0.344 ms</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# kubectl exec -it nginx-ds-ttlx9 bash</span><br><span class="line">root@nginx-ds-ttlx9:/# ping 172.6.243.2</span><br><span class="line">PING 172.6.243.2 (172.6.243.2): 48 data bytes</span><br><span class="line">56 bytes from 172.6.243.2: icmp_seq=0 ttl=62 time=0.324 ms</span><br><span class="line">56 bytes from 172.6.243.2: icmp_seq=1 ttl=62 time=0.286 ms</span><br><span class="line">56 bytes from 172.6.243.2: icmp_seq=2 ttl=62 time=0.345 ms</span><br><span class="line">[root@shkf6-243 flannel]# ping 172.6.244.2</span><br><span class="line">PING 172.6.244.2 (172.6.244.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.6.244.2: icmp_seq=1 ttl=63 time=0.878 ms</span><br><span class="line">64 bytes from 172.6.244.2: icmp_seq=2 ttl=63 time=0.337 ms</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# ping 172.6.243.2</span><br><span class="line">PING 172.6.243.2 (172.6.243.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.6.243.2: icmp_seq=1 ttl=64 time=0.062 ms</span><br><span class="line">64 bytes from 172.6.243.2: icmp_seq=2 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 172.6.243.2: icmp_seq=3 ttl=64 time=0.071 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# ping 172.6.243.2</span><br><span class="line">PING 172.6.243.2 (172.6.243.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.6.243.2: icmp_seq=1 ttl=63 time=0.248 ms</span><br><span class="line">64 bytes from 172.6.243.2: icmp_seq=2 ttl=63 time=0.125 ms</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# ping 172.6.244.2</span><br><span class="line">PING 172.6.244.2 (172.6.244.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.6.244.2: icmp_seq=1 ttl=64 time=0.091 ms</span><br><span class="line">64 bytes from 172.6.244.2: icmp_seq=2 ttl=64 time=0.064 ms</span><br></pre></td></tr></table></figure>

<p>为甚么172.6.243.2和172.6.244.2容器能通信呢？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     192.168.6.243   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">172.6.244.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 flannel]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.6.254   0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">172.6.243.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br><span class="line">172.6.244.0     192.168.6.244   255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">192.168.6.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure>

<p>本质就是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 flannel]# route add -net 172.6.244.0/24 gw 192.168.6.244 dev eth0</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 flannel]# route add -net 172.6.243.0/24 gw 192.168.6.244 dev eth0</span><br></pre></td></tr></table></figure>

<h3 id="在各个节点上优化iptables规则"><a href="#在各个节点上优化iptables规则" class="headerlink" title="在各个节点上优化iptables规则"></a>在各个节点上优化iptables规则</h3><p>为什么要优化？一起看下面的案例：</p>
<p>1.创建nginx-ds.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cat nginx-ds.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.od.com/public/nginx:curl</span><br><span class="line">        command: ["nginx","-g","daemon off;"]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<hr>
<p>提示：直接用nginx:curl起不来原因是，当时打包nginx:curl 用的是bash：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it  sunrisenan/nginx:v1.12.2 bash</span><br></pre></td></tr></table></figure>

<p>1、重做nginx:curl<br>启动nginx，docker run -d –rm nginx:1.7.9<br>然后exec进去安装curl，再commit</p>
<p>2、仍然用之前做的nginx:curl<br>然后在k8s的yaml里，加入cmd指令的配置<br>需要显示的指明，这个镜像的CMD指令是：nginx -g “daemon off;”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command: ["nginx","-g","daemon off;"]</span><br></pre></td></tr></table></figure>

<hr>
<p>2.应用nginx-ds.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f nginx-ds.yaml</span><br><span class="line">daemonset.extensions/nginx-ds created</span><br></pre></td></tr></table></figure>

<p>3.可以发现，pod之间访问nginx显示的是代理的IP地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-86f7k   1/1     Running   0          21m   172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-twfgq   1/1     Running   0          21m   172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl exec -it nginx-ds-86f7k /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 172.6.243.2</span></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# kubectl log -f nginx-ds-twfgq</span><br><span class="line">log is DEPRECATED and will be removed in a future version. Use logs instead.</span><br><span class="line">192.168.6.244 - - [21/Nov/2019:06:56:35 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.38.0" "-"</span><br></pre></td></tr></table></figure>

<p>4.优化pod之间不走原地址nat</p>
<p>在所有需要优化的机器上安装iptables</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# yum install iptables-services -y</span><br><span class="line"></span><br><span class="line">~]# systemctl start iptables.service</span><br><span class="line">~]# systemctl enable iptables.service</span><br></pre></td></tr></table></figure>

<p>优化shkf6-243</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# iptables-save|grep -i postrouting</span><br><span class="line">:POSTROUTING ACCEPT [15:912]</span><br><span class="line">:KUBE-POSTROUTING - [0:0]</span><br><span class="line">-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span><br><span class="line">-A POSTROUTING -s 172.6.243.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# iptables -t nat -D POSTROUTING -s 172.6.243.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line">[root@shkf6-243 ~]# iptables -t nat -I POSTROUTING -s 172.6.243.0/24 ! -d 172.6.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# iptables-save|grep -i postrouting</span><br><span class="line">:POSTROUTING ACCEPT [8:488]</span><br><span class="line">:KUBE-POSTROUTING - [0:0]</span><br><span class="line">-A POSTROUTING -s 172.6.243.0/24 ! -d 172.6.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>优化shkf6-244</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# iptables-save|grep -i postrouting</span><br><span class="line">:POSTROUTING ACCEPT [7:424]</span><br><span class="line">:KUBE-POSTROUTING - [0:0]</span><br><span class="line">-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span><br><span class="line">-A POSTROUTING -s 172.6.244.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# iptables -t nat -D POSTROUTING -s 172.6.244.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line">[root@shkf6-244 ~]# iptables -t nat -I POSTROUTING -s 172.6.244.0/24 ! -d 172.6.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# iptables-save|grep -i postrouting</span><br><span class="line">:POSTROUTING ACCEPT [2:120]</span><br><span class="line">:KUBE-POSTROUTING - [0:0]</span><br><span class="line">-A POSTROUTING -s 172.6.244.0/24 ! -d 172.6.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>192.168.6.243主机上的，来源是172.6.243.0/24段的docker的ip，目标ip不是172.6.0.0/16段，网络发包不从docker0桥设备出站的，才进行转换</p>
<p>192.168.6.244主机上的，来源是172.6.244.0/24段的docker的ip，目标ip不是172.6.0.0/16段，网络发包不从docker0桥设备出站的，才进行转换</p>
</blockquote>
<p>5.把默认禁止规则删掉</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@shkf6-243 ~]# iptables-save | grep -i reject</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-243 ~]# iptables -t filter -D INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-243 ~]# iptables -t filter -D FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-243 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# iptables-save | grep -i reject</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-244 ~]# iptables -t filter -D INPUT -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-244 ~]# iptables -t filter -D FORWARD -j REJECT --reject-with icmp-host-prohibited</span><br><span class="line">[root@shkf6-244 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<p>6.优化SNAT规则，各运算节点之间的各pod之间的网络通信不再出网</p>
<p>测试6.244</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-86f7k   1/1     Running   0          70m   172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-twfgq   1/1     Running   0          70m   172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# curl 172.6.243.2</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# kubectl log -f nginx-ds-86f7k</span><br><span class="line">log is DEPRECATED and will be removed in a future version. Use logs instead.</span><br><span class="line">192.168.6.243 - - [21/Nov/2019:07:56:22 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.29.0" "-"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl exec -it  nginx-ds-twfgq /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 172.6.244.2</span></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# kubectl log -f nginx-ds-86f7k</span><br><span class="line">log is DEPRECATED and will be removed in a future version. Use logs instead.</span><br><span class="line">172.6.243.2 - - [21/Nov/2019:07:57:17 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.38.0" "-"</span><br></pre></td></tr></table></figure>

<p>测试6.243</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-86f7k   1/1     Running   0          81m   172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-twfgq   1/1     Running   0          81m   172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# curl 172.6.243.2</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl log -f nginx-ds-twfgq</span><br><span class="line">192.168.6.244 - - [21/Nov/2019:08:01:38 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.29.0" "-"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# kubectl exec -it nginx-ds-86f7k /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl 172.6.243.2</span></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl log -f nginx-ds-twfgq</span><br><span class="line">172.6.244.2 - - [21/Nov/2019:08:02:52 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.38.0" "-"</span><br></pre></td></tr></table></figure>

<h3 id="在运算节点保存iptables规则"><a href="#在运算节点保存iptables规则" class="headerlink" title="在运算节点保存iptables规则"></a>在运算节点保存iptables规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line">[root@shkf6-244 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面这中保存重启系统失效，建议用下面的方式</span></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# service iptables save</span><br><span class="line">[root@shkf6-244 ~]# service iptables save</span><br></pre></td></tr></table></figure>

<h1 id="Kubernetes的服务发现插件–coredns"><a href="#Kubernetes的服务发现插件–coredns" class="headerlink" title="Kubernetes的服务发现插件–coredns"></a>Kubernetes的服务发现插件–coredns</h1><ul>
<li><p>简单来说，服务发现就是服务(应用)之间相互定位的过程。</p>
</li>
<li><p>服务发现并非云计算时代独有的，传统的单体架构时代也会用到。以下应用场景下，更需要服务发现</p>
<ul>
<li>服务(应用)的动态性强</li>
<li>服务(应用)更新发布频繁</li>
<li>服务(应用)支持自动伸缩</li>
</ul>
</li>
<li><p>在K8S集群里，POD的IP是不断变化的，如何“以不变应万变“呢？</p>
<ul>
<li>抽象出了Service资源，通过标签选择器，关联一组POD</li>
<li>抽象出了集群网络，通过相对固定的“集群IP”，使服务接入点固定</li>
</ul>
</li>
<li><p>那么如何自动关联Service资源的“名称”和“集群网络IP”，从而达到服务被集群自动发现的目的呢？</p>
<ul>
<li>考虑传统DNS的模型：shkf6-243.host.com –&gt; 192.168.6.243</li>
<li>能否在K8S里建立这样的模型：nginx-ds –&gt; 10.96.0.5</li>
</ul>
</li>
<li><p>K8S里服务发现的方式–DNS</p>
</li>
<li><p>实现K8S里DNS功能的插件（软件）</p>
<ul>
<li>Kube-dns—kubernetes-v1.2至kubernetes-v1.10</li>
<li>Coredns—kubernetes-v1.11至今</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>K8S里的DNS不是万能的！它应该只负责自动维护“服务名”—&gt;“集群网络IP”之间的关系</li>
</ul>
</li>
</ul>
<h2 id="部署K8S的内网资源配置清单http服务"><a href="#部署K8S的内网资源配置清单http服务" class="headerlink" title="部署K8S的内网资源配置清单http服务"></a>部署K8S的内网资源配置清单http服务</h2><blockquote>
<p>在运维主机shkf6-245上，配置一个nginx想虚拟主机，用以提供k8s统一资源配置清单访问入口</p>
</blockquote>
<ul>
<li>配置nginx</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /etc/nginx/conf.d/k8s-yaml.od.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name k8s-yaml.od.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        root /data/k8s-yaml;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# mkdir -p /data/k8s-yaml/coredns</span><br><span class="line">[root@shkf6-245 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@shkf6-245 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<ul>
<li>配置内网DNS解析</li>
</ul>
<p>在shkf6-241机器上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# vim /var/named/od.com.zone </span><br><span class="line"></span><br><span class="line">k8s-yaml    A    192.168.6.245</span><br></pre></td></tr></table></figure>

<p>注意： <code>2019111204 ; serial</code> #序列号前滚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# named-checkconf </span><br><span class="line">[root@shkf6-241 ~]# systemctl restart named</span><br><span class="line">[root@shkf6-241 ~]# dig -t A k8s-yaml.od.com @192.168.6.241 +short</span><br><span class="line">192.168.6.245</span><br></pre></td></tr></table></figure>

<p>以后多有的资源配置清单统一放置在运维主机上的<code>/data/k8s-yaml</code>目录即可</p>
<h2 id="部署coredns"><a href="#部署coredns" class="headerlink" title="部署coredns"></a>部署coredns</h2><p><a href="https://github.com/coredns/coredns" target="_blank" rel="noopener">coredns官方Guthub</a></p>
<p><a href="https://hub.docker.com/r/coredns/coredns/tags" target="_blank" rel="noopener">coredns官方DockerHub</a></p>
<h3 id="准备coredns-v1-6-1镜像"><a href="#准备coredns-v1-6-1镜像" class="headerlink" title="准备coredns-v1.6.1镜像"></a>准备coredns-v1.6.1镜像</h3><p>在运维主机shkf6-245上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull coredns/coredns:1.6.1</span><br><span class="line">1.6.1: Pulling from coredns/coredns</span><br><span class="line">c6568d217a00: Pull complete </span><br><span class="line">d7ef34146932: Pull complete </span><br><span class="line">Digest: sha256:9ae3b6fcac4ee821362277de6bd8fd2236fa7d3e19af2ef0406d80b595620a7a</span><br><span class="line">Status: Downloaded newer image for coredns/coredns:1.6.1</span><br><span class="line">docker.io/coredns/coredns:1.6.1</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker images|grep coredns</span><br><span class="line">coredns/coredns                 1.6.1                      c0f6e815079e        3 months ago        42.2MB</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker tag c0f6e815079e harbor.od.com/public/coredns:v1.6.1</span><br><span class="line">[root@shkf6-245 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com/public/coredns:v1.6.1</span><br><span class="line">The push refers to repository [harbor.od.com/public/coredns]</span><br><span class="line">da1ec456edc8: Pushed </span><br><span class="line">225df95e717c: Pushed </span><br><span class="line">v1.6.1: digest: sha256:c7bf0ce4123212c87db74050d4cbab77d8f7e0b49c041e894a35ef15827cf938 size: 739</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>在运维主机shkf6-245.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir -p /data/k8s-yaml/coredns &amp;&amp; cd /data/k8s-yaml/coredns/</span><br></pre></td></tr></table></figure>

<p>RBAC</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 coredns]# cat rbac.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: "true"</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<p>ConfigMap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 coredns]# cat cm.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local 10.96.0.0/22</span><br><span class="line">        forward . 192.168.6.241</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 coredns]# cat dp.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.od.com/public/coredns:v1.6.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></table></figure>

<p>Service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 coredns]# cat svc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 10.96.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建"><a href="#依次执行创建" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/cm.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/dp.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get all -n kube-system</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-6b6c4f9648-x5zvz   1/1     Running   0          7m37s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/coredns   ClusterIP   10.96.0.2    &lt;none&gt;        53/UDP,53/TCP,9153/TCP   7m27s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns   1/1     1            1           7m37s</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-6b6c4f9648   1         1         1       7m37s</span><br><span class="line">[root@shkf6-243 ~]# dig -t A www.baidu.com @10.96.0.2 +short</span><br><span class="line">www.a.shifen.com.</span><br><span class="line">180.101.49.12</span><br><span class="line">180.101.49.11</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# dig -t A shkf6-245.host.com @10.96.0.2 +short</span><br><span class="line">192.168.6.245</span><br><span class="line">[root@shkf6-243 ~]# kubectl create deployment nginx-dp --image=harbor.od.com/public/nginx:v1.7.9 -n kube-public</span><br><span class="line">deployment.apps/nginx-dp created</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl expose deployment nginx-dp --port=80 -n kube-public</span><br><span class="line">service/nginx-dp exposed</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl get service -n kube-public</span><br><span class="line">NAME       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-dp   ClusterIP   10.96.3.154   &lt;none&gt;        80/TCP    38s</span><br><span class="line">[root@shkf6-243 ~]# dig -t A nginx-dp.kube-public.svc.cluster.local. @10.96.0.2 +short</span><br><span class="line">10.96.3.154</span><br></pre></td></tr></table></figure>

<h1 id="Kubernetes的服务暴露插件–traefik"><a href="#Kubernetes的服务暴露插件–traefik" class="headerlink" title="Kubernetes的服务暴露插件–traefik"></a>Kubernetes的服务暴露插件–traefik</h1><ul>
<li>K8S的DNS实现了服务在集群“内”被自动发现，那如何是的服务在K8S集群“外”被使用和访问呢？<ul>
<li>使用NodePort型的Service<ul>
<li>注意：无法使用kube-proxy的ipvs模型，只能使用iptables模型</li>
</ul>
</li>
<li>使用Ingress资源<ul>
<li>注意：Ingress只能调度并暴露7层应用，特指http和https协议</li>
</ul>
</li>
</ul>
</li>
<li>Ingress是K8S API的标准资源类型之一，也是一种核心资源，它其实就是一组基于域名和URL路径，把用户的请求转发至指定Service资源的规则</li>
<li>可以将集群外部的请求流量，转发至集群内部，从而实现“服务暴露”</li>
<li>Ingress控制器是能够为Ingress资源监听某套接字，然后根据Ingress规则匹配机制路由调度流量的一个插件</li>
<li>说白了，Ingress没啥神秘的，就是个nginx+一段go脚本而已</li>
<li>常用的Ingress控制器的实现软件<ul>
<li>Ingress-nginx</li>
<li>HAProxy</li>
<li>Traefik</li>
<li>…</li>
</ul>
</li>
</ul>
<h2 id="使用NodePort型Service暴露服务"><a href="#使用NodePort型Service暴露服务" class="headerlink" title="使用NodePort型Service暴露服务"></a>使用NodePort型Service暴露服务</h2><p>注意：使用这种方法暴露服务，要求kube-proxy的代理类型为：iptables</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">1、第一步更改为proxy-mode更改为iptables，调度方式为RR</span><br><span class="line">[root@shkf6-243 ~]# cat /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.6.0.0/16 \</span><br><span class="line">  --hostname-override shkf6-243.host.com \</span><br><span class="line">  --proxy-mode=iptables \</span><br><span class="line">  --ipvs-scheduler=rr \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# cat /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.6.0.0/16 \</span><br><span class="line">  --hostname-override shkf6-243.host.com \</span><br><span class="line">  --proxy-mode=iptables \</span><br><span class="line">  --ipvs-scheduler=rr \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.使iptables模式生效</span><br><span class="line">[root@shkf6-243 ~]# supervisorctl restart kube-proxy-6-243</span><br><span class="line">kube-proxy-6-243: stopped</span><br><span class="line">kube-proxy-6-243: started</span><br><span class="line">[root@shkf6-243 ~]# ps -ef|grep kube-proxy</span><br><span class="line">root     26694 12008  0 10:25 ?        00:00:00 /bin/sh /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line">root     26695 26694  0 10:25 ?        00:00:00 ./kube-proxy --cluster-cidr 172.6.0.0/16 --hostname-override shkf6-243.host.com --proxy-mode=iptables --ipvs-scheduler=rr --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line">root     26905 13466  0 10:26 pts/0    00:00:00 grep --color=auto kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# supervisorctl restart kube-proxy-6-244</span><br><span class="line">kube-proxy-6-244: stopped</span><br><span class="line">kube-proxy-6-244kube-proxy-6-244: started</span><br><span class="line">[root@shkf6-244 ~]# ps -ef|grep kube-proxy</span><br><span class="line">root     25998 11030  0 10:22 ?        00:00:00 /bin/sh /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line">root     25999 25998  0 10:22 ?        00:00:00 ./kube-proxy --cluster-cidr 172.6.0.0/16 --hostname-override shkf6-243.host.com --proxy-mode=iptables --ipvs-scheduler=rr --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# tail -fn 11 /data/logs/kubernetes/kube-proxy/proxy.stdout.log </span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# tail -fn 11 /data/logs/kubernetes/kube-proxy/proxy.stdout.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.清理现有的ipvs规则</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:9153 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:9153             Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.3.154:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line">UDP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -t 10.96.0.1:443</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -t 10.96.0.2:53</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -t 10.96.0.2:9153</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -t 10.96.3.154:80</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -D -u 10.96.0.2:53</span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      1          0         </span></span><br><span class="line">TCP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:9153 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:9153             Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.3.154:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line">UDP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -D -t 10.96.0.1:443</span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -D -t 10.96.0.2:53</span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -D -t 10.96.0.2:9153</span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -D -t 10.96.3.154:80</span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -D -u 10.96.0.2:53</span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br></pre></td></tr></table></figure>

<h3 id="修改nginx-ds的service资源配置清单"><a href="#修改nginx-ds的service资源配置清单" class="headerlink" title="修改nginx-ds的service资源配置清单"></a>修改nginx-ds的service资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cat /root/nginx-ds-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 8000</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: NodePort</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f nginx-ds-svc.yaml </span><br><span class="line">service/nginx-ds created</span><br></pre></td></tr></table></figure>

<h3 id="重建nginx-ds的service资源"><a href="#重建nginx-ds的service资源" class="headerlink" title="重建nginx-ds的service资源"></a>重建nginx-ds的service资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cat nginx-ds.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.od.com/public/nginx:curl</span><br><span class="line">        command: ["nginx","-g","daemon off;"]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f nginx-ds.yaml </span><br><span class="line">daemonset.extensions/nginx-ds created</span><br></pre></td></tr></table></figure>

<h3 id="查看service"><a href="#查看service" class="headerlink" title="查看service"></a>查看service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get svc nginx-ds</span><br><span class="line">NAME       TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)       AGE</span><br><span class="line">nginx-ds   NodePort   10.96.1.170   &lt;none&gt;        80:8000/TCP   2m20s</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# netstat -lntup|grep 8000</span><br><span class="line">tcp6       0      0 :::8000                 :::*                    LISTEN      26695/./kube-proxy</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# netstat -lntup|grep 8000</span><br><span class="line">tcp6       0      0 :::8000                 :::*                    LISTEN      25999/./kube-proxy</span><br></pre></td></tr></table></figure>

<ul>
<li>nodePort本质</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# iptables-save | grep 8000</span><br><span class="line">-A KUBE-FIREWALL -m comment --comment "kubernetes firewall for dropping marked packets" -m mark --mark 0x8000/0x8000 -j DROP</span><br><span class="line">-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000</span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment "default/nginx-ds:" -m tcp --dport 8000 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment "default/nginx-ds:" -m tcp --dport 8000 -j KUBE-SVC-T4RQBNWQFKKBCRET</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p>访问：<a href="http://192.168.6.243:8000/" target="_blank" rel="noopener">http://192.168.6.243:8000/</a></p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_219520c675b6c8faf33df7c9ebaa07bf_r.png" alt="null"></p>
<p>访问：<a href="http://192.168.6.244:8000/" target="_blank" rel="noopener">http://192.168.6.244:8000/</a></p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_7103dd03286a23073e5055cd87a272c1_r.png" alt="null"></p>
<h3 id="还原成ipvs"><a href="#还原成ipvs" class="headerlink" title="还原成ipvs"></a>还原成ipvs</h3><p>删除service和pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl delete -f nginx-ds.yaml </span><br><span class="line">daemonset.extensions "nginx-ds" deleted</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl delete -f nginx-ds-svc.yaml </span><br><span class="line">service "nginx-ds" deleted</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# netstat -lntup|grep 8000</span><br><span class="line">[root@shkf6-243 ~]#</span><br></pre></td></tr></table></figure>

<p>在运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cat /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.6.0.0/16 \</span><br><span class="line">  --hostname-override shkf6-243.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# supervisorctl restart kube-proxy-6-243</span><br><span class="line">kube-proxy-6-243: stopped</span><br><span class="line">kube-proxy-6-243: started</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:9153 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:9153             Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.3.154:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line">UDP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0   </span></span><br><span class="line">[root@shkf6-244 ~]# cat /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.6.0.0/16 \</span><br><span class="line">  --hostname-override shkf6-243.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# supervisorctl restart kube-proxy-6-244</span><br><span class="line">kube-proxy-6-244: stopped</span><br><span class="line">kube-proxy-6-244: started</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.243:6443           Masq    1      0          0         </span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 192.168.6.244:6443           Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.0.2:9153 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:9153             Masq    1      0          0         </span></span><br><span class="line">TCP  10.96.3.154:80 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.243.3:80               Masq    1      0          0         </span></span><br><span class="line">UDP  10.96.0.2:53 nq</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 172.6.244.3:53               Masq    1      0          0</span></span><br></pre></td></tr></table></figure>

<h2 id="部署traefik（ingress控制器）"><a href="#部署traefik（ingress控制器）" class="headerlink" title="部署traefik（ingress控制器）"></a>部署traefik（ingress控制器）</h2><p><a href="https://github.com/containous/traefik" target="_blank" rel="noopener">traefik官方GitHub</a></p>
<p><a href="https://hub.docker.com/_/traefik" target="_blank" rel="noopener">traefik官方DockerHub</a></p>
<h3 id="准备traefik镜像"><a href="#准备traefik镜像" class="headerlink" title="准备traefik镜像"></a>准备traefik镜像</h3><p>在运维主机上shkf6-245.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 traefik]# docker pull traefik:v1.7.2-alpine</span><br><span class="line">v1.7.2-alpine: Pulling from library/traefik</span><br><span class="line">4fe2ade4980c: Pull complete </span><br><span class="line">8d9593d002f4: Pull complete </span><br><span class="line">5d09ab10efbd: Pull complete </span><br><span class="line">37b796c58adc: Pull complete </span><br><span class="line">Digest: sha256:cf30141936f73599e1a46355592d08c88d74bd291f05104fe11a8bcce447c044</span><br><span class="line">Status: Downloaded newer image for traefik:v1.7.2-alpine</span><br><span class="line">docker.io/library/traefik:v1.7.2-alpine</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 traefik]# docker images|grep traefik</span><br><span class="line">traefik                         v1.7.2-alpine              add5fac61ae5        13 months ago       72.4MB</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 traefik]# docker tag add5fac61ae5 harbor.od.com/public/traefik:v1.7.2</span><br><span class="line">[root@shkf6-245 traefik]# docker push !$</span><br><span class="line">docker push harbor.od.com/public/traefik:v1.7.2</span><br><span class="line">The push refers to repository [harbor.od.com/public/traefik]</span><br><span class="line">a02beb48577f: Pushed </span><br><span class="line">ca22117205f4: Pushed </span><br><span class="line">3563c211d861: Pushed </span><br><span class="line">df64d3292fd6: Pushed </span><br><span class="line">v1.7.2: digest: sha256:6115155b261707b642341b065cd3fac2b546559ba035d0262650b3b3bbdd10ea size: 1157</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 traefik]# cat /data/k8s-yaml/traefik/rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - ""</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">[root@shkf6-245 traefik]# cat /data/k8s-yaml/traefik/ds.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/public/traefik:v1.7.2</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: controller</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin-web</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - --api</span><br><span class="line">        - --kubernetes</span><br><span class="line">        - --logLevel=INFO</span><br><span class="line">        - --insecureskipverify=true</span><br><span class="line">        - --kubernetes.endpoint=https://192.168.6.66:7443</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --accesslog.filepath=/var/log/traefik_access.log</span><br><span class="line">        - --traefiklog</span><br><span class="line">        - --traefiklog.filepath=/var/log/traefik.log</span><br><span class="line">        - --metrics.prometheus</span><br><span class="line">[root@shkf6-245 traefik]# cat /data/k8s-yaml/traefik/svc.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: controller</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin-web</span><br><span class="line">[root@shkf6-245 traefik]# cat /data/k8s-yaml/traefik/ingress.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-1"><a href="#依次执行创建-1" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ds.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml</span><br></pre></td></tr></table></figure>

<h2 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# cat /var/named/od.com.zone </span><br><span class="line"><span class="meta">$</span><span class="bash">ORIGIN od.com.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 600    ; 10 minutes</span></span><br><span class="line">@           IN SOA    dns.od.com. dnsadmin.od.com. (</span><br><span class="line">                2019111205 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">                NS   dns.od.com.</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 60    ; 1 minute</span></span><br><span class="line">dns                A    192.168.6.241</span><br><span class="line">harbor             A    192.168.6.245</span><br><span class="line">k8s-yaml           A    192.168.6.245</span><br><span class="line">traefik            A    192.168.6.66</span><br><span class="line"></span><br><span class="line">[root@shkf6-241 ~]# named-checkconf </span><br><span class="line">[root@shkf6-241 ~]# systemctl restart named</span><br></pre></td></tr></table></figure>

<h2 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# cat /etc/nginx/conf.d/od.com.conf</span><br><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 192.168.6.243:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">    server 192.168.6.244:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.od.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@shkf6-241 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@shkf6-241 ~]# nginx -s reload</span><br><span class="line">[root@shkf6-242 ~]# vim /etc/nginx/conf.d/od.com.conf</span><br><span class="line">[root@shkf6-242 ~]# cat /etc/nginx/conf.d/od.com.conf</span><br><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 192.168.6.243:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">    server 192.168.6.244:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.od.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@shkf6-242 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@shkf6-242 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="检查-1"><a href="#检查-1" class="headerlink" title="检查"></a>检查</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# kubectl get all -n kube-system </span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/coredns-6b6c4f9648-x5zvz   1/1     Running   0          18h</span><br><span class="line">pod/traefik-ingress-bhhkv      1/1     Running   0          17m</span><br><span class="line">pod/traefik-ingress-mm2ds      1/1     Running   0          17m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/coredns                   ClusterIP   10.96.0.2     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   18h</span><br><span class="line">service/traefik-ingress-service   ClusterIP   10.96.3.175   &lt;none&gt;        80/TCP,8080/TCP          17m</span><br><span class="line"></span><br><span class="line">NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/traefik-ingress   2         2         2       2            2           &lt;none&gt;          17m</span><br><span class="line"></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/coredns   1/1     1            1           18h</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/coredns-6b6c4f9648   1         1         1       18h</span><br></pre></td></tr></table></figure>

<hr>
<p>如果pod没有起来没有起来请重启docker，原因是我上面测试了nodeport，防火墙规则改变了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# systemctl restart docker</span><br><span class="line">[root@shkf6-244 ~]# systemctl restart docker</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><strong>访问 <a href="http://traefik.od.com/" target="_blank" rel="noopener">http://traefik.od.com/</a></strong><br><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_81f6fbe8147a8cbae19f37dcaacc63b9_r.png" alt="null"></p>
<h1 id="的GUI资源管理插件-仪表篇"><a href="#的GUI资源管理插件-仪表篇" class="headerlink" title="的GUI资源管理插件-仪表篇"></a>的GUI资源管理插件-仪表篇</h1><h2 id="部署kubenetes-dashborad"><a href="#部署kubenetes-dashborad" class="headerlink" title="部署kubenetes-dashborad"></a>部署kubenetes-dashborad</h2><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dashboard" target="_blank" rel="noopener">dashboard官方Github</a></p>
<p><a href="https://github.com/kubernetes/dashboard/releases" target="_blank" rel="noopener">dashboard下载地址</a></p>
<h3 id="准备dashboard镜像"><a href="#准备dashboard镜像" class="headerlink" title="准备dashboard镜像"></a>准备dashboard镜像</h3><p>运维主机SHKF6-245.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull sunrisenan/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker pull sunrisenan/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker images |grep dash</span><br><span class="line">sunrisenan/kubernetes-dashboard-amd64   v1.10.1                    f9aed6605b81        11 months ago       122MB</span><br><span class="line">sunrisenan/kubernetes-dashboard-amd64   v1.8.3                     0c60bcf89900        21 months ago       102MB</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker tag f9aed6605b81  harbor.od.com/public/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">[root@shkf6-245 ~]# docker push !$</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker tag 0c60bcf89900 harbor.od.com/public/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">[root@shkf6-245 ~]# docker push !$</span><br></pre></td></tr></table></figure>

<h3 id="准备配置清单"><a href="#准备配置清单" class="headerlink" title="准备配置清单"></a>准备配置清单</h3><p>运维主机SHKF6-245.host.com上：</p>
<ul>
<li><p>创建目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# mkdir -p /data/k8s-yaml/dashboard &amp;&amp; cd /data/k8s-yaml/dashboard</span><br></pre></td></tr></table></figure>
</li>
<li><p>rbac</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dashboard]# cat rbac.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dashboard]# cat dp.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: ''</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.od.com/public/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - --auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: /</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: "CriticalAddonsOnly"</span><br><span class="line">        operator: "Exists"</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dashboard]# cat svc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure>

<ul>
<li>ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dashboard]# cat ingress.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-2"><a href="#依次执行创建-2" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<code>http://k8s-yaml.od.com/dashboard/</code>检查资源配置清单文件是否正确创建</p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_738286ba6d1370be5fa09d275f5ac09d_r.png" alt="null"></p>
<p>在SHKF6-243.host.com机器上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml</span><br></pre></td></tr></table></figure>

<h2 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h2><ul>
<li>添加解析记录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# cat /var/named/od.com.zone</span><br><span class="line"><span class="meta">$</span><span class="bash">ORIGIN od.com.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 600    ; 10 minutes</span></span><br><span class="line">@           IN SOA    dns.od.com. dnsadmin.od.com. (</span><br><span class="line">                2019111208 ; serial    # 向后滚动+1</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">                NS   dns.od.com.</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 60    ; 1 minute</span></span><br><span class="line">dns                A    192.168.6.241</span><br><span class="line">harbor             A    192.168.6.245</span><br><span class="line">k8s-yaml           A    192.168.6.245</span><br><span class="line">traefik            A    192.168.6.66</span><br><span class="line">dashboard          A    192.168.6.66   # 添加这条解析</span><br></pre></td></tr></table></figure>

<ul>
<li>重启named并检查</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# systemctl restart named</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# dig dashboard.od.com @10.96.0.2 +short</span><br><span class="line">192.168.6.66</span><br><span class="line">[root@shkf6-243 ~]# dig dashboard.od.com @192.168.6.241 +short</span><br><span class="line">192.168.6.66</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p>浏览器访问：<code>http://dashboard.od.com</code></p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_56d7bba51541a6e914564efc19910251_r.png" alt="null"></p>
<h2 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h2><h3 id="签发证书"><a href="#签发证书" class="headerlink" title="签发证书"></a>签发证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 certs]# (umask 077; openssl genrsa -out dashboard.od.com.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">............................+++</span><br><span class="line">........+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@shkf6-245 certs]# openssl req -new -key dashboard.od.com.key -out dashboard.od.com.csr -subj "/CN=dashboard.od.com/C=CN/ST=BJ/L=Beijing/O=OldboyEdu/OU=ops"</span><br><span class="line">[root@shkf6-245 certs]# openssl x509 -req -in dashboard.od.com.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out dashboard.od.com.crt -days 3650</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=dashboard.od.com/C=CN/ST=BJ/L=Beijing/O=OldboyEdu/OU=ops</span><br><span class="line">Getting CA Private Key</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 certs]# ll dash*</span><br><span class="line">-rw-r--r-- 1 root root 1196 Nov 27 12:52 dashboard.od.com.crt</span><br><span class="line">-rw-r--r-- 1 root root 1005 Nov 27 12:52 dashboard.od.com.csr</span><br><span class="line">-rw------- 1 root root 1679 Nov 27 12:52 dashboard.od.com.key</span><br></pre></td></tr></table></figure>

<h3 id="检查证书"><a href="#检查证书" class="headerlink" title="检查证书"></a>检查证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 certs]# cfssl-certinfo -cert dashboard.od.com.crt </span><br><span class="line">&#123;</span><br><span class="line">  "subject": &#123;</span><br><span class="line">    "common_name": "dashboard.od.com",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "OldboyEdu",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "Beijing",</span><br><span class="line">    "province": "BJ",</span><br><span class="line">    "names": [</span><br><span class="line">      "dashboard.od.com",</span><br><span class="line">      "CN",</span><br><span class="line">      "BJ",</span><br><span class="line">      "Beijing",</span><br><span class="line">      "OldboyEdu",</span><br><span class="line">      "ops"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "issuer": &#123;</span><br><span class="line">    "common_name": "OldboyEdu",</span><br><span class="line">    "country": "CN",</span><br><span class="line">    "organization": "od",</span><br><span class="line">    "organizational_unit": "ops",</span><br><span class="line">    "locality": "beijing",</span><br><span class="line">    "province": "beijing",</span><br><span class="line">    "names": [</span><br><span class="line">      "CN",</span><br><span class="line">      "beijing",</span><br><span class="line">      "beijing",</span><br><span class="line">      "od",</span><br><span class="line">      "ops",</span><br><span class="line">      "OldboyEdu"</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "serial_number": "11427294234507397728",</span><br><span class="line">  "not_before": "2019-11-27T04:52:30Z",</span><br><span class="line">  "not_after": "2029-11-24T04:52:30Z",</span><br><span class="line">  "sigalg": "SHA256WithRSA",</span><br><span class="line">  "authority_key_id": "",</span><br><span class="line">  "subject_key_id": "",</span><br><span class="line">  "pem": "-----BEGIN CERTIFICATE-----\nMIIDRTCCAi0CCQCeleeP167KYDANBgkqhkiG9w0BAQsFADBgMQswCQYDVQQGEwJD\nTjEQMA4GA1UECBMHYmVpamluZzEQMA4GA1UEBxMHYmVpamluZzELMAkGA1UEChMC\nb2QxDDAKBgNVBAsTA29wczESMBAGA1UEAxMJT2xkYm95RWR1MB4XDTE5MTEyNzA0\nNTIzMFoXDTI5MTEyNDA0NTIzMFowaTEZMBcGA1UEAwwQZGFzaGJvYXJkLm9kLmNv\nbTELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAkJKMRAwDgYDVQQHDAdCZWlqaW5nMRIw\nEAYDVQQKDAlPbGRib3lFZHUxDDAKBgNVBAsMA29wczCCASIwDQYJKoZIhvcNAQEB\nBQADggEPADCCAQoCggEBALeeL9z8V3ysUqrAuT7lEKcF2bi0pSuwoWfFgfBtGmQa\nQtyNaOlyemEexeUOKaIRsNlw0fgcK6HyyLkaMFsVa7q+bpYBPKp4d7lTGU7mKJNG\nNcCU21G8WZYS4jVtd5IYSmmfNkCnzY7l71p1P+sAZNZ7ht3ocNh6jPcHLMpETLUU\nDaKHmT/5iAhxmgcE/V3DUnTawU9PXF2WnICL9xJtmyErBKF5KDIEjC1GVjC/ZLtT\nvEgbH57TYgrp4PeCEAQTtgNbVJuri4awaLpHkNz2iCTNlWpLaLmV1jT1NtChz6iw\n4lDfEgS6YgDh9ZhlB2YvnFSG2eq4tGm3MKorbuMq9S0CAwEAATANBgkqhkiG9w0B\nAQsFAAOCAQEAG6szkJDIvb0ge2R61eMBVe+CWHHSE6X4EOkiQCaCi3cs8h85ES63\nEdQ8/FZorqyZH6nJ/64OjiW1IosXRTFDGMRunqkJezzj9grYzUKfkdGxTv+55IxM\ngtH3P9wM1EeNwdJCpBq9xYaPzZdu0mzmd47BP7nuyrXzkMSecC/d+vrKngEnUXaZ\n9WK3eGnrGPmeW7z5j9uVsimzNlri8i8FNBTGCDx2sgJc16MtYfGhORwN4oVXCHiS\n4A/HVSYMUeR4kGxoX9RUbf8vylRsdEbKQ20M5cbWQAAH5LNig6jERRsuylEh4uJE\nubhEbfhePgZv+mkFQ6tsuIH/5ETSV4v/bg==\n-----END CERTIFICATE-----\n"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h3><p>在shkf6-241和shkf6-242上：</p>
<ul>
<li>拷贝证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]# mkdir /etc/nginx/conf.d/certs</span><br><span class="line"></span><br><span class="line">~]# scp shkf6-245:/opt/certs/dashboard.od.com.crt /etc/nginx/certs/</span><br><span class="line">~]# scp shkf6-245:/opt/certs/dashboard.od.com.key /etc/nginx/certs/</span><br></pre></td></tr></table></figure>

<ul>
<li>配置虚拟主机dashboard.od.com.conf，走https</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# cat /etc/nginx/conf.d/dashboard.od.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate "certs/dashboard.od.com.crt";</span><br><span class="line">    ssl_certificate_key "certs/dashboard.od.com.key";</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重载nginx配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<ul>
<li>刷新页面检查</li>
</ul>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_cc2c885819a8a0b49994178e10d055ba_r.png" alt="null"></p>
<h3 id="获取kubernetes-dashboard-admin-token"><a href="#获取kubernetes-dashboard-admin-token" class="headerlink" title="获取kubernetes-dashboard-admin-token"></a>获取kubernetes-dashboard-admin-token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl get secrets -n kube-system </span><br><span class="line">NAME                                     TYPE                                  DATA   AGE</span><br><span class="line">coredns-token-r5s8r                      kubernetes.io/service-account-token   3      5d19h</span><br><span class="line">default-token-689cg                      kubernetes.io/service-account-token   3      6d14h</span><br><span class="line">kubernetes-dashboard-admin-token-w46s2   kubernetes.io/service-account-token   3      16h</span><br><span class="line">kubernetes-dashboard-key-holder          Opaque                                2      14h</span><br><span class="line">traefik-ingress-controller-token-nkfb8   kubernetes.io/service-account-token   3      5d1h</span><br><span class="line">[root@shkf6-243 ~]# kubectl describe secret kubernetes-dashboard-admin-token-w46s2 -n kube-system |tail</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: 11fedd46-3591-4c15-b32d-5818e5aca7d8</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1346 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi13NDZzMiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjExZmVkZDQ2LTM1OTEtNGMxNS1iMzJkLTU4MThlNWFjYTdkOCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.HkVak9znUafeh4JTkzGRiH3uXVjcuHMTOsmz58xJy1intMn25ouC04KK7uplkAtd_IsA6FFo-Kkdqc3VKZ5u5xeymL2ccLaLiCXnlxAcVta5CuwyyO4AXeS8ss-BMKCAfeIldnqwJRPX2nzORJap3CTLU0Cswln8x8iXisA_gBuNVjiWzJ6tszMRi7vX1BM6rp6bompWfNR1xzBWifjsq8J4zhRYG9sVi9Ec3_BZUEfIc0ozFF91Jc5qCk2L04y8tHBauVuJo_ecgMdJfCDk7VKVnyF3Z-Fb8cELNugmeDlKYvv06YHPyvdxfdt99l6QpvuEetbMGAhh5hPOd9roVw</span><br></pre></td></tr></table></figure>

<h3 id="验证toke登录"><a href="#验证toke登录" class="headerlink" title="验证toke登录"></a>验证toke登录</h3><p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_ca78f8eda1b9f2313e4db8f6b8a5a94c_r.png" alt="null"></p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_14d5d69f3353aa8df4299059efd10383_r.png" alt="null"></p>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_f7fded22ee708f59a805ef8051417953_r.png" alt="null"></p>
<h3 id="升级dashboard为v1-10-1"><a href="#升级dashboard为v1-10-1" class="headerlink" title="升级dashboard为v1.10.1"></a>升级dashboard为v1.10.1</h3><p>在shkf6-245.host.com上：</p>
<ul>
<li><p>更改镜像地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dashboard]# grep image dp.yaml </span><br><span class="line">      image: harbor.od.com/public/kubernetes-dashboard-amd64:v1.10.1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>在shkf6-243.host.com上：</p>
<ul>
<li><p>应用配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="dashboard-官方给的rbac-minimal"><a href="#dashboard-官方给的rbac-minimal" class="headerlink" title="dashboard 官方给的rbac-minimal"></a>dashboard 官方给的rbac-minimal</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">dashboard]#</span><span class="bash"> cat rbac-minimal.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">  namespace: kube-system</span><br><span class="line">rules:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["secrets"]</span><br><span class="line">  resourceNames: ["kubernetes-dashboard-key-holder", "kubernetes-dashboard-certs"]</span><br><span class="line">  verbs: ["get", "update", "delete"]</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow Dashboard to get and update <span class="string">'kubernetes-dashboard-settings'</span> config map.</span></span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["configmaps"]</span><br><span class="line">  resourceNames: ["kubernetes-dashboard-settings"]</span><br><span class="line">  verbs: ["get", "update"]</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Allow Dashboard to get metrics from heapster.</span></span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["services"]</span><br><span class="line">  resourceNames: ["heapster"]</span><br><span class="line">  verbs: ["proxy"]</span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["services/proxy"]</span><br><span class="line">  resourceNames: ["heapster", "http:heapster:", "https:heapster:"]</span><br><span class="line">  verbs: ["get"]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: kubernetes-dashboard-minimal</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<h2 id="部署heapster"><a href="#部署heapster" class="headerlink" title="部署heapster"></a>部署heapster</h2><p><a href="https://github.com/kubernetes-retired/heapster" target="_blank" rel="noopener">heapster官方github地址</a></p>
<h3 id="准备heapster镜像"><a href="#准备heapster镜像" class="headerlink" title="准备heapster镜像"></a>准备heapster镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# docker pull sunrisenan/heapster:v1.5.4</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker images|grep heapster</span><br><span class="line">sunrisenan/heapster                               v1.5.4                     c359b95ad38b        9 months ago        136MB</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# docker tag c359b95ad38b harbor.od.com/public/heapster:v1.5.4</span><br><span class="line">[root@shkf6-245 ~]# docker push !$</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li>rbac.yaml</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/heapster/rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:heapster</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/heapster/dp.yaml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: harbor.od.com/public/heapster:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bitnami/heapster/bin/heapster</span><br><span class="line">        - --source=kubernetes:https://kubernetes.default</span><br></pre></td></tr></table></figure>

<ul>
<li>service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/heapster/svc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: 'true'</span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/heapster/rbac.yaml</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/heapster/dp.yaml</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/heapster/svc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="重启dashboard-可以不重启"><a href="#重启dashboard-可以不重启" class="headerlink" title="重启dashboard(可以不重启)"></a>重启dashboard(可以不重启)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl delete -f http://k8s-yaml.od.com/dashboard/dp.yaml</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/dp.yaml</span><br></pre></td></tr></table></figure>

<h3 id="检查-2"><a href="#检查-2" class="headerlink" title="检查"></a>检查</h3><ul>
<li>主机检查</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl top node</span><br><span class="line">NAME                 CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">shkf6-243.host.com   149m         3%     3643Mi          47%       </span><br><span class="line">shkf6-244.host.com   130m         3%     3300Mi          42%       </span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl top pod -n kube-public </span><br><span class="line">NAME                        CPU(cores)   MEMORY(bytes)   </span><br><span class="line">nginx-dp-5dfc689474-dm555   0m           10Mi</span><br></pre></td></tr></table></figure>

<ul>
<li>浏览器检查</li>
</ul>
<p><img src= "/img/loading.gif" data-src="http://www.sunrisenan.com/uploads/kubernetes/images/m_6e4ce39904dc61713b70c334143ec1b4_r.png" alt="null"></p>
<h1 id="Kubernetes平滑升级"><a href="#Kubernetes平滑升级" class="headerlink" title="Kubernetes平滑升级"></a>Kubernetes平滑升级</h1><p>第一步：观察哪台机器pod少</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 src]# kubectl get nodes</span><br><span class="line">NAME                 STATUS   ROLES         AGE     VERSION</span><br><span class="line">shkf6-243.host.com   Ready    master,node   6d16h   v1.15.2</span><br><span class="line">shkf6-244.host.com   Ready    master,node   6d16h   v1.15.2</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 src]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-6b6c4f9648-x5zvz                1/1     Running   0          5d22h   172.6.244.3   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">heapster-b5b9f794-s2vj9                 1/1     Running   0          76m     172.6.243.4   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-5dbdd9bdd7-qlk52   1/1     Running   0          62m     172.6.244.4   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">traefik-ingress-bhhkv                   1/1     Running   0          5d4h    172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">traefik-ingress-mm2ds                   1/1     Running   0          5d4h    172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>第二步：在负载均衡了禁用7层和4层</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略</span><br></pre></td></tr></table></figure>

<p>第三步：摘除node节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 src]# kubectl delete node shkf6-243.host.com</span><br><span class="line">node "shkf6-243.host.com" deleted</span><br><span class="line">[root@shkf6-243 src]# kubectl get node</span><br><span class="line">NAME                 STATUS   ROLES         AGE     VERSION</span><br><span class="line">shkf6-244.host.com   Ready    master,node   6d17h   v1.15.2</span><br></pre></td></tr></table></figure>

<p>第四步：观察运行POD情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 src]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-6b6c4f9648-x5zvz                1/1     Running   0          5d22h   172.6.244.3   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">heapster-b5b9f794-dlt2z                 1/1     Running   0          15s     172.6.244.6   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-5dbdd9bdd7-qlk52   1/1     Running   0          64m     172.6.244.4   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">traefik-ingress-bhhkv                   1/1     Running   0          5d4h    172.6.244.2   shkf6-244.host.com   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>第五步：检查dns</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 src]# dig -t A kubernetes.default.svc.cluster.local @10.96.0.2 +short</span><br><span class="line">10.96.0.1</span><br></pre></td></tr></table></figure>

<p>第六步：开始升级</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cd /opt/src/</span><br><span class="line">[root@shkf6-243 src]# wget http://down.sunrisenan.com/k8s/kubernetes/kubernetes-server-linux-amd64-v1.15.4.tar.gz</span><br><span class="line">[root@shkf6-243 src]# tar xf kubernetes-server-linux-amd64-v1.15.4.tar.gz</span><br><span class="line">[root@shkf6-243 src]# mv kubernetes /opt/kubernetes-v1.15.4</span><br><span class="line">[root@shkf6-243 src]# cd /opt/</span><br><span class="line">[root@shkf6-243 opt]# rm -f kubernetes</span><br><span class="line">[root@shkf6-243 opt]# ln -s /opt/kubernetes-v1.15.4 kubernetes</span><br><span class="line">[root@shkf6-243 opt]# cd /opt/kubernetes</span><br><span class="line">[root@shkf6-243 kubernetes]# rm -f kubernetes-src.tar.gz </span><br><span class="line">[root@shkf6-243 kubernetes]# cd server/bin/</span><br><span class="line">[root@shkf6-243 bin]# rm -f *.tar</span><br><span class="line">[root@shkf6-243 bin]# rm -f *tag</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/cert .</span><br><span class="line">[root@shkf6-243 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/conf .</span><br><span class="line">[root@shkf6-243 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/*.sh .</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 bin]# systemctl restart supervisord.service </span><br><span class="line"></span><br><span class="line">[root@shkf6-243 bin]# kubectl get node</span><br><span class="line">NAME                 STATUS   ROLES         AGE     VERSION</span><br><span class="line">shkf6-243.host.com   Ready    &lt;none&gt;        16s     v1.15.4</span><br><span class="line">shkf6-244.host.com   Ready    master,node   6d17h   v1.15.2</span><br></pre></td></tr></table></figure>

<p>升级另一台：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 src]# kubectl get node</span><br><span class="line">NAME                 STATUS   ROLES         AGE     VERSION</span><br><span class="line">shkf6-243.host.com   Ready    &lt;none&gt;        95s     v1.15.4</span><br><span class="line">shkf6-244.host.com   Ready    master,node   6d17h   v1.15.2</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 src]# kubectl delete node shkf6-244.host.com</span><br><span class="line">node "shkf6-244.host.com" deleted</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 src]# kubectl get node</span><br><span class="line">NAME                 STATUS   ROLES    AGE    VERSION</span><br><span class="line">shkf6-243.host.com   Ready    &lt;none&gt;   3m2s   v1.15.4</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 src]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP            NODE                 NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-6b6c4f9648-bxqcp                1/1     Running   0          20s     172.6.243.3   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">heapster-b5b9f794-hjx74                 1/1     Running   0          20s     172.6.243.4   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard-5dbdd9bdd7-gj6vc   1/1     Running   0          20s     172.6.243.5   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">traefik-ingress-4hl97                   1/1     Running   0          3m22s   172.6.243.2   shkf6-243.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 src]# dig -t A kubernetes.default.svc.cluster.local @10.96.0.2 +short</span><br><span class="line">10.96.0.1</span><br><span class="line">[root@shkf6-244 src]# wget http://down.sunrisenan.com/k8s/kubernetes/kubernetes-server-linux-amd64-v1.15.4.tar.gz</span><br><span class="line">[root@shkf6-244 src]# tar xf kubernetes-server-linux-amd64-v1.15.4.tar.gz</span><br><span class="line">[root@shkf6-244 src]# mv kubernetes /opt/kubernetes-v1.15.4</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# cd /opt/</span><br><span class="line">[root@shkf6-244 opt]# rm -f kubernetes</span><br><span class="line">[root@shkf6-244 opt]# ln -s /opt/kubernetes-v1.15.4 kubernetes</span><br><span class="line">[root@shkf6-244 opt]# cd kubernetes</span><br><span class="line">[root@shkf6-244 kubernetes]# rm -f kubernetes-src.tar.gz </span><br><span class="line">[root@shkf6-244 kubernetes]# cd server/bin/</span><br><span class="line">[root@shkf6-244 bin]# rm -f *.tar *tag</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/cert .</span><br><span class="line">[root@shkf6-244 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/conf .</span><br><span class="line">[root@shkf6-244 bin]# cp -r /opt/kubernetes-v1.15.2/server/bin/*.sh .</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 bin]# systemctl restart supervisord.service </span><br><span class="line">[root@shkf6-244 kubernetes]# kubectl get node</span><br><span class="line">NAME                 STATUS   ROLES    AGE    VERSION</span><br><span class="line">shkf6-243.host.com   Ready    &lt;none&gt;   16m    v1.15.4</span><br><span class="line">shkf6-244.host.com   Ready    &lt;none&gt;   5m7s   v1.15.4</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">PhenoGao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://xonlab.com/2020/04/01/Kubernetes%E9%83%A8%E7%BD%B2-%E2%85%A1/">http://xonlab.com/2020/04/01/Kubernetes%E9%83%A8%E7%BD%B2-%E2%85%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xonlab.com" target="_blank">XonLab</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-nika-akin-3598435.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/02/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E7%AC%AC1%E7%AB%A0/"><img class="prev-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/background-2731956_1280.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">《娱乐至死》第1章</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/28/Kubernetes%E9%83%A8%E7%BD%B2%E2%85%A0/"><img class="next-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-jo%C3%A3o-v%C3%ADtor-heinrichs-1856183.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes部署 Ⅰ</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/26/Docker基础知识汇编/" title="Docker基础知识汇编"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-mpv1o8.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-26</div><div class="relatedPosts_title">Docker基础知识汇编</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/Kubernetes-ELK部署/" title="Kubernetes-ELK部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-junghua-liu-3063362.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-15</div><div class="relatedPosts_title">Kubernetes-ELK部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Kubernetes-Apollo部署/" title="Kubernetes-apollo部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-1530710.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-04</div><div class="relatedPosts_title">Kubernetes-apollo部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Kubernetes-Prometheus部署/" title="Kubernetes-Prometheus部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/material_design_wallpaper-5.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-09</div><div class="relatedPosts_title">Kubernetes-Prometheus部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/Kubernetes-dubbo部署/" title="Kubernetes-dubbo部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-jo%C3%A3o-v%C3%ADtor-heinrichs-1856183.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-03</div><div class="relatedPosts_title">Kubernetes-dubbo部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/28/Kubernetes部署Ⅰ/" title="Kubernetes部署 Ⅰ"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-jo%C3%A3o-v%C3%ADtor-heinrichs-1856183.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-28</div><div class="relatedPosts_title">Kubernetes部署 Ⅰ</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By PhenoGao</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>