<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kubernetes-apollo部署 | XonLab</title><meta name="description" content="前情回顾 Dubbo微服务 注册中心zookeeper（集群） 提供者（集群） 消费者（集群） 监控（dubbo-monitor&#x2F;dubbo-admin）   在K8s内交付dubbo微服务的步骤： step0：有可用的k8s集群 step1：部署zk集群（通常放在K8S集群外，有状态） step2:部署jenkins（以容器的形式交付在K8S集群内） root、时区、ssh-key、docker"><meta name="keywords" content="Docker,Kubernetes"><meta name="author" content="PhenoGao"><meta name="copyright" content="PhenoGao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://xonlab.com/2020/04/04/Kubernetes-Apollo%E9%83%A8%E7%BD%B2/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes-apollo部署"><meta property="og:url" content="http://xonlab.com/2020/04/04/Kubernetes-Apollo%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="XonLab"><meta property="og:description" content="前情回顾 Dubbo微服务 注册中心zookeeper（集群） 提供者（集群） 消费者（集群） 监控（dubbo-monitor&#x2F;dubbo-admin）   在K8s内交付dubbo微服务的步骤： step0：有可用的k8s集群 step1：部署zk集群（通常放在K8S集群外，有状态） step2:部署jenkins（以容器的形式交付在K8S集群内） root、时区、ssh-key、docker"><meta property="og:image" content="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-969w2k.jpg"><meta property="article:published_time" content="2020-04-03T23:01:28.000Z"><meta property="article:modified_time" content="2021-02-15T04:19:03.051Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="Node.js快速入门" href="http://xonlab.com/2020/04/06/Node-js%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><link rel="next" title="Kubernetes-dubbo部署" href="http://xonlab.com/2020/04/03/Kubernetes-dubbo%E9%83%A8%E7%BD%B2/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://edu-102.oss-cn-beijing.aliyuncs.com/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">105</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">68</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前情回顾"><span class="toc-number">1.</span> <span class="toc-text">前情回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#配置中心的概述"><span class="toc-number">2.</span> <span class="toc-text">配置中心的概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战K8S配置中心-ConfigMap"><span class="toc-number">3.</span> <span class="toc-text">实战K8S配置中心-ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用ConfigMap管理应用配置"><span class="toc-number">3.1.</span> <span class="toc-text">使用ConfigMap管理应用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#拆分环境"><span class="toc-number">3.1.1.</span> <span class="toc-text">拆分环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重配zookeeper"><span class="toc-number">3.1.2.</span> <span class="toc-text">重配zookeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-dubbo-monitor"><span class="toc-number">3.1.3.</span> <span class="toc-text">准备资源配置清单(dubbo-monitor)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单"><span class="toc-number">3.1.4.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新发版，修改dubbo项目的配置文件"><span class="toc-number">3.1.5.</span> <span class="toc-text">重新发版，修改dubbo项目的配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#修改项目源代码"><span class="toc-number">3.1.5.0.1.</span> <span class="toc-text">修改项目源代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#使用Jenkins进行CI"><span class="toc-number">3.1.5.0.2.</span> <span class="toc-text">使用Jenkins进行CI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改-应用资源配置清单"><span class="toc-number">3.1.5.0.3.</span> <span class="toc-text">修改&#x2F;应用资源配置清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证configmap的配置"><span class="toc-number">3.1.6.</span> <span class="toc-text">验证configmap的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#configmap-复杂配置文件处理方法"><span class="toc-number">3.1.7.</span> <span class="toc-text">configmap 复杂配置文件处理方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#apollo配置中心介绍"><span class="toc-number">4.</span> <span class="toc-text">apollo配置中心介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战交付apollo配置中心组件–configservice到kubernetes集群"><span class="toc-number">5.</span> <span class="toc-text">实战交付apollo配置中心组件–configservice到kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备软件包"><span class="toc-number">5.1.</span> <span class="toc-text">准备软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装数据库"><span class="toc-number">5.2.</span> <span class="toc-text">安装数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行数据库脚本"><span class="toc-number">5.3.</span> <span class="toc-text">执行数据库脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库用户授权"><span class="toc-number">5.4.</span> <span class="toc-text">数据库用户授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改初始数据"><span class="toc-number">5.5.</span> <span class="toc-text">修改初始数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制作docker镜像"><span class="toc-number">5.6.</span> <span class="toc-text">制作docker镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析域名"><span class="toc-number">5.7.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备资源配置清单"><span class="toc-number">5.8.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用资源配置清单-1"><span class="toc-number">5.9.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问"><span class="toc-number">5.10.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析mysql连接ip"><span class="toc-number">5.11.</span> <span class="toc-text">分析mysql连接ip</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战交付apollo配置中心组件–adminservice到kubernetes集群"><span class="toc-number">6.</span> <span class="toc-text">实战交付apollo配置中心组件–adminservice到kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备软件包-1"><span class="toc-number">6.1.</span> <span class="toc-text">准备软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制作Docker镜像"><span class="toc-number">6.2.</span> <span class="toc-text">制作Docker镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备配置文件"><span class="toc-number">6.3.</span> <span class="toc-text">准备配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用配置清单"><span class="toc-number">6.4.</span> <span class="toc-text">应用配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问-1"><span class="toc-number">6.5.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战交付apollo配置中心组件–portal到kubernetes集群"><span class="toc-number">7.</span> <span class="toc-text">实战交付apollo配置中心组件–portal到kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备软件包-2"><span class="toc-number">7.1.</span> <span class="toc-text">准备软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行数据库脚本-1"><span class="toc-number">7.2.</span> <span class="toc-text">执行数据库脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库用户授权-1"><span class="toc-number">7.3.</span> <span class="toc-text">数据库用户授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#制作Docker镜像-1"><span class="toc-number">7.4.</span> <span class="toc-text">制作Docker镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解析域名-1"><span class="toc-number">7.5.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备资源配置清单-1"><span class="toc-number">7.6.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用资源配置清单-2"><span class="toc-number">7.7.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器访问-2"><span class="toc-number">7.8.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战配置dubbo微服务接入apollo配置中心管理"><span class="toc-number">8.</span> <span class="toc-text">实战配置dubbo微服务接入apollo配置中心管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#改造dubbo-demo-service项目"><span class="toc-number">8.1.</span> <span class="toc-text">改造dubbo-demo-service项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用IDE拉取项目（这里使用git-bash作为范例）"><span class="toc-number">8.1.1.</span> <span class="toc-text">使用IDE拉取项目（这里使用git bash作为范例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#切到apollo分支"><span class="toc-number">8.1.2.</span> <span class="toc-text">切到apollo分支</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改pom-xml"><span class="toc-number">8.1.3.</span> <span class="toc-text">修改pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#增加resources目录"><span class="toc-number">8.1.4.</span> <span class="toc-text">增加resources目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改config-properties文件"><span class="toc-number">8.1.5.</span> <span class="toc-text">修改config.properties文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改srping-config-xml文件"><span class="toc-number">8.1.6.</span> <span class="toc-text">修改srping-config.xml文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置apollo-portal"><span class="toc-number">8.2.</span> <span class="toc-text">配置apollo-portal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建项目"><span class="toc-number">8.2.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进入配置界面"><span class="toc-number">8.2.2.</span> <span class="toc-text">进入配置界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发布配置"><span class="toc-number">8.2.3.</span> <span class="toc-text">发布配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用jenkins进行CI"><span class="toc-number">8.3.</span> <span class="toc-text">使用jenkins进行CI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#上线新构建的项目"><span class="toc-number">8.4.</span> <span class="toc-text">上线新构建的项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-2"><span class="toc-number">8.4.1.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-3"><span class="toc-number">8.4.2.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#观察项目运行情况"><span class="toc-number">8.4.3.</span> <span class="toc-text">观察项目运行情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#改造dubbo-demo-web"><span class="toc-number">8.5.</span> <span class="toc-text">改造dubbo-demo-web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置apollo-portal-1"><span class="toc-number">8.6.</span> <span class="toc-text">配置apollo-portal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建项目-1"><span class="toc-number">8.6.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#进入配置页面"><span class="toc-number">8.6.2.</span> <span class="toc-text">进入配置页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发布配置-1"><span class="toc-number">8.6.3.</span> <span class="toc-text">发布配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用jenkins进行CI-1"><span class="toc-number">8.7.</span> <span class="toc-text">使用jenkins进行CI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#上线新构建的项目-1"><span class="toc-number">8.8.</span> <span class="toc-text">上线新构建的项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#准备资源配置清单-3"><span class="toc-number">8.8.1.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用资源配置清单-4"><span class="toc-number">8.8.2.</span> <span class="toc-text">应用资源配置清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过Apollo配置中心动态维护项目的配置"><span class="toc-number">8.9.</span> <span class="toc-text">通过Apollo配置中心动态维护项目的配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实战使用apollo配置中心管理测试环境和生产环境"><span class="toc-number">9.</span> <span class="toc-text">实战使用apollo配置中心管理测试环境和生产环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#实战维护多套dubbo微服务环境"><span class="toc-number">9.1.</span> <span class="toc-text">实战维护多套dubbo微服务环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生产实践"><span class="toc-number">9.1.1.</span> <span class="toc-text">生产实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统架构"><span class="toc-number">9.1.2.</span> <span class="toc-text">系统架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改-添加域名解析"><span class="toc-number">9.1.3.</span> <span class="toc-text">修改&#x2F;添加域名解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apollo的k8s应用配置"><span class="toc-number">9.1.4.</span> <span class="toc-text">Apollo的k8s应用配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apollo的portal配置"><span class="toc-number">9.1.5.</span> <span class="toc-text">Apollo的portal配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#管理员工具"><span class="toc-number">9.1.5.1.</span> <span class="toc-text">管理员工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#系统参数"><span class="toc-number">9.1.5.2.</span> <span class="toc-text">系统参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#新建dubbo-demo-service和dubbo-demo-web项目"><span class="toc-number">9.1.6.</span> <span class="toc-text">新建dubbo-demo-service和dubbo-demo-web项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发布dubbo微服务"><span class="toc-number">9.1.7.</span> <span class="toc-text">发布dubbo微服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分环境"><span class="toc-number">9.2.</span> <span class="toc-text">分环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第一阶段-解析域名"><span class="toc-number">9.2.1.</span> <span class="toc-text">第一阶段 解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二阶段-Portal设置"><span class="toc-number">9.2.2.</span> <span class="toc-text">第二阶段 Portal设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三阶段-测试环境"><span class="toc-number">9.2.3.</span> <span class="toc-text">第三阶段 测试环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第四阶段-生产环境"><span class="toc-number">9.2.4.</span> <span class="toc-text">第四阶段 生产环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#知识点："><span class="toc-number">9.2.5.</span> <span class="toc-text">知识点：</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-969w2k.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">XonLab</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Kubernetes-apollo部署</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2020-04-04 07:01:28"><i class="fa-fw far fa-calendar-alt"></i> 发表于 2020-04-04</time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta__icon"></i><span>字数总计:</span><span class="word-count">8.5k</span><span class="post-meta__separator">|</span><i class="far fa-clock fa-fw post-meta__icon"></i><span>阅读时长: 43 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="前情回顾"><a href="#前情回顾" class="headerlink" title="前情回顾"></a>前情回顾</h1><ul>
<li>Dubbo微服务<ul>
<li>注册中心zookeeper（集群）</li>
<li>提供者（集群）</li>
<li>消费者（集群）</li>
<li>监控（dubbo-monitor/dubbo-admin）</li>
</ul>
</li>
<li>在K8s内交付dubbo微服务的步骤：<ul>
<li>step0：有可用的k8s集群</li>
<li>step1：部署zk集群（通常放在K8S集群外，有状态）</li>
<li>step2:部署jenkins（以容器的形式交付在K8S集群内）<ul>
<li>root、时区、ssh-key、docker客户端、harbor连接配置</li>
</ul>
</li>
<li>step3:部署maven软件</li>
<li>step4:制作dubbo微服务底包</li>
<li>step5：配置jenkins持续构建（CI）流水线</li>
<li>step6：使用流水线构建项目，查看harbor仓库</li>
<li>step7：使用资源配置清单，交付项目到K8S集群</li>
</ul>
</li>
<li>交付dubbo-monitor</li>
<li>考虑我们交付进K8S集群的两个dubbo微服务和一个monitor，最大的问题是什么？<ul>
<li>他们的配置写死在容器里了！</li>
</ul>
</li>
</ul>
<h1 id="配置中心的概述"><a href="#配置中心的概述" class="headerlink" title="配置中心的概述"></a>配置中心的概述</h1><ul>
<li><p>配置其实是独立于程序的可配置变量，同一份程序在不同配置下会有不同的行为，常见的配置有连接字符串，应用配置和业务配置等。</p>
</li>
<li><p>配置有多种形态，下面是一些常见的：</p>
<ul>
<li>程序内部hardcode，这种做法是反模式，一般我们不建议！</li>
<li>配置文件，比如spring应用程序的配置一般放在application.properties文件中。</li>
<li>环境变量，配置可以预置在操作系统的环境变量里头，程序运行时读取。</li>
<li>启动参数，可以预置在操作系统的环境变量里头，程序运行时读取。</li>
<li>启动参数，可以在程序启动时一次性提供参数，例如java程序启动时可以通过java -D 方式配启动参数。</li>
<li>基于数据库，有经验的开发人员把易变配置放在数据库中，这样可以在运行期灵活调整配置。</li>
</ul>
</li>
<li><p>配置管理的现状：</p>
<ul>
<li>配置散乱格式不标准（xml、ini、conf、yaml…）</li>
<li>主要采用本地静态配置，应用多副本下配置修改麻烦</li>
<li>易引发生产事故（测试环境。生产环境配置混用）</li>
<li>配置缺乏安全审计和版本控制功能（config review）</li>
<li>不同环境的应用，配置不同，造成多次打包，测试失效</li>
</ul>
</li>
<li><p>配置中心是什么？</p>
<ul>
<li>顾名思义，就是集中管理应用程序配置的“中心”。</li>
</ul>
</li>
<li><p>常见的配置中心有：</p>
<ul>
<li>XDiamond：全局配置中心，存储应用的配置项，解决配置换乱分散的问题。名字来源于淘宝的开源项目diamond，前面加一个字母X以示区别。</li>
<li>Qconf：Qconf是一个分布式配置管理工具。用来替代传统的配置文件，使得配置信息和程序代码分离，同时配置变化能够实时同步到客户端，而且保证用户高效读取配置，这使得工程师从琐碎的配置修改、代码提交、配置上线流程中解放出来，极大地简化了配置管理工作。</li>
<li>Disconf：专注于各种【分布式系统配置管理】的【通用组件】和【通用平台】，提供统一的【配置管理服务】</li>
<li>SpringCloudConfig：Spring Cloud Config为分布式系统中的外部配置提供服务器和客户端支持。</li>
<li>K8S ConfigMap：K8S的一种标准资源，专门用来集中管理应用的配置。</li>
<li>Apollo：携程框架部门开源的，分布式配置中心。</li>
</ul>
</li>
</ul>
<h1 id="实战K8S配置中心-ConfigMap"><a href="#实战K8S配置中心-ConfigMap" class="headerlink" title="实战K8S配置中心-ConfigMap"></a>实战K8S配置中心-ConfigMap</h1><h2 id="使用ConfigMap管理应用配置"><a href="#使用ConfigMap管理应用配置" class="headerlink" title="使用ConfigMap管理应用配置"></a>使用ConfigMap管理应用配置</h2><h3 id="拆分环境"><a href="#拆分环境" class="headerlink" title="拆分环境"></a>拆分环境</h3><table>
<thead>
<tr>
<th align="left">主机名</th>
<th align="left">角色</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">shkf6-241.host.com</td>
<td align="left">zk1.od.com(Test环境)</td>
<td align="left">192.168.6.241</td>
</tr>
<tr>
<td align="left">shkf6-242.host.com</td>
<td align="left">zk2.od.com(Prod环境)</td>
<td align="left">192.168.6.242</td>
</tr>
</tbody></table>
<h3 id="重配zookeeper"><a href="#重配zookeeper" class="headerlink" title="重配zookeeper"></a>重配zookeeper</h3><p>在shkf6-241.host.com主机上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# vi /opt/zookeeper/conf/zoo.cfg </span><br><span class="line">[root@shkf6-241 ~]# cat /opt/zookeeper/conf/zoo.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p>在shkf6-242.host.com主机上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-242 ~]# vi /opt/zookeeper/conf/zoo.cfg </span><br><span class="line">[root@shkf6-242 ~]# cat /opt/zookeeper/conf/zoo.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p>重启zk(删除数据文件)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# rm -rf /data/zookeeper/data/* &amp;&amp; rm -rf /data/zookeeper/logs/*</span><br><span class="line">[root@shkf6-242 ~]# rm -rf /data/zookeeper/data/* &amp;&amp; rm -rf /data/zookeeper/logs/*</span><br><span class="line"></span><br><span class="line">[root@shkf6-241 ~]# /opt/zookeeper/bin/zkServer.sh restart &amp;&amp; /opt/zookeeper/bin/zkServer.sh status</span><br><span class="line">[root@shkf6-242 ~]# /opt/zookeeper/bin/zkServer.sh restart &amp;&amp; /opt/zookeeper/bin/zkServer.sh status</span><br><span class="line">[root@shkf6-243 ~]# /opt/zookeeper/bin/zkServer.sh stop</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-dubbo-monitor"><a href="#准备资源配置清单-dubbo-monitor" class="headerlink" title="准备资源配置清单(dubbo-monitor)"></a>准备资源配置清单(dubbo-monitor)</h3><p>在运维主机shkf6-245.host.com上：</p>
<ul>
<li>configmap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dubbo-monitor-cm]# cat /data/k8s-yaml/dubbo-monitor-cm/cm.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  dubbo.properties: |</span><br><span class="line">    dubbo.container=log4j,spring,registry,jetty</span><br><span class="line">    dubbo.application.name=simple-monitor</span><br><span class="line">    dubbo.application.owner=</span><br><span class="line">    dubbo.registry.address=zookeeper://zk1.od.com:2181</span><br><span class="line">    dubbo.protocol.port=20880</span><br><span class="line">    dubbo.jetty.port=8080</span><br><span class="line">    dubbo.jetty.directory=/dubbo-monitor-simple/monitor</span><br><span class="line">    dubbo.charts.directory=/dubbo-monitor-simple/charts</span><br><span class="line">    dubbo.statistics.directory=/dubbo-monitor-simple/statistics</span><br><span class="line">    dubbo.log4j.file=/dubbo-monitor-simple/logs/dubbo-monitor.log</span><br><span class="line">    dubbo.log4j.level=WARN</span><br></pre></td></tr></table></figure>

<ul>
<li>deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 dubbo-monitor-cm]# cat /data/k8s-yaml/dubbo-monitor-cm/dp.yaml</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-monitor</span><br><span class="line">        name: dubbo-monitor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-monitor</span><br><span class="line">        image: harbor.od.com/infra/dubbo-monitor:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: configmap-volume</span><br><span class="line">            mountPath: /dubbo-monitor-simple/conf</span><br><span class="line">      volumes:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: dubbo-monitor-cm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor-cm/cm.yaml</span><br><span class="line">configmap/dubbo-monitor-cm created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor-cm/dp.yaml</span><br><span class="line">deployment.extensions/dubbo-monitor configured</span><br></pre></td></tr></table></figure>

<h3 id="重新发版，修改dubbo项目的配置文件"><a href="#重新发版，修改dubbo项目的配置文件" class="headerlink" title="重新发版，修改dubbo项目的配置文件"></a>重新发版，修改dubbo项目的配置文件</h3><h5 id="修改项目源代码"><a href="#修改项目源代码" class="headerlink" title="修改项目源代码"></a>修改项目源代码</h5><ul>
<li>duboo-demo-service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dubbo-server/src/main/java/config.properties   #代码中的路径</span><br><span class="line"></span><br><span class="line">dubbo.registry=zookeeper:<span class="comment">//zk1.od.com:2181</span></span><br><span class="line">dubbo.port=<span class="number">28080</span></span><br></pre></td></tr></table></figure>

<ul>
<li>dubbo-demo-web</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dubbo-client/src/main/java/config.properties  #代码中的路径</span><br><span class="line"></span><br><span class="line">dubbo.registry=zookeeper:<span class="comment">//zk1.od.com:2181</span></span><br></pre></td></tr></table></figure>

<h5 id="使用Jenkins进行CI"><a href="#使用Jenkins进行CI" class="headerlink" title="使用Jenkins进行CI"></a>使用Jenkins进行CI</h5><p>略</p>
<h5 id="修改-应用资源配置清单"><a href="#修改-应用资源配置清单" class="headerlink" title="修改/应用资源配置清单"></a>修改/应用资源配置清单</h5><p>k8s的dashboard上，修改deployment使用的容器版本，提交应用</p>
<h3 id="验证configmap的配置"><a href="#验证configmap的配置" class="headerlink" title="验证configmap的配置"></a>验证configmap的配置</h3><p>在K8S的dashboard上，修改dubbo-monitor的configmap配置为不同的zk，重启POD，浏览器打开<a href="http://dubbo-monitor.od.com/" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a> 观察效果</p>
<h3 id="configmap-复杂配置文件处理方法"><a href="#configmap-复杂配置文件处理方法" class="headerlink" title="configmap 复杂配置文件处理方法"></a>configmap 复杂配置文件处理方法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# cd /opt/kubernetes/server/bin/conf/</span><br><span class="line">[root@shkf6-243 conf]# ll</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r-- 1 root root 2223 Nov 27 16:46 audit.yaml</span><br><span class="line">-rw-r--r-- 1 root root  258 Nov 27 16:46 k8s-node.yaml</span><br><span class="line">-rw------- 1 root root 6198 Nov 27 16:46 kubelet.kubeconfig   # 把这个配置做成configmap</span><br><span class="line">-rw------- 1 root root 6218 Nov 27 16:46 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 conf]# kubectl create cm kubelet-configmap --from-file=./kubelet.kubeconfig </span><br><span class="line">configmap/kubelet-configmap created</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 conf]# kubectl get cm kubelet-configmap -o yaml</span><br></pre></td></tr></table></figure>

<h1 id="apollo配置中心介绍"><a href="#apollo配置中心介绍" class="headerlink" title="apollo配置中心介绍"></a>apollo配置中心介绍</h1><p><strong>Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</strong></p>
<p>官方GitHub地址：<br><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">Apollo官方地址</a></p>
<p><a href="https://github.com/ctripcorp/apollo/releases" target="_blank" rel="noopener">官方release包</a></p>
<ul>
<li>基础架构</li>
</ul>
<img src = "/images/m_7019e15a1f6db2ff97430f6676e1ddfd_r.png">

<blockquote>
<ol>
<li>Cconfig Service提供配置的读取、推送等功能，服务对象是Apollo客户端</li>
<li>Admin Service提供配置的修改、发布等功能，服务对象是Apollo Portal（管理界面）</li>
<li>Config Service和Admin Server都是多实例、无状态部署，所以需要将自己注册到Eureka中并保持心跳</li>
<li>在Eureka之上我们架了一层Meta Server用于封装Eureka的服务发现接口</li>
<li>Client通过域名访问Meta Server获取Config Server服务列表（IP+Port），而后直接通过IP+Port访问服务，同时在Client测绘做load balance、错误重试</li>
<li>Portal通过域名访问Meta Server获取Admin Service服务列表（IP + port），而后直接通过IP+Port访问服务，同时在Portal测绘做load balance、错误重试</li>
</ol>
</blockquote>
<ul>
<li>简化模型</li>
</ul>
<img src = "/images/m_df1ee811cd18d04e4a6acc9e3432fc47_r.png">

<h1 id="实战交付apollo配置中心组件–configservice到kubernetes集群"><a href="#实战交付apollo配置中心组件–configservice到kubernetes集群" class="headerlink" title="实战交付apollo配置中心组件–configservice到kubernetes集群"></a>实战交付apollo配置中心组件–configservice到kubernetes集群</h1><h2 id="准备软件包"><a href="#准备软件包" class="headerlink" title="准备软件包"></a>准备软件包</h2><p>在运维主机shkf6-245.host.com上：</p>
<p><a href="https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-configservice-1.5.1-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# wget -O /opt/src/apollo-configservice-1.5.1-github.zip https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-configservice-1.5.1-github.zip</span><br><span class="line">[root@shkf6-245 ~]# mkdir /data/dockerfile/apollo-configservice &amp;&amp; unzip -o /opt/src/apollo-configservice-1.5.1-github.zip -d /data/dockerfile/apollo-configservice</span><br></pre></td></tr></table></figure>

<h2 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h2><p>在数据库主机shkf6-241.host.com上：</p>
<p>注意：MySQL版本应为5.6或以上！</p>
<ul>
<li>更新yum源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# cat /etc/yum.repos.d/MariaDB.repo</span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64/</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>

<ul>
<li>导入GPG-KEY</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# rpm --import https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br></pre></td></tr></table></figure>

<ul>
<li>安装数据库版本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# yum list mariadb-server --show-duplicates</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * epel: my.mirrors.thegigabit.com</span><br><span class="line"> * extras: mirrors.huaweicloud.com</span><br><span class="line"> * updates: mirrors.huaweicloud.com</span><br><span class="line">Available Packages</span><br><span class="line">MariaDB-server.x86_64                                          10.1.40-1.el7.centos                                           mariadb</span><br><span class="line">MariaDB-server.x86_64                                          10.1.41-1.el7.centos                                           mariadb</span><br><span class="line">MariaDB-server.x86_64                                          10.1.43-1.el7.centos                                           mariadb</span><br><span class="line">mariadb-server.x86_64                                          1:5.5.64-1.el7                                                 base</span><br><span class="line"></span><br><span class="line">[root@shkf6-241 ~]# yum install MariaDB-server -y</span><br></pre></td></tr></table></figure>

<ul>
<li>配置数据库字符集</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# grep utf8mb4 /etc/my.cnf.d/mysql-clients.cnf</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[root@shkf6-241 ~]# grep utf8mb4 /etc/my.cnf.d/server.cnf </span><br><span class="line">character_set_server = utf8mb4</span><br><span class="line">collation_server = utf8mb4_general_ci</span><br><span class="line">init_connect = "SET NAMES 'utf8mb4'"</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server = utf8mb4</span><br><span class="line">collation_server = utf8mb4_general_ci</span><br><span class="line">init_connect = "SET NAMES 'utf8mb4'"</span><br></pre></td></tr></table></figure>

<ul>
<li><p>启动数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# systemctl start mariadb.service </span><br><span class="line">[root@shkf6-241 ~]# netstat -lntup|grep 3306</span><br><span class="line">tcp6       0      0 :::3306                 :::*                    LISTEN      14887/mysqld </span><br><span class="line">[root@shkf6-241 ~]# systemctl enable mariadb.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置数据管理员密码</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# mysqladmin -u root password</span><br><span class="line">New password: （123456）</span><br><span class="line">Confirm new password: （123456）</span><br></pre></td></tr></table></figure>

<ul>
<li>检查数据库配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 10.1.43-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; \s</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 10.1.43-MariaDB, for Linux (x86_64) using readline 5.1</span><br><span class="line">......</span><br><span class="line">Server characterset:    utf8mb4</span><br><span class="line">Db     characterset:    utf8mb4</span><br><span class="line">Client characterset:    utf8mb4</span><br><span class="line">Conn.  characterset:    utf8mb4</span><br><span class="line">UNIX socket:        /var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:            3 min 51 sec</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; drop database test;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<h2 id="执行数据库脚本"><a href="#执行数据库脚本" class="headerlink" title="执行数据库脚本"></a>执行数据库脚本</h2><p><a href="https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql" target="_blank" rel="noopener">数据库脚本地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# mysql -uroot -p &lt; apolloconfig.sql </span><br><span class="line">Enter password: （123456）</span><br></pre></td></tr></table></figure>

<h2 id="数据库用户授权"><a href="#数据库用户授权" class="headerlink" title="数据库用户授权"></a>数据库用户授权</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [ApolloConfigDB]&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to "apolloconfig"@"192.168.6.%" identified by "123456";</span><br></pre></td></tr></table></figure>

<h2 id="修改初始数据"><a href="#修改初始数据" class="headerlink" title="修改初始数据"></a>修改初始数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [ApolloConfigDB]&gt; update ApolloConfigDB.ServerConfig set ServerConfig.Value="http://config.od.com/eureka" where ServerConfig.Key="eureka.service.url";</span><br><span class="line"></span><br><span class="line">MariaDB [ApolloConfigDB]&gt; select * from ServerConfig\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                       Id: 1</span><br><span class="line">                      Key: eureka.service.url</span><br><span class="line">                  Cluster: default</span><br><span class="line">                    Value: http://config.od.com/eureka</span><br><span class="line">                  <span class="keyword">Comment</span>: Eureka服务<span class="keyword">Url</span>，多个service以英文逗号分隔</span><br><span class="line">                IsDeleted:  </span><br><span class="line">     DataChange_CreatedBy: <span class="keyword">default</span></span><br><span class="line">   DataChange_CreatedTime: <span class="number">2019</span><span class="number">-12</span><span class="number">-10</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">44</span></span><br><span class="line">DataChange_LastModifiedBy: </span><br><span class="line">      DataChange_LastTime: <span class="number">2019</span><span class="number">-12</span><span class="number">-10</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">53</span></span><br></pre></td></tr></table></figure>

<h2 id="制作docker镜像"><a href="#制作docker镜像" class="headerlink" title="制作docker镜像"></a>制作docker镜像</h2><p>在运维主机shkf6-245.host.com上：</p>
<ul>
<li>删除无用的数据</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cd /data/dockerfile/apollo-configservice/</span><br><span class="line">[root@shkf6-245 apollo-configservice]# rm -f apollo-configservice-1.5.1-sources.jar</span><br><span class="line">[root@shkf6-245 apollo-configservice]# rm -f scripts/shutdown.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>配置数据库连接串（这里可以不改，可以用cm挂载）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat config/application-github.properties</span><br><span class="line"><span class="meta">#</span><span class="bash"> DataSource</span></span><br><span class="line">spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = apolloconfig</span><br><span class="line">spring.datasource.password = 123456</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">apollo.eureka.server.enabled=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">apollo.eureka.client.enabled=<span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置启动脚本</li>
</ul>
<p><a href="https://raw.githubusercontent.com/ctripcorp/apollo/1.5.1/scripts/apollo-on-kubernetes/apollo-config-server/scripts/startup-kubernetes.sh" target="_blank" rel="noopener">官方提供的k8s启动脚本</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat scripts/startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">SERVICE_NAME=apollo-configservice</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust log dir if necessary</span></span></span><br><span class="line">LOG_DIR=/opt/logs/apollo-config-server</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust server port if necessary</span></span></span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_CONFIG_SERVICE_NAME=$(hostname -i)</span><br><span class="line"></span><br><span class="line">SERVER_URL="http://$&#123;APOLLO_CONFIG_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust memory settings if necessary</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"-Xms6144m -Xmx6144m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=4096m -XX:MaxNewSize=4096m -XX:SurvivorRatio=8"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Only uncomment the following when you are using server jvm</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -server -XX:-ReduceInitialCardMarks"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########## The following is the same for configservice, adminservice, portal ###########</span></span></span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"</span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Find Java</span></span><br><span class="line">if [[ -n "$JAVA_HOME" ]] &amp;&amp; [[ -x "$JAVA_HOME/bin/java" ]]; then</span><br><span class="line">    javaexe="$JAVA_HOME/bin/java"</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x "/usr/bin/java" ]];  then</span><br><span class="line">    javaexe="/usr/bin/java"</span><br><span class="line">else</span><br><span class="line">    echo "Unable to find Java"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$javaexe" ]]; then</span><br><span class="line">    version=$("$javaexe" -version 2&gt;&amp;1 | awk -F '"' '/version/ &#123;print $2&#125;')</span><br><span class="line">    version=$(echo "$version" | awk -F. '&#123;printf("%03d%03d",$1,$2);&#125;')</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf "$(date) ==== Starting ==== \n"</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME".jar"</span><br><span class="line">./$SERVICE_NAME".jar" start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>

<ul>
<li>写Dockerfile</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat Dockerfile </span><br><span class="line">FROM sunrisenan/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.5.1</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo "Asia/Shanghai" &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-configservice-$&#123;VERSION&#125;.jar /apollo-configservice/apollo-configservice.jar</span><br><span class="line">ADD config/ /apollo-configservice/config</span><br><span class="line">ADD scripts/ /apollo-configservice/scripts</span><br><span class="line"></span><br><span class="line">CMD ["/apollo-configservice/scripts/startup.sh"]</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像并推送</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# docker build . -t harbor.od.com/infra/apollo-configservice:v1.5.1</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 apollo-configservice]# docker push harbor.od.com/infra/apollo-configservice:v1.5.1</span><br></pre></td></tr></table></figure>

<h2 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h2><p>DNS主机shkf6-241.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -2 /var/named/od.com.zone </span><br><span class="line">mysql              A    192.168.6.241</span><br><span class="line">config             A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><p>在运维主机shkf6-245.host.com上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# mkdir /data/k8s-yaml/apollo-configservice &amp;&amp; cd /data/k8s-yaml/apollo-configservice</span><br></pre></td></tr></table></figure>

<ul>
<li>ConfigMap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat cm.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config.od.com/eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003171</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat dp.yaml </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-configservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-configservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-configservice </span><br><span class="line">        name: apollo-configservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-configservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-configservice</span><br><span class="line">        image: harbor.od.com/infra/apollo-configservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-configservice/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat svc.yaml </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: apollo-configservice</span><br></pre></td></tr></table></figure>

<ul>
<li>Ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-configservice]# cat ingress.yaml </span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: config.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: apollo-configservice</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>

<h2 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/cm.yaml</span><br><span class="line">configmap/apollo-configservice-cm created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/dp.yaml</span><br><span class="line">deployment.extensions/apollo-configservice created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/svc.yaml</span><br><span class="line">service/apollo-configservice created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/ingress.yaml</span><br><span class="line">ingress.extensions/apollo-configservice created</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://config.od.com/" target="_blank" rel="noopener">http://config.od.com</a></p>
<h2 id="分析mysql连接ip"><a href="#分析mysql连接ip" class="headerlink" title="分析mysql连接ip"></a>分析mysql连接ip</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [ApolloConfigDB]&gt; show processlist;</span><br><span class="line">+----+--------------+---------------------+----------------+---------+------+-------+------------------+----------+</span><br><span class="line">| Id | User         | Host                | db             | Command | Time | State | Info             | Progress |</span><br><span class="line">+----+--------------+---------------------+----------------+---------+------+-------+------------------+----------+</span><br><span class="line">|  5 | root         | localhost           | ApolloConfigDB | Query   |    0 | init  | show processlist |    0.000 |</span><br><span class="line">|  7 | apolloconfig | 192.168.6.243:46834 | ApolloConfigDB | Sleep   |    0 |       | NULL             |    0.000 |</span><br><span class="line">|  8 | apolloconfig | 192.168.6.243:46836 | ApolloConfigDB | Sleep   |    0 |       | NULL             |    0.000 |</span><br><span class="line">|  9 | apolloconfig | 192.168.6.243:46838 | ApolloConfigDB | Sleep   |    0 |       | NULL             |    0.000 |</span><br><span class="line">| 10 | apolloconfig | 192.168.6.243:46840 | ApolloConfigDB | Sleep   | 1218 |       | NULL             |    0.000 |</span><br><span class="line">| 11 | apolloconfig | 192.168.6.243:46842 | ApolloConfigDB | Sleep   | 1218 |       | NULL             |    0.000 |</span><br><span class="line">| 12 | apolloconfig | 192.168.6.243:46844 | ApolloConfigDB | Sleep   | 1217 |       | NULL             |    0.000 |</span><br><span class="line">| 13 | apolloconfig | 192.168.6.243:46846 | ApolloConfigDB | Sleep   | 1217 |       | NULL             |    0.000 |</span><br><span class="line">| 14 | apolloconfig | 192.168.6.243:46848 | ApolloConfigDB | Sleep   | 1217 |       | NULL             |    0.000 |</span><br><span class="line">| 15 | apolloconfig | 192.168.6.243:46850 | ApolloConfigDB | Sleep   | 1217 |       | NULL             |    0.000 |</span><br><span class="line">| 16 | apolloconfig | 192.168.6.243:46852 | ApolloConfigDB | Sleep   | 1217 |       | NULL             |    0.000 |</span><br><span class="line">+----+--------------+---------------------+----------------+---------+------+-------+------------------+----------+</span><br></pre></td></tr></table></figure>

<h1 id="实战交付apollo配置中心组件–adminservice到kubernetes集群"><a href="#实战交付apollo配置中心组件–adminservice到kubernetes集群" class="headerlink" title="实战交付apollo配置中心组件–adminservice到kubernetes集群"></a>实战交付apollo配置中心组件–adminservice到kubernetes集群</h1><h2 id="准备软件包-1"><a href="#准备软件包-1" class="headerlink" title="准备软件包"></a>准备软件包</h2><p>在运维主机shkf6-245.host.com上：</p>
<p><a href="https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-adminservice-1.5.1-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<ul>
<li>下载并解压</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# wget -O /opt/src/apollo-adminservice-1.5.1-github.zip https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-adminservice-1.5.1-github.zip</span><br><span class="line">[root@shkf6-245 ~]# mkdir /data/dockerfile/apollo-adminservice &amp;&amp; unzip -o /opt/src/apollo-adminservice-1.5.1-github.zip -d /data/dockerfile/apollo-adminservice</span><br></pre></td></tr></table></figure>

<ul>
<li>删除无用的文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# rm -f /data/dockerfile/apollo-adminservice/apollo-adminservice-1.5.1-sources.jar </span><br><span class="line">[root@shkf6-245 ~]# rm -f /data/dockerfile/apollo-adminservice/apollo-adminservice.conf</span><br><span class="line">[root@shkf6-245 ~]# rm -f /data/dockerfile/apollo-adminservice/scripts/shutdown.sh</span><br><span class="line">[root@shkf6-245 ~]# cat /data/dockerfile/apollo-adminservice/config/app.properties </span><br><span class="line">appId=100003172</span><br><span class="line">jdkVersion=1.8</span><br></pre></td></tr></table></figure>

<h2 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h2><p>在运维主机shkf6-245.host.com上：</p>
<ul>
<li>配置数据库连接串</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/dockerfile/apollo-adminservice/config/application-github.properties</span><br><span class="line"><span class="meta">#</span><span class="bash"> DataSource</span></span><br><span class="line">spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = apolloconfig</span><br><span class="line">spring.datasource.password = 123456</span><br></pre></td></tr></table></figure>

<ul>
<li>修改启动脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/dockerfile/apollo-adminservice/scripts/startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">SERVICE_NAME=apollo-adminservice</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust log dir if necessary</span></span></span><br><span class="line">LOG_DIR=/opt/logs/apollo-admin-server</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust server port if necessary</span></span></span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_ADMIN_SERVICE_NAME=$(hostname -i)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> SERVER_URL=<span class="string">"http://localhost:<span class="variable">$&#123;SERVER_PORT&#125;</span>"</span></span></span><br><span class="line">SERVER_URL="http://$&#123;APOLLO_ADMIN_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust memory settings if necessary</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Only uncomment the following when you are using server jvm</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -server -XX:-ReduceInitialCardMarks"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########## The following is the same for configservice, adminservice, portal ###########</span></span></span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"</span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Find Java</span></span><br><span class="line">if [[ -n "$JAVA_HOME" ]] &amp;&amp; [[ -x "$JAVA_HOME/bin/java" ]]; then</span><br><span class="line">    javaexe="$JAVA_HOME/bin/java"</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x "/usr/bin/java" ]];  then</span><br><span class="line">    javaexe="/usr/bin/java"</span><br><span class="line">else</span><br><span class="line">    echo "Unable to find Java"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$javaexe" ]]; then</span><br><span class="line">    version=$("$javaexe" -version 2&gt;&amp;1 | awk -F '"' '/version/ &#123;print $2&#125;')</span><br><span class="line">    version=$(echo "$version" | awk -F. '&#123;printf("%03d%03d",$1,$2);&#125;')</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf "$(date) ==== Starting ==== \n"</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME".jar"</span><br><span class="line">./$SERVICE_NAME".jar" start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>

<p>在官网的基础上修改了这两个参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_ADMIN_SERVICE_NAME=$(hostname -i)</span><br></pre></td></tr></table></figure>

<ul>
<li>编写dockerfile</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cd /data/dockerfile/apollo-adminservice/</span><br><span class="line">[root@shkf6-245 apollo-adminservice]# vi Dockerfile</span><br><span class="line"></span><br><span class="line">FROM sunrisenan/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.5.1</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo "Asia/Shanghai" &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-adminservice-$&#123;VERSION&#125;.jar /apollo-adminservice/apollo-adminservice.jar</span><br><span class="line">ADD config/ /apollo-adminservice/config</span><br><span class="line">ADD scripts/ /apollo-adminservice/scripts</span><br><span class="line"></span><br><span class="line">CMD ["/apollo-adminservice/scripts/startup.sh"]</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像并推送</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-adminservice]# docker build . -t harbor.od.com/infra/apollo-adminservice:v1.5.1</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 apollo-adminservice]# docker push harbor.od.com/infra/apollo-adminservice:v1.5.1</span><br></pre></td></tr></table></figure>

<h2 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h2><p>在运维主机shkf6-245.host.com</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-adminservice]# mkdir /data/k8s-yaml/apollo-adminservice &amp;&amp; cd /data/k8s-yaml/apollo-adminservice</span><br></pre></td></tr></table></figure>

<ul>
<li>ConfigMap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-adminservice]# vi cm.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config.od.com/eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003172</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-adminservice]# vi dp.yaml</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-adminservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-adminservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-adminservice </span><br><span class="line">        name: apollo-adminservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-adminservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-adminservice</span><br><span class="line">        image: harbor.od.com/infra/apollo-adminservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-adminservice/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">    appId=100003172</span><br></pre></td></tr></table></figure>

<h2 id="应用配置清单"><a href="#应用配置清单" class="headerlink" title="应用配置清单"></a>应用配置清单</h2><p>在任何一台运算节点上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/cm.yaml</span><br><span class="line">configmap/apollo-adminservice-cm created</span><br><span class="line"></span><br><span class="line">[root@shkf6-244 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/dp.yaml</span><br><span class="line">deployment.extensions/apollo-adminservice created</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://config.od.com/" target="_blank" rel="noopener">http://config.od.com</a></p>
<img src = "/images/m_9be9bc201d9670735918a3edc724097d_r.png">

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-244 ~]# curl http://172.6.244.4:8080/info</span><br><span class="line">&#123;"git":&#123;"commit":&#123;"time":&#123;"seconds":1573275854,"nanos":0&#125;,"id":"c9eae54"&#125;,"branch":"1.5.1"&#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实战交付apollo配置中心组件–portal到kubernetes集群"><a href="#实战交付apollo配置中心组件–portal到kubernetes集群" class="headerlink" title="实战交付apollo配置中心组件–portal到kubernetes集群"></a>实战交付apollo配置中心组件–portal到kubernetes集群</h1><h2 id="准备软件包-2"><a href="#准备软件包-2" class="headerlink" title="准备软件包"></a>准备软件包</h2><p>在运维主机HDSS6-245.host.com上：</p>
<p><a href="https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-portal-1.5.1-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# wget -O /opt/src/apollo-portal-1.5.1-github.zip https://github.com/ctripcorp/apollo/releases/download/v1.5.1/apollo-portal-1.5.1-github.zip</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 ~]# mkdir /data/dockerfile/apollo-portal &amp;&amp; unzip -o /opt/src/apollo-portal-1.5.1-github.zip -d /data/dockerfile/apollo-portal</span><br></pre></td></tr></table></figure>

<ul>
<li>清理不用的文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cd /data/dockerfile/apollo-portal/</span><br><span class="line">[root@shkf6-245 apollo-portal]# rm -f apollo-portal-1.5.1-sources.jar </span><br><span class="line">[root@shkf6-245 apollo-portal]# rm -f apollo-portal.conf </span><br><span class="line">[root@shkf6-245 apollo-portal]# rm -f scripts/shutdown.sh</span><br></pre></td></tr></table></figure>

<h2 id="执行数据库脚本-1"><a href="#执行数据库脚本-1" class="headerlink" title="执行数据库脚本"></a>执行数据库脚本</h2><p>在数据库主机shkf6-241.host.com上：</p>
<p><a href="https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/db/migration/portaldb/V1.0.0__initialization.sql" target="_blank" rel="noopener">数据库脚本地址</a></p>
<p>[root<a href="https://github.com/shkf6" target="_blank" rel="noopener">@shkf6</a>-241 ~]# wget -O apolloportal.sql <a href="https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/db/migration/portaldb/V1.0.0__initialization.sql" target="_blank" rel="noopener">https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/db/migration/portaldb/V1.0.0__initialization.sql</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# mysql -uroot -p</span><br><span class="line">MariaDB [ApolloConfigDB]&gt; source ./apolloportal.sql</span><br></pre></td></tr></table></figure>

<h2 id="数据库用户授权-1"><a href="#数据库用户授权-1" class="headerlink" title="数据库用户授权"></a>数据库用户授权</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [ApolloPortalDB]&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloPortalDB.* to "apolloportal"@"192.168.6.%" identified by "123456";</span><br><span class="line">MariaDB [ApolloPortalDB]&gt; update ServerConfig set Value='[&#123;"orgId":"od01","orgName":"Linux学院"&#125;,&#123;"orgId":"od02","orgName":"云计算学院"&#125;,&#123;"orgId":"od03","orgName":"Python学院"&#125;]' where Id=2;</span><br></pre></td></tr></table></figure>

<h2 id="制作Docker镜像-1"><a href="#制作Docker镜像-1" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h2><p>在运维主机shkf6-245.host.com上：</p>
<ul>
<li>配置数据库连接串（用cm的话这里可以不用修改）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat config/application-github.properties</span><br><span class="line"><span class="meta">#</span><span class="bash"> DataSource</span></span><br><span class="line">spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = apolloportal</span><br><span class="line">spring.datasource.password = 123456</span><br></pre></td></tr></table></figure>

<ul>
<li>配置Portal的meta service（用cm的话这里可以不用修改）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat config/apollo-env.properties</span><br><span class="line">dev.meta=http://config.od.com</span><br></pre></td></tr></table></figure>

<ul>
<li>更新startup.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat scripts/startup.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">SERVICE_NAME=apollo-portal</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust log dir if necessary</span></span></span><br><span class="line">LOG_DIR=/opt/logs/apollo-portal-server</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust server port if necessary</span></span></span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_PORTAL_SERVICE_NAME=$(hostname -i)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> SERVER_URL=<span class="string">"http://localhost:<span class="variable">$SERVER_PORT</span>"</span></span></span><br><span class="line">SERVER_URL="http://$&#123;APOLLO_PORTAL_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Adjust memory settings if necessary</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Only uncomment the following when you are using server jvm</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">export</span> JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -server -XX:-ReduceInitialCardMarks"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########## The following is the same for configservice, adminservice, portal ###########</span></span></span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"</span><br><span class="line">export JAVA_OPTS="$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Find Java</span></span><br><span class="line">if [[ -n "$JAVA_HOME" ]] &amp;&amp; [[ -x "$JAVA_HOME/bin/java" ]]; then</span><br><span class="line">    javaexe="$JAVA_HOME/bin/java"</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x "/usr/bin/java" ]];  then</span><br><span class="line">    javaexe="/usr/bin/java"</span><br><span class="line">else</span><br><span class="line">    echo "Unable to find Java"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ "$javaexe" ]]; then</span><br><span class="line">    version=$("$javaexe" -version 2&gt;&amp;1 | awk -F '"' '/version/ &#123;print $2&#125;')</span><br><span class="line">    version=$(echo "$version" | awk -F. '&#123;printf("%03d%03d",$1,$2);&#125;')</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace"</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseParNewGC"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails"</span><br><span class="line">        JAVA_OPTS="$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M"</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf "$(date) ==== Starting ==== \n"</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME".jar"</span><br><span class="line">./$SERVICE_NAME".jar" start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo "$(date) Failed to start $SERVICE_NAME.jar, return code: $rc"</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>

<ul>
<li>写Dockerfile</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat Dockerfile</span><br><span class="line">FROM sunrisenan/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.5.1</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo "Asia/Shanghai" &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-portal-$&#123;VERSION&#125;.jar /apollo-portal/apollo-portal.jar</span><br><span class="line">ADD config/ /apollo-portal/config</span><br><span class="line">ADD scripts/ /apollo-portal/scripts</span><br><span class="line"></span><br><span class="line">CMD ["/apollo-portal/scripts/startup.sh"]</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像并推送</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# docker build . -t harbor.od.com/infra/apollo-portal:v1.5.1</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 apollo-portal]# docker push harbor.od.com/infra/apollo-portal:v1.5.1</span><br></pre></td></tr></table></figure>

<h2 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h2><p>DNS主机shkf6-241.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -1 /var/named/od.com.zone</span><br><span class="line">portal             A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><p>在运维主机shkf6-245.host.com上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# mkdir /data/k8s-yaml/apollo-portal &amp;&amp; cd /data/k8s-yaml/apollo-portal</span><br></pre></td></tr></table></figure>

<ul>
<li>ConfigMap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat cm.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-portal-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloportal</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003173</span><br><span class="line">  apollo-env.properties: |</span><br><span class="line">    dev.meta=http://config.od.com</span><br></pre></td></tr></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat dp.yaml </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-portal</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-portal</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-portal </span><br><span class="line">        name: apollo-portal</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-portal-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-portal</span><br><span class="line">        image: harbor.od.com/infra/apollo-portal:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-portal/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<ul>
<li>service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat svc.yaml </span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: apollo-portal</span><br></pre></td></tr></table></figure>

<ul>
<li>ingress</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 apollo-portal]# cat ingress.yaml </span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: portal.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: apollo-portal</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>

<h2 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/cm.yaml</span><br><span class="line">configmap/apollo-portal-cm created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/dp.yaml</span><br><span class="line">deployment.extensions/apollo-portal created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/svc.yaml</span><br><span class="line">service/apollo-portal created</span><br><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/ingress.yaml</span><br><span class="line">ingress.extensions/apollo-portal created</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://portal.od.com/" target="_blank" rel="noopener">http://portal.od.com</a></p>
<ul>
<li>用户名：apollo</li>
<li>密码： admin</li>
</ul>
<img src = "/images/m_c1a3e387ab6bae3d89d8ad61b5cd03c7_r.png">

<h1 id="实战配置dubbo微服务接入apollo配置中心管理"><a href="#实战配置dubbo微服务接入apollo配置中心管理" class="headerlink" title="实战配置dubbo微服务接入apollo配置中心管理"></a>实战配置dubbo微服务接入apollo配置中心管理</h1><h2 id="改造dubbo-demo-service项目"><a href="#改造dubbo-demo-service项目" class="headerlink" title="改造dubbo-demo-service项目"></a>改造dubbo-demo-service项目</h2><h3 id="使用IDE拉取项目（这里使用git-bash作为范例）"><a href="#使用IDE拉取项目（这里使用git-bash作为范例）" class="headerlink" title="使用IDE拉取项目（这里使用git bash作为范例）"></a>使用IDE拉取项目（这里使用git bash作为范例）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# git clone https://github.com/sunrisenan/dubbo-demo-service.git</span><br></pre></td></tr></table></figure>

<h3 id="切到apollo分支"><a href="#切到apollo分支" class="headerlink" title="切到apollo分支"></a>切到apollo分支</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# cd dubbo-demo-service/</span><br><span class="line"><span class="meta">dubbo-demo-service]#</span><span class="bash"> git checkout -b apollo</span></span><br></pre></td></tr></table></figure>

<h3 id="修改pom-xml"><a href="#修改pom-xml" class="headerlink" title="修改pom.xml"></a>修改pom.xml</h3><ul>
<li>加入apollo客户端jar包的依赖</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dubbo-server/pom.xml</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.ctrip.framework.apollo&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;apollo-client&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.1.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改resource段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dubbo-server/pom.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;resource&gt;</span><br><span class="line">  &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">  &lt;includes&gt;</span><br><span class="line">  &lt;include&gt;**<span class="comment">/*&lt;/include&gt;</span></span><br><span class="line"><span class="comment">  &lt;/includes&gt;</span></span><br><span class="line"><span class="comment">  &lt;filtering&gt;false&lt;/filtering&gt;</span></span><br><span class="line"><span class="comment">&lt;/resource&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="增加resources目录"><a href="#增加resources目录" class="headerlink" title="增加resources目录"></a>增加resources目录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ mkdir -pv resources/META-INF</span><br><span class="line">mkdir: created directory <span class="string">'resources'</span></span><br><span class="line">mkdir: created directory <span class="string">'resources/META-INF'</span></span><br></pre></td></tr></table></figure>

<h3 id="修改config-properties文件"><a href="#修改config-properties文件" class="headerlink" title="修改config.properties文件"></a>修改config.properties文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/config.properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dubbo.registry=$&#123;dubbo.registry&#125;</span><br><span class="line">dubbo.port=$&#123;dubbo.port&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改srping-config-xml文件"><a href="#修改srping-config-xml文件" class="headerlink" title="修改srping-config.xml文件"></a>修改srping-config.xml文件</h3><ul>
<li>beans段新增属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span><br><span class="line"></span><br><span class="line">xmlns:apollo=<span class="string">"http://www.ctrip.com/schema/apollo"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>xsi:schemaLocation段内新增属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span><br><span class="line"></span><br><span class="line">http:<span class="comment">//www.ctrip.com/schema/apollo http://www.ctrip.com/schema/apollo.xsd</span></span><br></pre></td></tr></table></figure>

<ul>
<li>新增配置项</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span><br><span class="line"></span><br><span class="line">&lt;apollo:config/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除配置项（注释）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span><br><span class="line"></span><br><span class="line">&lt;!-- &lt;context:property-placeholder location=<span class="string">"classpath:config.properties"</span>/&gt; --&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>增加app.properties文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/META-INF/app.properties</span><br><span class="line"></span><br><span class="line">app.id=dubbo-demo-service</span><br></pre></td></tr></table></figure>

<ul>
<li>提交git中心仓库（github）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin apollo</span><br></pre></td></tr></table></figure>

<h2 id="配置apollo-portal"><a href="#配置apollo-portal" class="headerlink" title="配置apollo-portal"></a>配置apollo-portal</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li>部门</li>
</ul>
<blockquote>
<p>样例部门1（老男孩linux学院001）</p>
</blockquote>
<ul>
<li>应用id</li>
</ul>
<blockquote>
<p>dubbo-demo-service</p>
</blockquote>
<ul>
<li>应用名称</li>
</ul>
<blockquote>
<p>dubbo服务提供者</p>
</blockquote>
<ul>
<li>应用负责人</li>
</ul>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
<ul>
<li>项目管理员</li>
</ul>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
<p>提交</p>
<h3 id="进入配置界面"><a href="#进入配置界面" class="headerlink" title="进入配置界面"></a>进入配置界面</h3><p><strong>新增配置项1</strong></p>
<ul>
<li>Key</li>
</ul>
<blockquote>
<p>dubbo.registry</p>
</blockquote>
<ul>
<li>Value</li>
</ul>
<blockquote>
<p>zookeeper://zk1.od.com:2181</p>
</blockquote>
<ul>
<li>选择集群</li>
</ul>
<blockquote>
<p>DEV</p>
</blockquote>
<p>提交</p>
<p><strong>新增配置项2</strong></p>
<ul>
<li>Key</li>
</ul>
<blockquote>
<p>dubbo.port</p>
</blockquote>
<ul>
<li>Value</li>
</ul>
<blockquote>
<p>20880</p>
</blockquote>
<ul>
<li>选择集群</li>
</ul>
<blockquote>
<p>DEV</p>
</blockquote>
<p>提交</p>
<h3 id="发布配置"><a href="#发布配置" class="headerlink" title="发布配置"></a>发布配置</h3><p>点击发布，配置生效</p>
<img src = "/images/m_289aeb7203f30ba86b82096de0a81b39_r.png">

<h2 id="使用jenkins进行CI"><a href="#使用jenkins进行CI" class="headerlink" title="使用jenkins进行CI"></a>使用jenkins进行CI</h2><p>略（注意记录镜像的tag）</p>
<h2 id="上线新构建的项目"><a href="#上线新构建的项目" class="headerlink" title="上线新构建的项目"></a>上线新构建的项目</h2><h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机shkf6-245.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/dubbo-demo-service-apollo/deployment.yaml</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-service:apollo_191211_1326</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=dev -Dapollo.meta=http://config.od.com</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<p>注意：增加了env段配置<br>注意：docker镜像新版的tag</p>
<h3 id="应用资源配置清单-3"><a href="#应用资源配置清单-3" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service-apollo/deployment.yaml</span><br></pre></td></tr></table></figure>

<h3 id="观察项目运行情况"><a href="#观察项目运行情况" class="headerlink" title="观察项目运行情况"></a>观察项目运行情况</h3><p><a href="http://dubbo-monitor.od.com/" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a></p>
<h2 id="改造dubbo-demo-web"><a href="#改造dubbo-demo-web" class="headerlink" title="改造dubbo-demo-web"></a>改造dubbo-demo-web</h2><p>略</p>
<h2 id="配置apollo-portal-1"><a href="#配置apollo-portal-1" class="headerlink" title="配置apollo-portal"></a>配置apollo-portal</h2><h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li>部门</li>
</ul>
<blockquote>
<p>样例部门1（linux学院od01）</p>
</blockquote>
<ul>
<li>应用id</li>
</ul>
<blockquote>
<p>dubbo-demo-web</p>
</blockquote>
<ul>
<li>应用名称</li>
</ul>
<blockquote>
<p>dubbo服务消费者</p>
</blockquote>
<ul>
<li>应用负责人</li>
</ul>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
<ul>
<li>项目管理员</li>
</ul>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
<p>提交</p>
<h3 id="进入配置页面"><a href="#进入配置页面" class="headerlink" title="进入配置页面"></a>进入配置页面</h3><p><strong>新增配置项1</strong></p>
<ul>
<li>Key</li>
</ul>
<blockquote>
<p>dubbo.registry</p>
</blockquote>
<ul>
<li>Value</li>
</ul>
<blockquote>
<p>zookeeper://zk1.od.com:2181</p>
</blockquote>
<ul>
<li>选择集群</li>
</ul>
<blockquote>
<p>DEV</p>
</blockquote>
<p>提交</p>
<h3 id="发布配置-1"><a href="#发布配置-1" class="headerlink" title="发布配置"></a>发布配置</h3><p>点击发布，配置生效</p>
<h2 id="使用jenkins进行CI-1"><a href="#使用jenkins进行CI-1" class="headerlink" title="使用jenkins进行CI"></a>使用jenkins进行CI</h2><p>略（注意记录镜像的tag）</p>
<h2 id="上线新构建的项目-1"><a href="#上线新构建的项目-1" class="headerlink" title="上线新构建的项目"></a>上线新构建的项目</h2><h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机shkf6-245.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 ~]# cat /data/k8s-yaml/dubbo-demo-consumer-apollo/dp.yaml </span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-consumer:apollo_191211_1417</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=dev -Dapollo.meta=http://config.od.com</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<p>注意：增加了env段配置<br>注意：docker镜像新版的tag</p>
<h3 id="应用资源配置清单-4"><a href="#应用资源配置清单-4" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer-apollo/dp.yaml</span><br></pre></td></tr></table></figure>

<h2 id="通过Apollo配置中心动态维护项目的配置"><a href="#通过Apollo配置中心动态维护项目的配置" class="headerlink" title="通过Apollo配置中心动态维护项目的配置"></a>通过Apollo配置中心动态维护项目的配置</h2><p>以dubbo-demo-service项目为例，不用修改代码</p>
<ul>
<li>在<a href="http://portal.od.com/" target="_blank" rel="noopener">http://portal.od.com</a> 里修改dubbo.port配置项</li>
<li>重启dubbo-demo-service项目</li>
<li>配置生效</li>
</ul>
<h1 id="实战使用apollo配置中心管理测试环境和生产环境"><a href="#实战使用apollo配置中心管理测试环境和生产环境" class="headerlink" title="实战使用apollo配置中心管理测试环境和生产环境"></a>实战使用apollo配置中心管理测试环境和生产环境</h1><h2 id="实战维护多套dubbo微服务环境"><a href="#实战维护多套dubbo微服务环境" class="headerlink" title="实战维护多套dubbo微服务环境"></a>实战维护多套dubbo微服务环境</h2><h3 id="生产实践"><a href="#生产实践" class="headerlink" title="生产实践"></a>生产实践</h3><ol>
<li>迭代新需求/修复BUG（编码-&gt;提GIT）</li>
<li>测试环境发版，测试（应用通过编译打包发布至TEST命名空间）</li>
<li>测试通过，上线（应用镜像直接发布至PROD命名空间）</li>
</ol>
<h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><ul>
<li>物理架构</li>
</ul>
<table>
<thead>
<tr>
<th align="left">主机名</th>
<th align="left">角色</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">shkf6-241.host.com</td>
<td align="left">zk-test(测试环境Test)</td>
<td align="left">192.168.6.241</td>
</tr>
<tr>
<td align="left">shkf6-242.host.com</td>
<td align="left">zk-prod(生产环境Prod)</td>
<td align="left">192.168.6.242</td>
</tr>
<tr>
<td align="left">shkf6-243.host.com</td>
<td align="left">kubernetes运算节点</td>
<td align="left">192.168.6.243</td>
</tr>
<tr>
<td align="left">shkf6-244.host.com</td>
<td align="left">kubernetes运算节点</td>
<td align="left">192.168.6.244</td>
</tr>
<tr>
<td align="left">shkf6-245.host.com</td>
<td align="left">运维主机，harbor仓库</td>
<td align="left">192.168.6.245</td>
</tr>
</tbody></table>
<ul>
<li>K8S内系统架构</li>
</ul>
<table>
<thead>
<tr>
<th align="left">环境</th>
<th align="left">命名空间</th>
<th align="left">应用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">测试环境（TEST）</td>
<td align="left">test</td>
<td align="left">apollo-config，apollo-admin</td>
</tr>
<tr>
<td align="left">测试环境（TEST）</td>
<td align="left">test</td>
<td align="left">dubbo-demo-service，dubbo-demo-web</td>
</tr>
<tr>
<td align="left">生产环境（PROD）</td>
<td align="left">prod</td>
<td align="left">apollo-config，apollo-admin</td>
</tr>
<tr>
<td align="left">生产环境（PROD）</td>
<td align="left">prod</td>
<td align="left">dubbo-demo-service，dubbo-demo-web</td>
</tr>
<tr>
<td align="left">ops环境（infra）</td>
<td align="left">infra</td>
<td align="left">jenkins，dubbo-monitor，apollo-portal</td>
</tr>
</tbody></table>
<h3 id="修改-添加域名解析"><a href="#修改-添加域名解析" class="headerlink" title="修改/添加域名解析"></a>修改/添加域名解析</h3><p>DNS主机HDSS6-241.host.com上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail /var/named/od.com.zone</span><br><span class="line">zk-test            A    192.168.6.241</span><br><span class="line">zk-prod            A    192.168.6.242</span><br><span class="line">config-test        A    192.168.6.66</span><br><span class="line">config-prod        A    192.168.6.66</span><br><span class="line">demo-test          A    192.168.6.66</span><br><span class="line">demo-prod          A    192.168.6.66</span><br></pre></td></tr></table></figure>

<h3 id="Apollo的k8s应用配置"><a href="#Apollo的k8s应用配置" class="headerlink" title="Apollo的k8s应用配置"></a>Apollo的k8s应用配置</h3><ul>
<li>删除app命名空间内应用，创建test命名空间，创建prod命名空间</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create ns test</span><br><span class="line">[root@shkf6-243 ~]# kubectl create ns prod</span><br></pre></td></tr></table></figure>

<ul>
<li>配置连接docker仓库的认证</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n test</span><br><span class="line">[root@shkf6-243 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n prod</span><br></pre></td></tr></table></figure>

<ul>
<li>删除infra命名空间内apollo-configservice，apollo-adminservice应用</li>
<li>数据库内删除ApolloConfigDB，创建ApolloConfigTestDB，创建ApolloConfigProdDB</li>
</ul>
<p><a href="http://down.sunrisenan.com/apollo/" target="_blank" rel="noopener">sql代码下载地址</a></p>
<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 apollo]# mysql -uroot -p123456 &lt; test/apolloconfig.sql </span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloConfigTestDB.ServerConfig <span class="built_in">set</span> ServerConfig.Value=<span class="string">"http://config-test.od.com/eureka"</span> <span class="built_in">where</span> ServerConfig.Key=<span class="string">"eureka.service.url"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to <span class="string">"apolloconfig"</span>@<span class="string">"192.168.6.%"</span> identified by <span class="string">"123456"</span>;</span></span><br></pre></td></tr></table></figure>

<p>生产：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 apollo]# mysql -uroot -p123456 &lt; prod/apolloconfig.sql </span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloConfigProdDB.ServerConfig <span class="built_in">set</span> ServerConfig.Value=<span class="string">"http://config-prod.od.com/eureka"</span> <span class="built_in">where</span> ServerConfig.Key=<span class="string">"eureka.service.url"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to <span class="string">"apolloconfig"</span>@<span class="string">"192.168.6.%"</span> identified by <span class="string">"123456"</span>;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>准备apollo-config，apollo-admin的资源配置清单（各2套）</li>
</ul>
<p>注：apollo-config/apollo-admin的configmap配置要点</p>
<p>更改portal数据库-分环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloPortalDB.ServerConfig <span class="built_in">set</span> Value=<span class="string">'fat,pro'</span> <span class="built_in">where</span> Id=1;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Test环境</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigTestDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config-test.od.com/eureka</span><br></pre></td></tr></table></figure>

<ul>
<li>Prod环境</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigProdDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config-prod.od.com/eureka</span><br></pre></td></tr></table></figure>

<ul>
<li>依次应用，分别发布在test和prod命名空间</li>
<li>修改apollo-portal的configmap并重启portal</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apollo-env.properties: |</span><br><span class="line">    TEST.meta=http://config-test.od.com</span><br><span class="line">    PROD.meta=http://config-prod.od.com</span><br></pre></td></tr></table></figure>

<h3 id="Apollo的portal配置"><a href="#Apollo的portal配置" class="headerlink" title="Apollo的portal配置"></a>Apollo的portal配置</h3><h4 id="管理员工具"><a href="#管理员工具" class="headerlink" title="管理员工具"></a>管理员工具</h4><p>删除应用、集群、AppNamespace，将已配置应用删除</p>
<h4 id="系统参数"><a href="#系统参数" class="headerlink" title="系统参数"></a>系统参数</h4><ul>
<li>Key</li>
</ul>
<blockquote>
<p>apollo.portal.envs</p>
</blockquote>
<ul>
<li>Value</li>
</ul>
<blockquote>
<p>fat,pro</p>
</blockquote>
<p>查询</p>
<ul>
<li>Value</li>
</ul>
<blockquote>
<p>fat,pro</p>
</blockquote>
<p>保存</p>
<h3 id="新建dubbo-demo-service和dubbo-demo-web项目"><a href="#新建dubbo-demo-service和dubbo-demo-web项目" class="headerlink" title="新建dubbo-demo-service和dubbo-demo-web项目"></a>新建dubbo-demo-service和dubbo-demo-web项目</h3><p>在TEST/PROD环境分别增加配置项并发布</p>
<h3 id="发布dubbo微服务"><a href="#发布dubbo微服务" class="headerlink" title="发布dubbo微服务"></a>发布dubbo微服务</h3><ul>
<li>准备dubbo-demo-service和dubbo-demo-web的资源配置清单（各2套）</li>
<li>依次应用，分别发布至test和prod命名空间</li>
<li>使用dubbo-monitor查验</li>
</ul>
<h2 id="分环境"><a href="#分环境" class="headerlink" title="分环境"></a>分环境</h2><p><a href="http://down.sunrisenan.com/apollo/apollo-fat-pro.tar.gz" target="_blank" rel="noopener">配置资料</a></p>
<h3 id="第一阶段-解析域名"><a href="#第一阶段-解析域名" class="headerlink" title="第一阶段 解析域名"></a>第一阶段 解析域名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 ~]# tail -7 /var/named/od.com.zone</span><br><span class="line">zk-test            A    192.168.6.241</span><br><span class="line">zk-prod            A    192.168.6.242</span><br><span class="line">mysql              A    192.168.6.241</span><br><span class="line">config-test        A    192.168.6.66</span><br><span class="line">config-prod        A    192.168.6.66</span><br><span class="line">demo-test          A    192.168.6.66</span><br><span class="line">demo-prod          A    192.168.6.66</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@shkf6-241 ~]# dig -t A zk-test.od.com +short</span><br><span class="line">192.168.6.241</span><br></pre></td></tr></table></figure>

<h3 id="第二阶段-Portal设置"><a href="#第二阶段-Portal设置" class="headerlink" title="第二阶段 Portal设置"></a>第二阶段 Portal设置</h3><p>1、查看并清除配置中心的历史记录</p>
<p>如果是新环境的话可以忽略这一步，直接操作第二步：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; use ApolloPortalDB</span><br><span class="line"></span><br><span class="line">MariaDB [ApolloPortalDB]&gt; select * from App;</span><br><span class="line"></span><br><span class="line">MariaDB [ApolloPortalDB]&gt; select * from AppNamespace;</span><br><span class="line"></span><br><span class="line">MariaDB [ApolloPortalDB]&gt; truncate table ApolloPortalDB.App;</span><br><span class="line">Query OK, 0 rows affected (0.28 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [ApolloPortalDB]&gt; truncate table ApolloPortalDB.AppNamespace;</span><br><span class="line">Query OK, 0 rows affected (0.18 sec)</span><br></pre></td></tr></table></figure>

<p>2、ApolloPortalDB分环境fat和pro：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloPortalDB.ServerConfig <span class="built_in">set</span> Value=<span class="string">'fat,pro'</span> <span class="built_in">where</span> Id=1;</span></span><br></pre></td></tr></table></figure>

<p>3、portal资源配置清单</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 k8s-yaml]# tree apollo-portal-fat-pro/</span><br><span class="line">apollo-portal-fat-pro/</span><br><span class="line">├── cm.yaml</span><br><span class="line">├── dp.yaml</span><br><span class="line">├── ingress.yaml</span><br><span class="line">└── svc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="第三阶段-测试环境"><a href="#第三阶段-测试环境" class="headerlink" title="第三阶段 测试环境"></a>第三阶段 测试环境</h3><p>1、创建名称空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create ns test</span><br><span class="line">namespace/test created</span><br><span class="line">[root@shkf6-243 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n test</span><br></pre></td></tr></table></figure>

<p>2、数据库设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 apollo]# mysql -uroot -p123456 &lt; test/apolloconfig.sql </span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloConfigTestDB.ServerConfig <span class="built_in">set</span> ServerConfig.Value=<span class="string">"http://config-test.od.com/eureka"</span> <span class="built_in">where</span> ServerConfig.Key=<span class="string">"eureka.service.url"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to <span class="string">"apolloconfig"</span>@<span class="string">"192.168.6.%"</span> identified by <span class="string">"123456"</span>;</span></span><br></pre></td></tr></table></figure>

<p>3、资源配置清单准备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 k8s-yaml]# mkdir -pv test/&#123;apollo-configservice,apollo-adminservice,dubbo-demo-consumer,dubbo-demo-service&#125;</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 k8s-yaml]# tree test/</span><br><span class="line">test/</span><br><span class="line">├── apollo-adminservice</span><br><span class="line">│   ├── cm.yaml</span><br><span class="line">│   └── dp.yaml</span><br><span class="line">├── apollo-configservice</span><br><span class="line">│   ├── cm.yaml</span><br><span class="line">│   ├── dp.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   └── svc.yaml</span><br><span class="line">├── dubbo-demo-consumer</span><br><span class="line">│   ├── dp.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   └── svc.yaml</span><br><span class="line">└── dubbo-demo-service</span><br><span class="line">    └── deployment.yaml</span><br></pre></td></tr></table></figure>

<h3 id="第四阶段-生产环境"><a href="#第四阶段-生产环境" class="headerlink" title="第四阶段 生产环境"></a>第四阶段 生产环境</h3><p>1、创建名称空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-243 ~]# kubectl create ns prod</span><br><span class="line">namespace/prod created</span><br><span class="line">[root@shkf6-243 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 -n prod</span><br></pre></td></tr></table></figure>

<p>2、数据库设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-241 apollo]# mysql -uroot -p123456 &lt; prod/apolloconfig.sql </span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update ApolloConfigProdDB.ServerConfig <span class="built_in">set</span> ServerConfig.Value=<span class="string">"http://config-prod.od.com/eureka"</span> <span class="built_in">where</span> ServerConfig.Key=<span class="string">"eureka.service.url"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to <span class="string">"apolloconfig"</span>@<span class="string">"192.168.6.%"</span> identified by <span class="string">"123456"</span>;</span></span><br></pre></td></tr></table></figure>

<p>3、资源配置清单准备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@shkf6-245 k8s-yaml]# mkdir -pv prod/&#123;apollo-configservice,apollo-adminservice,dubbo-demo-consumer,dubbo-demo-service&#125;</span><br><span class="line"></span><br><span class="line">[root@shkf6-245 k8s-yaml]# tree prod/</span><br><span class="line">prod/</span><br><span class="line">├── apollo-adminservice</span><br><span class="line">│   ├── cm.yaml</span><br><span class="line">│   └── dp.yaml</span><br><span class="line">├── apollo-configservice</span><br><span class="line">│   ├── cm.yaml</span><br><span class="line">│   ├── dp.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   └── svc.yaml</span><br><span class="line">├── dubbo-demo-consumer</span><br><span class="line">│   ├── dp.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   └── svc.yaml</span><br><span class="line">└── dubbo-demo-service</span><br><span class="line">    └── deployment.yaml</span><br></pre></td></tr></table></figure>

<h3 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">- name: JAR_BALL</span><br><span class="line">  value: dubbo-server.jar</span><br><span class="line">- name: C_OPTS</span><br><span class="line">  value: -Denv=pro -Dapollo.meta=http://config-test.od.com        #这里用的是apollo-configservice的ingress地址</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">env:</span><br><span class="line">- name: JAR_BALL</span><br><span class="line">  value: dubbo-server.jar</span><br><span class="line">- name: C_OPTS</span><br><span class="line">  value: -Denv=pro -Dapollo.meta=http://apollo-configservice:8080     #这里用的是apollo-configservice的svc地址</span><br><span class="line"></span><br><span class="line">[root@shkf6-243 ~]# kubectl get svc -n prod </span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">apollo-configservice   ClusterIP   10.96.2.8     &lt;none&gt;        8080/TCP   4d14h</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">PhenoGao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://xonlab.com/2020/04/04/Kubernetes-Apollo%E9%83%A8%E7%BD%B2/">http://xonlab.com/2020/04/04/Kubernetes-Apollo%E9%83%A8%E7%BD%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://xonlab.com" target="_blank">XonLab</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-nika-akin-3598435.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/04/06/Node-js%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><img class="prev-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-j8ojdy.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Node.js快速入门</div></div></a></div><div class="next-post pull-right"><a href="/2020/04/03/Kubernetes-dubbo%E9%83%A8%E7%BD%B2/"><img class="next-cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/00eeb4195b90fc04135e82dcf8f6c716.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes-dubbo部署</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/03/26/Docker基础知识汇编/" title="Docker基础知识汇编"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/wallhaven-4l5wpy.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-26</div><div class="relatedPosts_title">Docker基础知识汇编</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/Kubernetes-ELK部署/" title="Kubernetes-ELK部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/40-backgrounds-material.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-15</div><div class="relatedPosts_title">Kubernetes-ELK部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Kubernetes-Prometheus部署/" title="Kubernetes-Prometheus部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/BlogPic/md-25.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-09</div><div class="relatedPosts_title">Kubernetes-Prometheus部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/03/Kubernetes-dubbo部署/" title="Kubernetes-dubbo部署"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/00eeb4195b90fc04135e82dcf8f6c716.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-03</div><div class="relatedPosts_title">Kubernetes-dubbo部署</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/28/Kubernetes部署Ⅰ/" title="Kubernetes部署 Ⅰ"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/de2a1ad249f7248d123b0a46d5faad9f.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-28</div><div class="relatedPosts_title">Kubernetes部署 Ⅰ</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/01/Kubernetes部署-Ⅱ/" title="Kubernetes部署 Ⅱ"><img class="relatedPosts_cover" data-src="https://edu-102.oss-cn-beijing.aliyuncs.com/%E5%8D%9A%E5%AE%A2%E5%B0%81%E9%9D%A2/pexels-steve-johnson-3216996.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-01</div><div class="relatedPosts_title">Kubernetes部署 Ⅱ</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By PhenoGao</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>